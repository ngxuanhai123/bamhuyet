<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiHi Med - NÃ¢ng Cáº¥p Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #00695c;
            --primary-dark: #004d40;
            --primary-light: #b2dfdb;
            --accent: #ffb300; 
            --bg: #f3f4f6;
            --surface: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Components --- */
        .btn {
            padding: 10px 18px; border: none; border-radius: 12px; cursor: pointer;
            font-weight: 600; font-size: 0.95rem; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0, 105, 92, 0.3); }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-accent { background: var(--accent); color: #fff; box-shadow: 0 4px 12px rgba(255, 179, 0, 0.3); }
        .btn-danger { background: var(--error); color: #fff; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
        
        .btn-search { 
            background: #eff6ff; color: #2563eb; border: 1px dashed #bfdbfe; 
            width: 100%; margin-bottom: 15px; font-size: 0.9rem;
        }
        .btn-search:hover { background: #dbeafe; }
        .btn-google { background: white; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; }
        .btn-xs { padding: 6px 12px; font-size: 0.8rem; border-radius: 8px; }
        .btn-icon { padding: 8px; border-radius: 50%; background: transparent; color: var(--text-light); cursor: pointer; border: none;}
        .btn-icon:hover { background: #f3f4f6; color: var(--primary); }

        .card {
            background: var(--surface); border-radius: var(--radius); padding: 20px;
            margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.8);
            position: relative; overflow: hidden;
        }
        
        input, select, textarea {
            width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px;
            font-size: 1rem; margin-bottom: 12px; font-family: inherit; transition: border-color 0.2s;
        }
        input:focus, textarea:focus { border-color: var(--primary); background: #fff; ring: 2px solid var(--primary-light); }

        /* --- Layout --- */
        #login-screen, #disclaimer-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        #login-screen { background: rgba(0, 105, 92, 0.98); }
        #disclaimer-modal { background: rgba(0, 0, 0, 0.85); z-index: 2100; display: flex; } /* Start visible */

        .login-box, .disclaimer-box {
            background: white; padding: 30px; border-radius: 24px;
            text-align: center; width: 90%; max-width: 380px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.4s ease;
        }

        .disclaimer-box { border-top: 5px solid var(--error); }
        .disclaimer-box h2 { color: var(--error); margin-top: 0; }
        .disclaimer-box p { text-align: left; color: #4b5563; font-size: 0.95rem; line-height: 1.5; margin-bottom: 20px; }
        .disclaimer-box ul { text-align: left; padding-left: 20px; color: #4b5563; font-size: 0.9rem; margin-bottom: 20px; }
        .disclaimer-box li { margin-bottom: 8px; }

        #app-screen { display: flex; flex: 1; flex-direction: column; }

        header {
            background: var(--surface); padding: 12px 16px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 50; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .brand { 
            font-weight: 800; color: var(--primary); font-size: 1.3rem; 
            display: flex; align-items: center; gap: 8px; 
        }
        .brand-icon { font-size: 2rem; } 
        .brand-text { display: flex; flex-direction: column; line-height: 1; }
        .slogan { font-size: 0.65rem; font-weight: 600; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;}
        
        .user-profile { display: flex; align-items: center; gap: 10px; }
        .user-info { text-align: right; display: none; }
        .user-name { font-weight: 700; font-size: 0.9rem; color: var(--text); }
        .user-title { font-size: 0.75rem; color: var(--accent); font-weight: 600; text-transform: uppercase; }
        
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); background: #eee; }

        .container { max-width: 800px; margin: 0 auto; width: 100%; padding: 16px; flex: 1; }

        /* --- Tabs --- */
        .nav-pills { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch;}
        .nav-item {
            padding: 10px 20px; border-radius: 25px; background: white; color: #6b7280;
            font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.3s; border: 1px solid #e5e7eb;
        }
        .nav-item.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 6px rgba(0, 105, 92, 0.2); }

        /* --- Views --- */
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Quiz UI --- */
        .quiz-container { text-align: center; padding: 10px 0; }
        .quiz-badge { display: inline-block; padding: 6px 16px; background: #ecfdf5; color: var(--primary); border-radius: 20px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 0.5px; border: 1px solid #a7f3d0; }
        .quiz-question { font-size: 1.5rem; color: #111827; margin: 10px 0; font-weight: 800; line-height: 1.3; }
        .quiz-desc { color: #4b5563; font-style: italic; margin-bottom: 20px; line-height: 1.6; font-size: 1rem; }
        
        .feedback { min-height: 30px; margin-top: 15px; font-weight: 700; font-size: 1.1rem; }
        .feedback.correct { color: var(--success); animation: popIn 0.3s; }
        .feedback.wrong { color: var(--error); animation: shake 0.4s; }

        /* --- Library UI (TÃ ng Kinh CÃ¡c) --- */
        .lib-search-box { position: sticky; top: 0; background: var(--surface); z-index: 10; padding: 10px 0; margin-bottom: 10px; }
        .lib-controls { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
        
        .accordion-item { border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 8px; overflow: hidden; background: white; }
        .accordion-header { 
            padding: 12px 16px; background: #f9fafb; cursor: pointer; font-weight: 600; 
            display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;
        }
        .accordion-header:hover { background: #f3f4f6; }
        .accordion-header.active { background: #e0f2f1; color: var(--primary); }
        .accordion-content { display: none; padding: 10px; background: white; }
        .accordion-content.open { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }

        .lib-card { 
            border: 1px solid #f3f4f6; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; gap: 4px;
            cursor: pointer; transition: all 0.2s; position: relative;
        }
        .lib-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-color: var(--primary-light); }
        .lib-code { font-size: 0.7rem; font-weight: 800; color: var(--text-light); text-transform: uppercase; background: #f3f4f6; padding: 2px 6px; border-radius: 4px; width: fit-content; }
        .lib-name { font-weight: 700; font-size: 0.95rem; color: var(--text); }
        .lib-srs { font-size: 0.75rem; color: var(--success); font-weight: 600; display: flex; align-items: center; gap: 2px; }
        .lib-del { position: absolute; top: 5px; right: 5px; opacity: 0; transition: 0.2s; color: var(--error); background: none; border: none; cursor: pointer; font-size: 1.1rem;}
        .lib-card:hover .lib-del { opacity: 1; }

        .caution-icon { position: absolute; top: 10px; right: 10px; font-size: 1.2rem; }

        /* Feature: Treats Tag */
        .tag-treat {
            font-size: 0.7rem; color: var(--primary-dark); background: var(--primary-light); 
            padding: 2px 6px; border-radius: 6px; margin-top: 4px; display: inline-block; 
            font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;
        }

        /* Modal Details & Edit */
        #detailModal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; justify-content: center; align-items: flex-end;
        }
        #detailModal.show { display: flex; animation: fadeIn 0.2s; }
        .detail-sheet {
            background: white; width: 100%; max-width: 600px; 
            border-radius: 20px 20px 0 0; padding: 25px;
            animation: slideUp 0.3s; max-height: 85vh; overflow-y: auto;
            display: flex; flex-direction: column;
        }
        @media(min-width: 600px) {
            #detailModal { align-items: center; }
            .detail-sheet { border-radius: 20px; width: 90%; }
        }

        .caution-box {
            background: #fef2f2; border: 1px solid #fee2e2; color: #b91c1c;
            padding: 12px; border-radius: 8px; margin-bottom: 15px;
            display: flex; align-items: flex-start; gap: 10px;
        }
        .caution-box strong { display: block; margin-bottom: 2px; text-transform: uppercase; font-size: 0.8rem; }

        /* --- Combo (Prescription) UI --- */
        .combo-list { display: grid; gap: 12px; }
        .combo-card {
            background: white; border: 1px solid #e5e7eb; border-radius: 12px;
            padding: 16px; cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; gap: 8px;
        }
        .combo-card:hover { border-color: var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.05); transform: translateY(-2px); }
        .combo-title { font-weight: 800; color: var(--text); font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        .combo-points { display: flex; flex-wrap: wrap; gap: 6px; }
        .combo-tag { 
            background: #e0f2f1; color: var(--primary-dark); padding: 4px 10px; 
            border-radius: 20px; font-size: 0.8rem; font-weight: 600; 
        }

        /* --- Leaderboard UI --- */
        .lb-container { display: flex; flex-direction: column; gap: 10px; }
        .lb-item { 
            display: flex; align-items: center; padding: 12px 16px; background: white; 
            border-radius: 16px; border: 1px solid #f3f4f6;
            transition: transform 0.2s;
        }
        .lb-rank { 
            font-weight: 800; font-size: 1rem; width: 30px; height: 30px; 
            display: flex; justify-content: center; align-items: center; 
            border-radius: 50%; background: #f3f4f6; color: #6b7280; margin-right: 12px; flex-shrink: 0;
        }
        .lb-info { flex: 1; min-width: 0; }
        .lb-name { font-weight: 700; color: #374151; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.95rem; }
        .lb-detail { font-size: 0.75rem; color: #9ca3af; margin-top: 2px; }
        .lb-score { 
            font-weight: 800; color: var(--primary); background: #ecfdf5; 
            padding: 6px 12px; border-radius: 12px; font-size: 0.9rem;
        }
        .lb-top1 { background: linear-gradient(135deg, #fffbeb, #fff); border: 1px solid #fcd34d; }
        .lb-top1 .lb-rank { background: #f59e0b; color: white; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3); }
        .lb-top2 { background: linear-gradient(135deg, #f8fafc, #fff); border: 1px solid #cbd5e1; }
        .lb-top2 .lb-rank { background: #94a3b8; color: white; }
        .lb-top3 { background: linear-gradient(135deg, #fff7ed, #fff); border: 1px solid #fdba74; }
        .lb-top3 .lb-rank { background: #d97706; color: white; }

        /* --- Badges --- */
        .badges-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; justify-content: center; }
        .badge-item { 
            display: flex; align-items: center; gap: 6px; padding: 8px 12px; 
            background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; 
            font-size: 0.75rem; font-weight: 700; color: #9ca3af; opacity: 0.6; 
            filter: grayscale(1); transition: all 0.3s;
        }
        .badge-item.unlocked { 
            opacity: 1; filter: grayscale(0); border-color: var(--accent); 
            background: linear-gradient(135deg, #fffbeb, #fff); 
            color: #b45309; box-shadow: 0 4px 6px rgba(251, 191, 36, 0.1); 
            transform: scale(1.02);
        }

        /* --- Calendar UI --- */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; font-size: 0.9rem; margin-top: 10px;}
        .cal-day-header { font-weight: bold; color: #9ca3af; padding-bottom: 5px; font-size: 0.8rem; }
        .cal-day { 
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center; 
            border-radius: 10px; background: #f9fafb; color: #d1d5db; font-weight: 600;
        }
        .cal-day.active { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cal-day.today { border: 2px solid var(--accent); color: var(--text); }

        /* --- Utilities --- */
        .app-footer { text-align: center; padding: 30px 20px; margin-top: auto; color: #9ca3af; font-size: 0.85rem; }
        .heart-anim { color: #e91e63; display: inline-block; animation: heartBeat 1.5s infinite; }
        @keyframes heartBeat { 0% { transform: scale(1); } 14% { transform: scale(1.3); } 28% { transform: scale(1); } 42% { transform: scale(1.3); } 70% { transform: scale(1); } }
        
        #toast { visibility: hidden; min-width: 200px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 1000; left: 50%; bottom: 80px; transform: translateX(-50%); opacity: 0; transition: 0.3s; box-shadow: 0 10px 25px rgba(0,0,0,0.2); font-size: 0.95rem; font-weight: 500; }
        #toast.show { visibility: visible; opacity: 1; bottom: 100px; }
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 200; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 10px; display: none;}
        .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- Floating Home Button --- */
        .floating-home-btn {
            position: fixed; bottom: 30px; left: 20px; z-index: 900;
            display: flex; align-items: center; gap: 10px; padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 50px;
            color: var(--primary); text-decoration: none; font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); transition: all 0.3s ease;
        }
        .floating-home-btn:hover { background: linear-gradient(90deg, #4db6ac, #00695c); transform: translateY(-3px); color: white; border-color: transparent; }
        .floating-home-btn svg { width: 24px; height: 24px; transition: transform 0.3s ease; }
        .floating-home-btn:hover svg { transform: scale(1.1); }
        @media (max-width: 640px) { .floating-home-btn span { display: none; } .floating-home-btn { padding: 12px; border-radius: 50%; bottom: 20px; left: 15px; } }

    </style>
</head>
<body>

    <a href="https://ngxuanhai123.github.io/" class="floating-home-btn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        <span>Trang chá»§</span>
    </a>

    <div id="loading"><div class="spinner"></div></div>
    <div id="toast">ThÃ´ng bÃ¡o</div>

    <div id="disclaimer-modal">
        <div class="disclaimer-box">
            <div style="font-size: 3rem;">ğŸš¨</div>
            <h2>Cáº¢NH BÃO QUAN TRá»ŒNG</h2>
            <p>á»¨ng dá»¥ng nÃ y chá»‰ mang tÃ­nh cháº¥t <b>THAM KHáº¢O</b> vÃ  há»— trá»£ há»c táº­p. Tuyá»‡t Ä‘á»‘i khÃ´ng tá»± Ã½ thá»±c hÃ nh chÃ¢m cá»©u/báº¥m huyá»‡t chá»¯a bá»‡nh náº¿u chÆ°a cÃ³ chuyÃªn mÃ´n.</p>
            <ul>
                <li>Má»™t sá»‘ huyá»‡t <b>Cáº¤M Ká»´</b> vá»›i phá»¥ ná»¯ cÃ³ thai (gÃ¢y sáº£y thai).</li>
                <li>Má»™t sá»‘ vÃ¹ng huyá»‡t nguy hiá»ƒm (gáº§n phá»•i, Ä‘á»™ng máº¡ch) cáº§n ká»¹ thuáº­t cao.</li>
            </ul>
            <button class="btn btn-primary" onclick="document.getElementById('disclaimer-modal').style.display='none'">TÃ´i Ä‘Ã£ hiá»ƒu & Äá»“ng Ã½</button>
        </div>
    </div>

    <div id="detailModal">
        <div class="detail-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div>
                    <span id="modalCode" style="background:var(--primary); color:white; padding:4px 8px; border-radius:6px; font-weight:800; font-size:0.8rem;">CODE</span>
                    <button id="btnEditModal" class="btn-icon" title="Chá»‰nh sá»­a" style="margin-left: 10px;">âœï¸</button>
                </div>
                <button onclick="document.getElementById('detailModal').classList.remove('show')" style="border:none; background:none; font-size:1.5rem; color:#999; cursor:pointer;">&times;</button>
            </div>

            <div id="modalViewContent">
                <div id="modalCaution" class="caution-box" style="display:none;">
                    <span style="font-size:1.5rem;">âš ï¸</span>
                    <div>
                        <strong>Chá»‘ng chá»‰ Ä‘á»‹nh / Cáº£nh bÃ¡o:</strong>
                        <span id="modalCautionText"></span>
                    </div>
                </div>

                <h2 id="modalName" style="margin:0 0 5px 0; color:var(--primary-dark);">TÃªn Huyá»‡t</h2>
                <div id="modalGroup" style="color:var(--text-light); font-size:0.9rem; font-style:italic; margin-bottom:10px;">NhÃ³m huyá»‡t</div>
                
                <div id="modalTreatsContainer" style="margin-bottom: 15px;">
                    </div>

                <div style="background:#f9fafb; padding:15px; border-radius:12px; margin-bottom:20px;">
                    <h4 style="margin:0 0 8px 0;">Vá»‹ trÃ­ & MÃ´ táº£</h4>
                    <p id="modalDesc" style="margin:0; line-height:1.6; color:#4b5563;">MÃ´ táº£ chi tiáº¿t...</p>
                </div>
                
                <button class="btn btn-search" id="modalSearchBtn">ğŸ” Xem hÃ¬nh áº£nh trÃªn Google</button>
            </div>

            <div id="modalEditContent" style="display: none;">
                <h3 style="margin-top:0; color: var(--primary);">Chá»‰nh sá»­a Huyá»‡t</h3>
                <label style="font-size: 0.85rem; font-weight: 600; color: #666;">NhÃ³m huyá»‡t</label>
                <input type="text" id="editGroup" placeholder="NhÃ³m">
                
                <label style="font-size: 0.85rem; font-weight: 600; color: #666;">TÃªn huyá»‡t</label>
                <input type="text" id="editName" placeholder="TÃªn huyá»‡t">
                
                <label style="font-size: 0.85rem; font-weight: 600; color: #666;">Chá»§ trá»‹ (Bá»‡nh chá»¯a Ä‘Æ°á»£c)</label>
                <input type="text" id="editTreats" placeholder="VD: Äau Ä‘áº§u, máº¥t ngá»§...">

                <label style="font-size: 0.85rem; font-weight: 600; color: #666;">MÃ´ táº£ / Vá»‹ trÃ­</label>
                <textarea id="editDesc" rows="4" placeholder="MÃ´ táº£..."></textarea>
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-primary" id="btnSaveEdit" style="flex:1;">LÆ°u Thay Äá»•i</button>
                    <button class="btn btn-secondary" onclick="toggleEditMode(false)" style="flex:1;">Há»§y</button>
                </div>
            </div>

        </div>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <div style="font-size: 4rem; margin-bottom: 15px;">ğŸ¥‹</div>
            <h1 style="color: var(--primary); margin: 0; font-size: 1.8rem; letter-spacing: -1px; margin-bottom: 10px;" id="loginTitle">Nháº­p MÃ´n</h1>
            <p style="color: #6b7280; margin-bottom: 30px; font-size: 1rem; line-height: 1.5;" id="loginMsg">ÄÄƒng nháº­p Ä‘á»ƒ lÆ°u bÃ­ kÃ­p<br>vÃ  tranh Ä‘oáº¡t ngÃ´i vá»‹ Minh Chá»§</p>
            <button class="btn btn-google" id="btnLogin">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" style="margin-right:10px">
                Tiáº¿p tá»¥c báº±ng Google
            </button>
            <p style="font-size: 0.85rem; color: #9ca3af; margin-top: 25px;">ChÃ¢n nhÃ¢n báº¥t lá»™ tÆ°á»›ng (Miá»…n phÃ­)</p>
        </div>
    </div>

    <div id="app-screen">
        <header>
            <div class="brand">
                <span class="brand-icon">âš•ï¸</span>
                <div class="brand-text">
                    <span>HiHi Med</span>
                    <span class="slogan">Tuyá»‡t Ká»¹ Y Há»c: Chá»¯a Ä‘Æ°á»£c lÃ  nhá» thuá»‘c, khÃ´ng chá»¯a Ä‘Æ°á»£c lÃ  táº¡iâ€¦ duyÃªn pháº­n</span>
                </div>
            </div>
            <div class="user-profile">
                <div class="user-info" id="headerUserInfo">
                    <div class="user-name" id="displayUserName">KhÃ¡ch</div>
                    <div class="user-title" id="displayUserTitle">Lang BÄƒm</div>
                </div>
                <img id="userAvatar" class="avatar" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NmZDhkYyI+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00czLTEuNzktNC00LTRzLTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==" alt="">
                <button class="btn btn-primary btn-xs" style="display:none;" id="btnLogout">ThoÃ¡t</button>
                <button class="btn btn-primary btn-xs" id="btnLoginHeader">VÃ o</button>
            </div>
        </header>

        <div class="container">
            <div class="nav-pills">
                <div class="nav-item active" data-target="tab-quiz">ğŸ§  Luyá»‡n CÃ´ng</div>
                <div class="nav-item" data-target="tab-dashboard">ğŸ† Báº£ng VÃ ng</div>
                <div class="nav-item" data-target="tab-manage">ğŸ“– TÃ ng Kinh CÃ¡c</div>
                <div class="nav-item" data-target="tab-combo">ğŸ’Š Toa Thuá»‘c</div>
            </div>

            <div id="tab-quiz" class="view active">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin:0; font-size: 1.1rem; color: var(--primary-dark);">Luyá»‡n Táº­p <span id="limitCounter" style="font-size: 0.8rem; color: #f59e0b; display:none;">(0/10)</span></h3>
                        <select id="quizGroupSelect" style="width: auto; margin:0; padding: 6px 12px; font-size: 0.85rem; border-radius: 20px; background: #f3f4f6; border: none;">
                            <option value="all">Táº¥t cáº£ chiÃªu thá»©c</option>
                        </select>
                    </div>

                    <div id="quizArea" class="quiz-container">
                        <div class="quiz-badge" id="qGroup">...</div>
                        
                        <div class="quiz-question" id="qQuestion">...</div>
                        <p class="quiz-desc" id="qDesc">...</p>
                        
                        <button class="btn btn-search" id="btnSearchImg">
                            ğŸ” Báº¥m Ä‘á»ƒ xem chÃ¢n dung huyá»‡t Ä‘áº¡o (Google)
                        </button>
                        
                        <input type="text" id="qInput" placeholder="Nháº­p tÃªn huyá»‡t..." autocomplete="off" style="font-size: 1.1rem; text-align: center; font-weight: 600;">
                        
                        <div class="feedback" id="qFeedback"></div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-accent" id="btnHint">ğŸ’¡ Gá»£i Ã½</button>
                            <button class="btn btn-secondary" id="btnShowAns">ğŸ‘ï¸ Xem ÄÃ¡p Ã¡n</button>
                        </div>
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 12px; background: white; border: 1px solid #e5e7eb; color: #9ca3af;" id="btnNext">Bá» qua chiÃªu nÃ y âœ</button>
                    </div>
                    
                    <div id="emptyQuizMsg" style="display:none; text-align: center; padding: 40px 20px;">
                        <div style="font-size: 4rem; margin-bottom: 10px;">ğŸ§˜</div>
                        <h2 style="margin: 0; color: var(--primary);">Äáº¯c Äáº¡o ThÃ nh TiÃªn</h2>
                        <p id="emptyMsgText" style="color: #6b7280;">HÃ´m nay báº¡n Ä‘Ã£ luyá»‡n háº¿t cÃ¡c bÃ i cáº§n Ã´n.</p>
                        <button class="btn btn-primary" id="btnInitData" onclick="initDefaultData()" style="margin-top: 15px;">â™»ï¸ Táº£i bÃ­ kÃ­p nháº­p mÃ´n (361 Huyá»‡t)</button>
                    </div>
                </div>
            </div>

            <div id="tab-dashboard" class="view">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div class="card" style="margin:0; text-align:center; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border:none;">
                        <div style="font-size: 2.5rem; font-weight: 800;" id="stat-streak">0</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; font-weight: 600;">NgÃ y Tu Luyá»‡n</div>
                    </div>
                    <div class="card" style="margin:0; text-align:center;">
                        <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary);" id="stat-mastered">0</div>
                        <div style="font-size: 0.85rem; color: #6b7280; font-weight: 600;">ChiÃªu ÄÃ£ Thuá»™c</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-top:0; margin-bottom:15px; font-size: 1.1rem; text-align: center;">ğŸ… Bá»™ SÆ°u Táº­p Danh Hiá»‡u</h3>
                    <div class="badges-container">
                        <div class="badge-item" id="badge-novice">ğŸŒ± Lang BÄƒm Táº­p Sá»±</div>
                        <div class="badge-item" id="badge-streak3">ğŸ”¥ Há»a NhÃ£n Kim Tinh (3 ngÃ y)</div>
                        <div class="badge-item" id="badge-master5">ğŸ“– SÃ¡ch Y Cháº¡y Báº±ng CÆ¡m</div>
                        <div class="badge-item" id="badge-streak7">ğŸ“¡ Báº¯t Máº¡ch Online (7 ngÃ y)</div>
                        <div class="badge-item" id="badge-streak14">ğŸ¯ ThÃ¡i Y Viá»‡n TrÆ°á»Ÿng (14 ngÃ y)</div>
                        <div class="badge-item" id="badge-streak30">ğŸ‰ Äá»™c CÃ´ Cáº§u Báº¡i (30 ngÃ y)</div>
                        <div class="badge-item" id="badge-master20">âœ¨ Hoa ÄÃ  TÃ¡i Tháº¿ (20 bÃ i)</div>
                        <div class="badge-item" id="badge-master50">ğŸŒ©ï¸ Tháº§n Y Háº¡ PhÃ m (50 bÃ i)</div>
                    </div>
                </div>

                <div class="card">
                    <div class="cal-header">
                        <h3 style="margin:0; font-size: 1.1rem; display:flex; align-items:center; gap:5px;">ğŸ“… Lá»‹ch Sá»­ Tu Luyá»‡n</h3>
                        <div>
                            <button class="btn btn-xs btn-primary" id="viewWeek">Tuáº§n</button>
                            <button class="btn btn-xs btn-secondary" id="viewMonth">ThÃ¡ng</button>
                        </div>
                    </div>
                    <div class="cal-grid" style="margin-bottom: 5px;">
                        <div class="cal-day-header">CN</div><div class="cal-day-header">T2</div><div class="cal-day-header">T3</div><div class="cal-day-header">T4</div><div class="cal-day-header">T5</div><div class="cal-day-header">T6</div><div class="cal-day-header">T7</div>
                    </div>
                    <div id="calendarGrid" class="cal-grid"></div>
                </div>

                <h3 style="margin: 20px 0 15px; font-size: 1.2rem; color: var(--primary-dark); text-align: center; font-weight: 800;">ğŸ† ThiÃªn Háº¡ Äá»‡ Nháº¥t Bang</h3>
                <div id="leaderboardList" class="lb-container">
                    <div style="text-align:center; padding: 20px; color: #9ca3af;">Äang triá»‡u há»“i báº£ng xáº¿p háº¡ng...</div>
                </div>
            </div>

            <div id="tab-manage" class="view">
                <div class="card">
                    <h3 style="margin-top:0; font-size: 1.2rem; display:flex; justify-content:space-between; align-items:center;">
                        ğŸ“– TÃ ng Kinh CÃ¡c
                        <button class="btn btn-xs btn-secondary" onclick="document.getElementById('addForm').style.display = document.getElementById('addForm').style.display=='none'?'block':'none'">+ ThÃªm má»›i</button>
                    </h3>
                    
                    <div id="addForm" style="display:none; margin-bottom:15px; padding:15px; background:#f9fafb; border-radius:12px;">
                        <input type="text" id="inpGroup" placeholder="NhÃ³m (VD: Pháº¿ Kinh)" list="groupSuggestions">
                        <input type="text" id="inpName" placeholder="TÃªn Huyá»‡t (VD: LU1 Trung Phá»§)">
                        <input type="text" id="inpTreats" placeholder="Chá»§ trá»‹ (VD: Ho, suyá»…n, Ä‘au ngá»±c...)">
                        <textarea id="inpDesc" rows="2" placeholder="MÃ´ táº£ vá»‹ trÃ­..."></textarea>
                        <button class="btn btn-primary" id="btnAddData" style="width: 100%">LÆ°u</button>
                        <datalist id="groupSuggestions"></datalist>
                    </div>

                    <div class="lib-search-box">
                        <div class="lib-controls">
                            <input type="text" id="libSearch" placeholder="ğŸ” TÃ¬m tÃªn, bá»‡nh, hoáº·c nhÃ³m..." style="margin:0;">
                            <select id="libFilter" style="margin:0; width:auto;">
                                <option value="all">Táº¥t cáº£</option>
                                <option value="learned">ÄÃ£ thuá»™c</option>
                                <option value="new">ChÆ°a há»c</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="libraryContent">
                    </div>
                    
                    <div style="margin-top: 20px; text-align:center;">
                         <button class="btn btn-secondary btn-xs" onclick="initDefaultData()">â™»ï¸ KhÃ´i phá»¥c gá»‘c (361 huyá»‡t)</button>
                    </div>
                </div>
            </div>

            <div id="tab-combo" class="view">
                <div class="card">
                    <h3 style="margin-top:0; margin-bottom:15px; font-size: 1.1rem;">ğŸ’Š BÃ­ KÃ­p Phá»‘i Huyá»‡t</h3>
                    <p style="font-size:0.9rem; color:#6b7280; margin-bottom:20px;">CÃ¡c bÃ i thuá»‘c phá»‘i há»£p huyá»‡t phá»• biáº¿n trong Y há»c cá»• truyá»n.</p>
                    <div id="comboList" class="combo-list">
                        </div>
                </div>
            </div>
        </div>

        <footer class="app-footer">
            HiHi Med - Tuyá»‡t Ká»¹ Y Há»c &copy; 2025<br>
            Made with <span class="heart-anim">â¤</span> by XuÃ¢n Háº£i
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, serverTimestamp, writeBatch, orderBy, limit, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAsHD5pH6Blm4wtXKEJojFYMl24SNgiKY0",
            authDomain: "bamhuyet-6c9e6.firebaseapp.com",
            projectId: "bamhuyet-6c9e6",
            storageBucket: "bamhuyet-6c9e6.firebasestorage.app",
            messagingSenderId: "195174949274",
            appId: "1:195174949274:web:50cd99e0fad60ba8a81a23",
            measurementId: "G-W66885N5XM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let isGuest = true;
        let guestQuizCount = 0;
        const GUEST_LIMIT = 10;
        
        let acupoints = [];
        let currentQuizItem = null;
        let currentEditingItem = null;
        let currentHintIndex = 0;
        let todayCheckedIn = false;
        let attendanceDates = new Set();
        let calViewMode = 'week'; 
        let isProcessing = false;
        let currentTitle = "Lang BÄƒm";

        const SRS_INTERVALS = [0, 1, 3, 7, 14, 30, 90];

        // --- DATA WITH CAUTION FIELD (t: treats, c: caution) ---
        const createPoints = (code, groupName, dataList) => {
            return dataList.map((item, i) => ({
                group: groupName,
                name: `${code}${i+1} ${item.n}`,
                desc: `Huyá»‡t thá»© ${i+1} cá»§a ${groupName}.`,
                treats: item.t,
                caution: item.c || "" // New caution field
            }));
        };

        const luData = [
            {n:"Trung Phá»§", t:"Ho, suyá»…n, Ä‘au ngá»±c, vai Ä‘au"},
            {n:"VÃ¢n MÃ´n", t:"Ho, suyá»…n, Ä‘áº§y tá»©c ngá»±c"},
            {n:"ThiÃªn Phá»§", t:"Ho, suyá»…n, cháº£y mÃ¡u mÅ©i"},
            {n:"Hiá»‡p Báº¡ch", t:"Ho, khÃ­ nghá»‹ch, Ä‘au tay"},
            {n:"XÃ­ch Tráº¡ch", t:"Ho, sá»‘t, há»ng sÆ°ng Ä‘au"},
            {n:"Khá»•ng Tá»‘i", t:"Ho ra mÃ¡u, Ä‘au há»ng, máº¥t tiáº¿ng"},
            {n:"Liá»‡t Khuyáº¿t", t:"Äau Ä‘áº§u, Ä‘au cá»• gÃ¡y, ho, liá»‡t máº·t"},
            {n:"Kinh Cá»«", t:"Ho, suyá»…n, Ä‘au há»ng"},
            {n:"ThÃ¡i UyÃªn", t:"Ho, Ä‘á»m nhiá»u, Ä‘au ngá»±c, máº¡ch yáº¿u"},
            {n:"NgÆ° Táº¿", t:"Ho, Ä‘au há»ng, máº¥t tiáº¿ng, sá»‘t"},
            {n:"Thiáº¿u ThÆ°Æ¡ng", t:"Sá»‘t cao, Ä‘au há»ng, trÃºng giÃ³, cháº£y mÃ¡u cam"}
        ];

        const liData = [
            {n:"ThÆ°Æ¡ng DÆ°Æ¡ng", t:"Äau rÄƒng, Ä‘au há»ng, sá»‘t cao"},
            {n:"Nhá»‹ Gian", t:"Cháº£y mÃ¡u cam, Ä‘au rÄƒng, Ä‘au há»ng"},
            {n:"Tam Gian", t:"Äau rÄƒng, Ä‘au há»ng, Ä‘áº§y bá»¥ng"},
            {n:"Há»£p Cá»‘c", t:"Äau Ä‘áº§u, Ä‘au rÄƒng, cáº£m cÃºm, Ä‘au bá»¥ng, liá»‡t máº·t", c:"TUYá»†T Äá»I Cáº¤M chÃ¢m/báº¥m cho phá»¥ ná»¯ cÃ³ thai (gÃ¢y co bÃ³p tá»­ cung)."},
            {n:"DÆ°Æ¡ng KhÃª", t:"Äau Ä‘áº§u, máº¯t Ä‘á», Ä‘au cá»• tay"},
            {n:"ThiÃªn Lá»‹ch", t:"Cháº£y mÃ¡u cam, Ä‘au há»ng, phÃ¹ thÅ©ng"},
            {n:"Ã”n LÆ°u", t:"Äau Ä‘áº§u, sÆ°ng máº·t, Ä‘au vai"},
            {n:"Háº¡ LiÃªm", t:"Äau bá»¥ng, Ä‘au khuá»·u tay"},
            {n:"ThÆ°á»£ng LiÃªm", t:"Äau vai, liá»‡t tay, Ä‘au bá»¥ng"},
            {n:"Thá»§ Tam LÃ½", t:"Liá»‡t tay, Ä‘au vai, Ä‘au bá»¥ng"},
            {n:"KhÃºc TrÃ¬", t:"Sá»‘t, dá»‹ á»©ng, huyáº¿t Ã¡p cao, Ä‘au khuá»·u tay"},
            {n:"Trá»­u LiÃªu", t:"Äau khuá»·u tay, tÃª tay"},
            {n:"Thá»§ NgÅ© LÃ½", t:"Ho ra mÃ¡u, lao háº¡ch, Ä‘au khuá»·u tay"},
            {n:"TÃ­ Nhu", t:"Äau vai, khÃ´ng giÆ¡ tay Ä‘Æ°á»£c"},
            {n:"KiÃªn Ngung", t:"Äau vai, liá»‡t tay, ná»•i má» Ä‘ay"},
            {n:"Cá»± Cá»‘t", t:"Äau vai, Ä‘au cÃ¡nh tay"},
            {n:"ThiÃªn Äá»‰nh", t:"Äau há»ng, máº¥t tiáº¿ng, lao háº¡ch"},
            {n:"PhÃ¹ Äá»™t", t:"Ho, suyá»…n, Ä‘au há»ng"},
            {n:"HÃ²a LiÃªu", t:"Cháº£y mÃ¡u cam, ngáº¡t mÅ©i"},
            {n:"Nghinh HÆ°Æ¡ng", t:"Ngáº¡t mÅ©i, viÃªm mÅ©i, liá»‡t máº·t"}
        ];

        const stData = [
            {n:"Thá»«a Kháº¥p", t:"Máº¯t Ä‘á», quÃ¡ng gÃ , liá»‡t máº·t", c:"VÃ¹ng máº¯t nguy hiá»ƒm, cáº©n tháº­n xuáº¥t huyáº¿t."},
            {n:"Tá»© Báº¡ch", t:"Máº¯t Ä‘á», ngá»©a máº¯t, Ä‘au Ä‘áº§u", c:"VÃ¹ng máº¯t nguy hiá»ƒm."},
            {n:"Cá»± LiÃªu", t:"Liá»‡t máº·t, cháº£y mÃ¡u cam, Ä‘au rÄƒng"},
            {n:"Äá»‹a ThÆ°Æ¡ng", t:"MÃ©o miá»‡ng, cháº£y nÆ°á»›c dÃ£i, liá»‡t máº·t"},
            {n:"Äáº¡i NghÃªnh", t:"Äau rÄƒng, sÆ°ng mÃ¡, liá»‡t máº·t"},
            {n:"GiÃ¡p Xa", t:"Äau rÄƒng, cá»©ng hÃ m, liá»‡t máº·t"},
            {n:"Háº¡ Quan", t:"Ã™ tai, Ä‘iáº¿c tai, Ä‘au rÄƒng"},
            {n:"Äáº§u Duy", t:"Äau Ä‘áº§u, chÃ³ng máº·t"},
            {n:"NhÃ¢n NghÃªnh", t:"Äau há»ng, hen suyá»…n, cao huyáº¿t Ã¡p", c:"TrÃ¡nh Ä‘á»™ng máº¡ch cáº£nh."},
            {n:"Thá»§y Äá»™t", t:"Äau há»ng, ho, suyá»…n"},
            {n:"KhÃ­ XÃ¡", t:"Äau há»ng, bÆ°á»›u cá»•, cá»©ng cá»•"},
            {n:"Khuyáº¿t Bá»“n", t:"Ho, suyá»…n, Ä‘au há»ng", c:"Cáº¤M chÃ¢m sÃ¢u (gÃ¢y trÃ n khÃ­ mÃ ng phá»•i)."},
            {n:"KhÃ­ Há»™", t:"Ho, suyá»…n, Ä‘áº§y ngá»±c"},
            {n:"Khá»‘ PhÃ²ng", t:"Ho, Ä‘áº§y ngá»±c, Ä‘au sÆ°á»n"},
            {n:"á»c áº¾", t:"Ho, suyá»…n, Ä‘au vÃº"},
            {n:"Æ¯ng Song", t:"Ho, suyá»…n, viÃªm tuyáº¿n vÃº"},
            {n:"NhÅ© Trung", t:"KhÃ´ng chÃ¢m cá»©u (Chá»‰ lÃ m má»‘c Ä‘o)", c:"Cáº¤M chÃ¢m cá»©u."},
            {n:"NhÅ© CÄƒn", t:"ViÃªm tuyáº¿n vÃº, thiáº¿u sá»¯a"},
            {n:"Báº¥t Dung", t:"Äáº§y bá»¥ng, nÃ´n má»­a, Ä‘au dáº¡ dÃ y"},
            {n:"Thá»«a MÃ£n", t:"Äáº§y bá»¥ng, Ä‘au dáº¡ dÃ y"},
            {n:"LÆ°Æ¡ng MÃ´n", t:"Äau dáº¡ dÃ y, nÃ´n má»­a"},
            {n:"Quan MÃ´n", t:"Äau bá»¥ng, Ä‘áº§y hÆ¡i, tiÃªu cháº£y"},
            {n:"ThÃ¡i áº¤t", t:"Äau dáº¡ dÃ y, rá»‘i loáº¡n tiÃªu hÃ³a"},
            {n:"Hoáº¡t Nhá»¥c MÃ´n", t:"Äau dáº¡ dÃ y, nÃ´n má»­a"},
            {n:"ThiÃªn Khu", t:"Äau bá»¥ng, tiÃªu cháº£y, tÃ¡o bÃ³n"},
            {n:"Ngoáº¡i LÄƒng", t:"Äau bá»¥ng dÆ°á»›i, Ä‘au bá»¥ng kinh"},
            {n:"Äáº¡i Cá»±", t:"Bá»¥ng dÆ°á»›i Ä‘áº§y, bÃ­ tiá»ƒu"},
            {n:"Thá»§y Äáº¡o", t:"BÃ­ tiá»ƒu, viÃªm bÃ ng quang"},
            {n:"Quy Lai", t:"Äau bá»¥ng kinh, sa tinh hoÃ n"},
            {n:"KhÃ­ Xung", t:"ThoÃ¡t vá»‹ báº¹n, Ä‘au bá»¥ng"},
            {n:"Bá»… Quan", t:"Liá»‡t chÃ¢n, Ä‘au khá»›p hÃ¡ng"},
            {n:"Phá»¥c Thá»", t:"Liá»‡t chÃ¢n, Ä‘au Ä‘áº§u gá»‘i"},
            {n:"Ã‚m Thá»‹", t:"Liá»‡t chÃ¢n, Ä‘au Ä‘áº§u gá»‘i"},
            {n:"LÆ°Æ¡ng KhÃ¢u", t:"Äau dáº¡ dÃ y cáº¥p, Ä‘au Ä‘áº§u gá»‘i"},
            {n:"Äá»™c Tá»‹", t:"Äau sÆ°ng Ä‘áº§u gá»‘i"},
            {n:"TÃºc Tam LÃ½", t:"Äau dáº¡ dÃ y, tiÃªu hÃ³a kÃ©m, suy nhÆ°á»£c, tÄƒng miá»…n dá»‹ch"},
            {n:"ThÆ°á»£ng Cá»± HÆ°", t:"ViÃªm ruá»™t thá»«a, Ä‘au bá»¥ng, tiÃªu cháº£y"},
            {n:"Äiá»u Kháº©u", t:"Äau vai, tÃª chÃ¢n, liá»‡t chÃ¢n"},
            {n:"Háº¡ Cá»± HÆ°", t:"Äau bá»¥ng dÆ°á»›i, tiÃªu cháº£y"},
            {n:"Phong Long", t:"Ho Ä‘á»m nhiá»u, hen suyá»…n, bÃ©o phÃ¬"},
            {n:"Giáº£i KhÃª", t:"Äau cá»• chÃ¢n, Ä‘au Ä‘áº§u"},
            {n:"Xung DÆ°Æ¡ng", t:"Äau mu bÃ n chÃ¢n, liá»‡t máº·t"},
            {n:"HÃ£m Cá»‘c", t:"SÆ°ng máº·t, Ä‘au bá»¥ng"},
            {n:"Ná»™i ÄÃ¬nh", t:"Äau rÄƒng, Ä‘au há»ng, cháº£y mÃ¡u cam"},
            {n:"Lá»‡ ÄoÃ i", t:"MÆ¡ mÃ ng, Ã¡c má»™ng, Ä‘au rÄƒng"}
        ];

        const spData = [
            {n:"áº¨n Báº¡ch", t:"Rong kinh, bÄƒng huyáº¿t, Ä‘áº§y bá»¥ng"},
            {n:"Äáº¡i ÄÃ´", t:"Äáº§y bá»¥ng, Ä‘au dáº¡ dÃ y"},
            {n:"ThÃ¡i Báº¡ch", t:"Äau dáº¡ dÃ y, Ä‘áº§y hÆ¡i, tÃ¡o bÃ³n"},
            {n:"CÃ´ng TÃ´n", t:"Äau dáº¡ dÃ y, nÃ´n má»­a, Ä‘au tim"},
            {n:"ThÆ°Æ¡ng KhÃ¢u", t:"Äáº§y bá»¥ng, tiÃªu cháº£y, vÃ ng da"},
            {n:"Tam Ã‚m Giao", t:"Rá»‘i loáº¡n kinh nguyá»‡t, máº¥t ngá»§, bá»• Ã¢m", c:"TUYá»†T Äá»I Cáº¤M chÃ¢m/báº¥m cho phá»¥ ná»¯ cÃ³ thai (gÃ¢y sáº£y thai)."},
            {n:"Láº­u Cá»‘c", t:"Äáº§y bá»¥ng, sÃ´i bá»¥ng, tÃª chÃ¢n"},
            {n:"Äá»‹a CÆ¡", t:"Äau bá»¥ng kinh, kinh nguyá»‡t khÃ´ng Ä‘á»u"},
            {n:"Ã‚m LÄƒng Tuyá»n", t:"TiÃªu cháº£y, bÃ­ tiá»ƒu, phÃ¹ thÅ©ng"},
            {n:"Huyáº¿t Háº£i", t:"Kinh nguyá»‡t khÃ´ng Ä‘á»u, dá»‹ á»©ng, ngá»©a da"},
            {n:"CÆ¡ MÃ´n", t:"BÃ­ tiá»ƒu, hÃ¡ng Ä‘au"},
            {n:"Xung MÃ´n", t:"Äau bá»¥ng, bÃ­ tiá»ƒu"},
            {n:"Phá»§ XÃ¡", t:"Äau bá»¥ng, tÃ¡o bÃ³n"},
            {n:"PhÃºc Káº¿t", t:"Äau quanh rá»‘n, tÃ¡o bÃ³n"},
            {n:"Äáº¡i HoÃ nh", t:"TiÃªu cháº£y, tÃ¡o bÃ³n, Ä‘au bá»¥ng"},
            {n:"PhÃºc Ai", t:"Äau bá»¥ng, tÃ¡o bÃ³n, kiáº¿t lá»µ"},
            {n:"Thá»±c Äáº­u", t:"Äáº§y ngá»±c, Ä‘au sÆ°á»n"},
            {n:"ThiÃªn KhÃª", t:"Äau ngá»±c, ho, Ã­t sá»¯a"},
            {n:"Hung HÆ°Æ¡ng", t:"Äáº§y ngá»±c, Ä‘au sÆ°á»n"},
            {n:"Chu Vinh", t:"Ho, Ä‘au sÆ°á»n, Ä‘áº§y ngá»±c"},
            {n:"Äáº¡i Bao", t:"Äau toÃ n thÃ¢n, Ä‘au sÆ°á»n"}
        ];
        
        // Data other meridians (Sample cautious points)
        const htData = [{n:"Cá»±c Tuyá»n", t:"Äau tim, hÃ´i nÃ¡ch"}, {n:"Thanh Linh", t:"Äau vai, Ä‘au tay"}, {n:"Thiáº¿u Háº£i", t:"Äau tim, tÃª tay"}, {n:"Linh Äáº¡o", t:"Äau tim, máº¥t tiáº¿ng"}, {n:"ThÃ´ng LÃ½", t:"Tim Ä‘áº­p nhanh, máº¥t tiáº¿ng"}, {n:"Ã‚m KhÃ­ch", t:"Äau tim, há»“i há»™p"}, {n:"Tháº§n MÃ´n", t:"Máº¥t ngá»§, hay quÃªn, há»“i há»™p, hysteria"}, {n:"Thiáº¿u Phá»§", t:"Tim Ä‘áº­p nhanh, Ä‘au ngá»±c"}, {n:"Thiáº¿u Xung", t:"Sá»‘t cao, hÃ´n mÃª, Ä‘au tim"}];
        const siData = [{n:"Thiáº¿u Tráº¡ch", t:"Thiáº¿u sá»¯a, Ä‘au Ä‘áº§u"}, {n:"Tiá»n Cá»‘c", t:"Äau tay, sá»‘t"}, {n:"Háº­u KhÃª", t:"Äau cá»• gÃ¡y, Ä‘au lÆ°ng"}, {n:"Uyá»ƒn Cá»‘t", t:"Äau cá»• tay, Ä‘au Ä‘áº§u"}, {n:"DÆ°Æ¡ng Cá»‘c", t:"Äau cá»• tay, Ã¹ tai"}, {n:"DÆ°á»¡ng LÃ£o", t:"Máº¯t má», Ä‘au lÆ°ng"}, {n:"Chi ChÃ­nh", t:"Cá»• gÃ¡y cá»©ng, hoa máº¯t"}, {n:"Tiá»ƒu Háº£i", t:"Äau khuá»·u tay, Ä‘au vai"}, {n:"KiÃªn Trinh", t:"Äau vai, Ã¹ tai"}, {n:"Nhu Du", t:"Äau vai"}, {n:"ThiÃªn TÃ´ng", t:"Äau vai, Ä‘au báº£ vai"}, {n:"Bá»‰nh Phong", t:"Äau vai, tÃª tay"}, {n:"KhÃºc ViÃªn", t:"Äau vai"}, {n:"KiÃªn Ngoáº¡i Du", t:"Äau vai gÃ¡y"}, {n:"KiÃªn Trung Du", t:"Ho, suyá»…n, Ä‘au vai gÃ¡y"}, {n:"ThiÃªn Song", t:"Äiáº¿c tai, Ä‘au há»ng"}, {n:"ThiÃªn Dung", t:"Ã™ tai, Ä‘au há»ng"}, {n:"Quyá»n LiÃªu", t:"Liá»‡t máº·t, Ä‘au rÄƒng"}, {n:"ThÃ­nh Cung", t:"Ã™ tai, Ä‘iáº¿c tai"}];
        const blData = [
            {n:"TÃ¬nh Minh", t:"Máº¯t Ä‘á», má» máº¯t", c:"VÃ¹ng máº¯t nguy hiá»ƒm."}, {n:"Toáº£n TrÃºc", t:"Äau Ä‘áº§u, máº¯t má»"}, {n:"Mi Xung", t:"Äau Ä‘áº§u"}, {n:"KhÃºc Sai", t:"Äau Ä‘áº§u"}, {n:"NgÅ© Xá»©", t:"Äau Ä‘áº§u"}, {n:"Thá»«a Quang", t:"Äau Ä‘áº§u"}, {n:"ThÃ´ng ThiÃªn", t:"Äau Ä‘áº§u"}, {n:"Láº¡c KhÆ°á»›c", t:"Äau Ä‘áº§u"}, {n:"Ngá»c Cháº©m", t:"Äau Ä‘áº§u"}, {n:"ThiÃªn Trá»¥", t:"Äau sau Ä‘áº§u"}, {n:"Äáº¡i Trá»¯", t:"Ho, sá»‘t"}, {n:"Phong MÃ´n", t:"Cáº£m cÃºm, ho"}, {n:"Pháº¿ Du", t:"Ho, suyá»…n, lao phá»•i", c:"KhÃ´ng chÃ¢m sÃ¢u hÆ°á»›ng phá»•i."}, {n:"Quyáº¿t Ã‚m Du", t:"Äau tim"}, {n:"TÃ¢m Du", t:"Máº¥t ngá»§, hay quÃªn", c:"KhÃ´ng chÃ¢m sÃ¢u hÆ°á»›ng tim."}, {n:"Äá»‘c Du", t:"Äau tim"}, {n:"CÃ¡ch Du", t:"Náº¥c, nÃ´n má»­a"}, {n:"Can Du", t:"VÃ ng da, Ä‘au máº¯t"}, {n:"Äá»Ÿm Du", t:"VÃ ng da, Ä‘áº¯ng miá»‡ng"}, {n:"Tá»³ Du", t:"Äáº§y bá»¥ng, tiÃªu cháº£y"}, {n:"Vá»‹ Du", t:"Äau dáº¡ dÃ y"}, {n:"Tam TiÃªu Du", t:"Äáº§y bá»¥ng, bÃ­ tiá»ƒu"}, {n:"Tháº­n Du", t:"Äau lÆ°ng, Ã¹ tai, di tinh"}, {n:"KhÃ­ Háº£i Du", t:"Äau lÆ°ng"}, {n:"Äáº¡i TrÆ°á»ng Du", t:"Äau lÆ°ng, tÃ¡o bÃ³n"}, {n:"Quan NguyÃªn Du", t:"Äau lÆ°ng"}, {n:"Tiá»ƒu TrÆ°á»ng Du", t:"Äau khá»›p cÃ¹ng cháº­u"}, {n:"BÃ ng Quang Du", t:"BÃ­ tiá»ƒu"}, {n:"Trung Lá»¯ Du", t:"Äau lÆ°ng"}, {n:"Báº¡ch HoÃ n Du", t:"Di tinh, Ä‘Ã¡i dáº§m"}, {n:"ThÆ°á»£ng LiÃªu", t:"Äau lÆ°ng"}, {n:"Thá»© LiÃªu", t:"Äau lÆ°ng"}, {n:"Trung LiÃªu", t:"Äau lÆ°ng"}, {n:"Háº¡ LiÃªu", t:"Äau bá»¥ng dÆ°á»›i"}, {n:"Há»™i DÆ°Æ¡ng", t:"TiÃªu cháº£y, trÄ©"}, {n:"Thá»«a PhÃ¹", t:"Äau tháº§n kinh tá»a"}, {n:"Ã‚n MÃ´n", t:"Äau lÆ°ng"}, {n:"PhÃ¹ KhÃ­ch", t:"Chuá»™t rÃºt"}, {n:"á»¦y DÆ°Æ¡ng", t:"Äau lÆ°ng"}, {n:"á»¦y Trung", t:"Äau lÆ°ng, Ä‘au tháº§n kinh tá»a"}, {n:"Phá»¥ PhÃ¢n", t:"Äau vai gÃ¡y"}, {n:"PhÃ¡ch Há»™", t:"Ho, suyá»…n"}, {n:"Cao Hoang", t:"Ho, suyá»…n, lao phá»•i"}, {n:"Tháº§n ÄÆ°á»ng", t:"Ho, suyá»…n"}, {n:"Y Hy", t:"Ho, suyá»…n"}, {n:"CÃ¡ch Quan", t:"NÃ´n má»­a, náº¥c"}, {n:"Há»“n MÃ´n", t:"Äau dáº¡ dÃ y"}, {n:"DÆ°Æ¡ng CÆ°Æ¡ng", t:"VÃ ng da"}, {n:"Ã XÃ¡", t:"Äáº§y bá»¥ng"}, {n:"Vá»‹ ThÆ°Æ¡ng", t:"Äau dáº¡ dÃ y"}, {n:"Hoang MÃ´n", t:"Äau bá»¥ng"}, {n:"ChÃ­ Tháº¥t", t:"Di tinh, liá»‡t dÆ°Æ¡ng"}, {n:"BÃ o Hoang", t:"BÃ­ tiá»ƒu"}, {n:"Tráº­t BiÃªn", t:"Äau tháº§n kinh tá»a"}, {n:"Há»£p DÆ°Æ¡ng", t:"Äau lÆ°ng"}, {n:"Thá»«a CÃ¢n", t:"Äau báº¯p chÃ¢n"}, {n:"Thá»«a SÆ¡n", t:"Chuá»™t rÃºt, trÄ©"}, {n:"Phi DÆ°Æ¡ng", t:"Äau Ä‘áº§u, Ä‘au lÆ°ng"}, {n:"Phá»¥ DÆ°Æ¡ng", t:"Äau Ä‘áº§u, Ä‘au lÆ°ng"}, {n:"CÃ´n LÃ´n", t:"Äau Ä‘áº§u, Ä‘au lÆ°ng, Ä‘áº» khÃ³", c:"Phá»¥ ná»¯ cÃ³ thai tháº­n trá»ng."}, {n:"Bá»™c Tham", t:"Äau gÃ³t chÃ¢n"}, {n:"ThÃ¢n Máº¡ch", t:"Máº¥t ngá»§, Ä‘au Ä‘áº§u"}, {n:"Kim MÃ´n", t:"Äá»™ng kinh"}, {n:"Kinh Cá»‘t", t:"Äau Ä‘áº§u"}, {n:"ThÃºc Cá»‘t", t:"Äau Ä‘áº§u"}, {n:"ThÃ´ng Cá»‘c", t:"Äau Ä‘áº§u"}, {n:"ChÃ­ Ã‚m", t:"Äáº» khÃ³ (xoay ngÃ´i thai)", c:"CÃ³ thai bÃ¬nh thÆ°á»ng cáº¥m dÃ¹ng (chá»‰ dÃ¹ng khi ngÃ´i ngÆ°á»£c)."}
        ];
        const kiData = [{n:"DÅ©ng Tuyá»n", t:"Ngáº¥t, máº¥t ngá»§"}, {n:"NhiÃªn Cá»‘c", t:"Kinh nguyá»‡t khÃ´ng Ä‘á»u"}, {n:"ThÃ¡i KhÃª", t:"Ã™ tai, máº¥t ngá»§, bá»• tháº­n"}, {n:"Äáº¡i Chung", t:"Ho ra mÃ¡u"}, {n:"Thá»§y Tuyá»n", t:"Kinh nguyá»‡t khÃ´ng Ä‘á»u"}, {n:"Chiáº¿u Háº£i", t:"Máº¥t ngá»§, Ä‘au há»ng"}, {n:"Phá»¥c LÆ°u", t:"PhÃ¹ thÅ©ng, ra má»“ hÃ´i trá»™m"}, {n:"Giao TÃ­n", t:"Rong kinh"}, {n:"TrÃºc TÃ¢n", t:"Giáº£i Ä‘á»™c"}, {n:"Ã‚m Cá»‘c", t:"Liá»‡t dÆ°Æ¡ng"}, {n:"HoÃ nh Cá»‘t", t:"Äau bá»¥ng dÆ°á»›i"}, {n:"Äáº¡i HÃ¡ch", t:"Di tinh, liá»‡t dÆ°Æ¡ng"}, {n:"KhÃ­ Huyá»‡t", t:"Kinh nguyá»‡t khÃ´ng Ä‘á»u"}, {n:"Tá»© MÃ£n", t:"Äau bá»¥ng kinh"}, {n:"Trung ChÃº", t:"TÃ¡o bÃ³n"}, {n:"Hoang Du", t:"Äau dáº¡ dÃ y"}, {n:"ThÆ°Æ¡ng KhÃºc", t:"Äau bá»¥ng"}, {n:"Tháº¡ch Quan", t:"NÃ´n má»­a"}, {n:"Ã‚m ÄÃ´", t:"Äau bá»¥ng"}, {n:"PhÃºc ThÃ´ng Cá»‘c", t:"Äau bá»¥ng"}, {n:"U MÃ´n", t:"Äau dáº¡ dÃ y"}, {n:"Bá»™ Lang", t:"Ho, suyá»…n"}, {n:"Tháº§n Phong", t:"Ho, suyá»…n"}, {n:"Linh KhÆ°", t:"Ho, suyá»…n"}, {n:"Tháº§n TÃ ng", t:"Ho, suyá»…n"}, {n:"Vá»±c Trung", t:"Ho, suyá»…n"}, {n:"Du Phá»§", t:"Ho, suyá»…n"}];
        const pcData = [{n:"ThiÃªn TrÃ¬", t:"Äau ngá»±c, sÆ°ng nÃ¡ch", c:"Cáº¥m chÃ¢m sÃ¢u."}, {n:"ThiÃªn Tuyá»n", t:"Äau tim, Ä‘au ngá»±c"}, {n:"KhÃºc Tráº¡ch", t:"Äau tim, sá»‘t cao"}, {n:"KhÃ­ch MÃ´n", t:"Äau tim cáº¥p"}, {n:"Giáº£n Sá»­", t:"Sá»‘t rÃ©t, Ä‘au tim"}, {n:"Ná»™i Quan", t:"Äau tim, máº¥t ngá»§, nÃ´n má»­a, say tÃ u xe"}, {n:"Äáº¡i LÄƒng", t:"Äau tim, hÃ´i miá»‡ng"}, {n:"Lao Cung", t:"Tim Ä‘áº­p nhanh, hÃ´i miá»‡ng"}, {n:"Trung Xung", t:"TrÃºng giÃ³, hÃ´n mÃª"}];
        const teData = [{n:"Quan Xung", t:"Äau Ä‘áº§u, sá»‘t"}, {n:"Dá»‹ch MÃ´n", t:"Äau Ä‘áº§u, Ä‘iáº¿c tai"}, {n:"Trung Chá»­", t:"Äau Ä‘áº§u, Ã¹ tai"}, {n:"DÆ°Æ¡ng TrÃ¬", t:"Äau cá»• tay"}, {n:"Ngoáº¡i Quan", t:"Äau Ä‘áº§u, sá»‘t, Ä‘au vai gÃ¡y"}, {n:"Chi Cáº¥u", t:"TÃ¡o bÃ³n, Ä‘au sÆ°á»n"}, {n:"Há»™i TÃ´ng", t:"Äiáº¿c tai"}, {n:"Tam DÆ°Æ¡ng Láº¡c", t:"Äiáº¿c tai"}, {n:"Tá»© Äá»™c", t:"Äiáº¿c tai"}, {n:"ThiÃªn Tá»‰nh", t:"Äau vai, Ä‘iáº¿c tai"}, {n:"Thanh LÃ£nh UyÃªn", t:"Äau Ä‘áº§u"}, {n:"TiÃªu Láº¡c", t:"Äau Ä‘áº§u"}, {n:"Nhu Há»™i", t:"Äau vai"}, {n:"KiÃªn LiÃªu", t:"Äau vai"}, {n:"ThiÃªn LiÃªu", t:"Äau vai gÃ¡y"}, {n:"ThiÃªn DÅ©", t:"Cá»©ng cá»•"}, {n:"áº¾ Phong", t:"Ã™ tai, Ä‘iáº¿c tai, liá»‡t máº·t"}, {n:"Kháº¿ Máº¡ch", t:"Äau Ä‘áº§u, Ã¹ tai"}, {n:"LÃ´ Tá»©c", t:"Äau Ä‘áº§u"}, {n:"GiÃ¡c TÃ´n", t:"Äau Ä‘áº§u"}, {n:"NhÄ© MÃ´n", t:"Ã™ tai, Ä‘iáº¿c tai"}, {n:"HÃ²a LiÃªu", t:"Äau Ä‘áº§u, mÃ©o miá»‡ng"}, {n:"Ty TrÃºc KhÃ´ng", t:"Äau Ä‘áº§u, máº¯t giáº­t"}];
        const gbData = [{n:"Äá»“ng Tá»­ LiÃªu", t:"Äau Ä‘áº§u, Ä‘au máº¯t"}, {n:"ThÃ­nh Há»™i", t:"Ã™ tai, Ä‘iáº¿c tai"}, {n:"ThÆ°á»£ng Quan", t:"Äau Ä‘áº§u, Ã¹ tai"}, {n:"HÃ m Yáº¿n", t:"Äau Ä‘áº§u"}, {n:"Huyá»n LÆ°", t:"Äau ná»­a Ä‘áº§u"}, {n:"Huyá»n Ly", t:"Äau ná»­a Ä‘áº§u"}, {n:"KhÃºc Máº¥n", t:"Äau ná»­a Ä‘áº§u"}, {n:"Suáº¥t Cá»‘c", t:"Äau ná»­a Ä‘áº§u, chÃ³ng máº·t"}, {n:"ThiÃªn Xung", t:"Äau Ä‘áº§u"}, {n:"PhÃ¹ Báº¡ch", t:"Äau Ä‘áº§u"}, {n:"Äáº§u Khiáº¿u Ã‚m", t:"Äau Ä‘áº§u"}, {n:"HoÃ n Cá»‘t", t:"Äau Ä‘áº§u, máº¥t ngá»§"}, {n:"Báº£n Tháº§n", t:"Äau Ä‘áº§u"}, {n:"DÆ°Æ¡ng Báº¡ch", t:"Äau Ä‘áº§u, liá»‡t máº·t"}, {n:"Äáº§u LÃ¢m Kháº¥p", t:"Äau Ä‘áº§u"}, {n:"Má»¥c Song", t:"Äau Ä‘áº§u"}, {n:"ChÃ­nh Dinh", t:"Äau Ä‘áº§u"}, {n:"Thá»«a Linh", t:"Äau Ä‘áº§u"}, {n:"NÃ£o KhÃ´ng", t:"Äau Ä‘áº§u"}, {n:"Phong TrÃ¬", t:"Cáº£m máº¡o, Ä‘au Ä‘áº§u, Ä‘au vai gÃ¡y", c:"KhÃ´ng chÃ¢m hÆ°á»›ng lÃªn nÃ£o."}, {n:"KiÃªn Tá»‰nh", t:"Äau vai gÃ¡y, táº¯c tia sá»¯a", c:"Cáº¤M dÃ¹ng cho phá»¥ ná»¯ cÃ³ thai. ChÃ¢m sÃ¢u gÃ¢y trÃ n khÃ­ phá»•i."}, {n:"UyÃªn Dá»‹ch", t:"Äau sÆ°á»n, sÆ°ng nÃ¡ch"}, {n:"Triáº¿p CÃ¢n", t:"Äau sÆ°á»n"}, {n:"Nháº­t Nguyá»‡t", t:"Äau sÆ°á»n"}, {n:"Kinh MÃ´n", t:"Äau bá»¥ng, tiÃªu cháº£y"}, {n:"Äá»›i Máº¡ch", t:"Kinh nguyá»‡t khÃ´ng Ä‘á»u"}, {n:"NgÅ© Khu", t:"Äau bá»¥ng dÆ°á»›i"}, {n:"Duy Äáº¡o", t:"Äau bá»¥ng dÆ°á»›i"}, {n:"Cá»± LiÃªu", t:"Äau khá»›p hÃ¡ng"}, {n:"HoÃ n KhiÃªu", t:"Äau tháº§n kinh tá»a, liá»‡t chÃ¢n"}, {n:"Phong Thá»‹", t:"Liá»‡t chÃ¢n, ngá»©a toÃ n thÃ¢n"}, {n:"Trung Äá»™c", t:"Liá»‡t chÃ¢n"}, {n:"TÃºc DÆ°Æ¡ng Quan", t:"Äau Ä‘áº§u gá»‘i"}, {n:"DÆ°Æ¡ng LÄƒng Tuyá»n", t:"Äau sÆ°á»n, nÃ´n má»­a, thÆ° gÃ¢n"}, {n:"DÆ°Æ¡ng Giao", t:"Äau tháº§n kinh tá»a"}, {n:"Ngoáº¡i KhÃ¢u", t:"Äau cá»•, chÃ¢n Ä‘au"}, {n:"Quang Minh", t:"Máº¯t má», quÃ¡ng gÃ "}, {n:"DÆ°Æ¡ng Phá»¥", t:"Äau ná»­a Ä‘áº§u, Ä‘au chÃ¢n"}, {n:"Huyá»n Chung", t:"Äau cá»• gÃ¡y, liá»‡t chÃ¢n"}, {n:"KhÃ¢u KhÆ°", t:"Äau cá»• chÃ¢n"}, {n:"TÃºc LÃ¢m Kháº¥p", t:"Äau ná»­a Ä‘áº§u, táº¯c tia sá»¯a"}, {n:"Äá»‹a NgÅ© Há»™i", t:"Äau Ä‘áº§u, Ä‘au chÃ¢n"}, {n:"Hiá»‡p KhÃª", t:"Äau Ä‘áº§u, chÃ³ng máº·t"}, {n:"TÃºc Khiáº¿u Ã‚m", t:"Äau Ä‘áº§u, máº¥t ngá»§"}];
        const lrData = [{n:"Äáº¡i ÄÃ´n", t:"ThoÃ¡t vá»‹, bÄƒng huyáº¿t"}, {n:"HÃ nh Gian", t:"Äau Ä‘áº§u, máº¯t Ä‘á», máº¥t ngá»§"}, {n:"ThÃ¡i Xung", t:"Äau Ä‘áº§u, cao huyáº¿t Ã¡p, stress"}, {n:"Trung Phong", t:"Äau bá»¥ng dÆ°á»›i"}, {n:"LÃ£i CÃ¢u", t:"Kinh nguyá»‡t khÃ´ng Ä‘á»u"}, {n:"Trung ÄÃ´", t:"BÄƒng huyáº¿t"}, {n:"Táº¥t Quan", t:"Äau Ä‘áº§u gá»‘i"}, {n:"KhÃºc Tuyá»n", t:"Äau bá»¥ng dÆ°á»›i, bÃ­ tiá»ƒu"}, {n:"Ã‚m Bao", t:"Kinh nguyá»‡t khÃ´ng Ä‘á»u"}, {n:"TÃºc NgÅ© LÃ½", t:"BÃ­ tiá»ƒu"}, {n:"Ã‚m LiÃªm", t:"Kinh nguyá»‡t khÃ´ng Ä‘á»u"}, {n:"Cáº¥p Máº¡ch", t:"ThoÃ¡t vá»‹"}, {n:"ChÆ°Æ¡ng MÃ´n", t:"Äáº§y bá»¥ng, tiÃªu cháº£y"}, {n:"Ká»³ MÃ´n", t:"Äau sÆ°á»n, viÃªm gan", c:"KhÃ´ng chÃ¢m sÃ¢u."}];
        const gvData = [{n:"TrÆ°á»ng CÆ°á»ng", t:"TrÄ©, tiÃªu cháº£y"}, {n:"YÃªu Du", t:"Kinh nguyá»‡t khÃ´ng Ä‘á»u"}, {n:"YÃªu DÆ°Æ¡ng Quan", t:"Äau lÆ°ng, di tinh"}, {n:"Má»‡nh MÃ´n", t:"Äau lÆ°ng, di tinh, liá»‡t dÆ°Æ¡ng"}, {n:"Huyá»n Khu", t:"Äau lÆ°ng, tiÃªu cháº£y"}, {n:"TÃ­ch Trung", t:"Äau dáº¡ dÃ y"}, {n:"Trung Khu", t:"Äau dáº¡ dÃ y"}, {n:"CÃ¢n SÃºc", t:"Äau dáº¡ dÃ y"}, {n:"ChÃ­ DÆ°Æ¡ng", t:"VÃ ng da, suyá»…n"}, {n:"Linh ÄÃ i", t:"Ho, suyá»…n"}, {n:"Tháº§n Äáº¡o", t:"Máº¥t ngá»§, hay quÃªn"}, {n:"ThÃ¢n Trá»¥", t:"Ho, suyá»…n"}, {n:"ÄÃ o Äáº¡o", t:"Sá»‘t rÃ©t"}, {n:"Äáº¡i ChÃ¹y", t:"Sá»‘t cao, cáº£m cÃºm"}, {n:"Ã MÃ´n", t:"CÃ¢m Ä‘iáº¿c, cá»©ng gÃ¡y", c:"Cáº¤M chÃ¢m sÃ¢u (gÃ¢y ngá»«ng thá»Ÿ)."}, {n:"Phong Phá»§", t:"Äau Ä‘áº§u, cá»©ng gÃ¡y", c:"Cáº¤M chÃ¢m sÃ¢u."}, {n:"NÃ£o Há»™", t:"Äau Ä‘áº§u"}, {n:"CÆ°á»ng Gian", t:"Äau Ä‘áº§u"}, {n:"Háº­u Äá»‰nh", t:"Äau Ä‘áº§u"}, {n:"BÃ¡ch Há»™i", t:"Äau Ä‘áº§u, sa trá»±c trÃ ng, máº¥t ngá»§"}, {n:"Tiá»n Äá»‰nh", t:"Äau Ä‘áº§u"}, {n:"TÃ­n Há»™i", t:"Äau Ä‘áº§u"}, {n:"ThÆ°á»£ng Tinh", t:"Äau Ä‘áº§u, cháº£y mÃ¡u cam"}, {n:"Tháº§n ÄÃ¬nh", t:"Äau Ä‘áº§u, máº¥t ngá»§"}, {n:"Tá»‘ LiÃªu", t:"Ngáº¡t mÅ©i, ngáº¥t"}, {n:"NhÃ¢n Trung", t:"Ngáº¥t, trÃºng giÃ³, mÃ©o miá»‡ng"}, {n:"ÄoÃ i Äoan", t:"Äau rÄƒng"}, {n:"NgÃ¢n Giao", t:"Äau rÄƒng"}];
        const cvData = [{n:"Há»™i Ã‚m", t:"Kinh nguyá»‡t khÃ´ng Ä‘á»u, cháº¿t Ä‘uá»‘i"}, {n:"KhÃºc Cá»‘t", t:"BÃ­ tiá»ƒu, di tinh"}, {n:"Trung Cá»±c", t:"BÃ­ tiá»ƒu, Ä‘au bá»¥ng kinh"}, {n:"Quan NguyÃªn", t:"Di tinh, tiá»ƒu dáº§m, bá»• tháº­n khÃ­"}, {n:"Tháº¡ch MÃ´n", t:"Äau bá»¥ng, bÃ­ tiá»ƒu", c:"Phá»¥ ná»¯ cÃ³ thai cáº¥m dÃ¹ng."}, {n:"KhÃ­ Háº£i", t:"Äau bá»¥ng, suy nhÆ°á»£c, bá»• khÃ­"}, {n:"Ã‚m Giao", t:"Äau bá»¥ng"}, {n:"Tháº§n Khuyáº¿t", t:"Äau bá»¥ng, trÃºng giÃ³", c:"Cáº¤M chÃ¢m, chá»‰ cá»©u."}, {n:"Thá»§y PhÃ¢n", t:"PhÃ¹ thÅ©ng"}, {n:"Háº¡ Quáº£n", t:"Äau dáº¡ dÃ y"}, {n:"Kiáº¿n LÃ½", t:"Äau dáº¡ dÃ y"}, {n:"Trung Quáº£n", t:"Äau dáº¡ dÃ y, nÃ´n má»­a"}, {n:"ThÆ°á»£ng Quáº£n", t:"Äau dáº¡ dÃ y"}, {n:"Cá»± Khuyáº¿t", t:"Äau dáº¡ dÃ y, Ä‘au tim"}, {n:"CÆ°u VÄ©", t:"Äau tim"}, {n:"Trung ÄÃ¬nh", t:"Äáº§y ngá»±c"}, {n:"Äáº£n Trung", t:"Hen suyá»…n, Ä‘au ngá»±c, Ã­t sá»¯a"}, {n:"Ngá»c ÄÆ°á»ng", t:"Ho, suyá»…n"}, {n:"Tá»­ Cung", t:"Ho, suyá»…n"}, {n:"Hoa CÃ¡i", t:"Ho, suyá»…n"}, {n:"ToÃ n CÆ¡", t:"Ho, suyá»…n"}, {n:"ThiÃªn Äá»™t", t:"Ho, suyá»…n, Ä‘au há»ng", c:"ChÃ¢m cáº©n tháº­n trÃ¡nh khÃ­ quáº£n."}, {n:"LiÃªm Tuyá»n", t:"LÆ°á»¡i cá»©ng, máº¥t tiáº¿ng"}, {n:"Thá»«a TÆ°Æ¡ng", t:"MÃ©o miá»‡ng, Ä‘au rÄƒng"}];

        const defaultAcupoints = [
            ...createPoints("LU", "Pháº¿ Kinh", luData),
            ...createPoints("LI", "Äáº¡i TrÆ°á»ng Kinh", liData),
            ...createPoints("ST", "Vá»‹ Kinh", stData),
            ...createPoints("SP", "Tá»³ Kinh", spData),
            ...createPoints("HT", "TÃ¢m Kinh", htData),
            ...createPoints("SI", "Tiá»ƒu TrÆ°á»ng Kinh", siData),
            ...createPoints("BL", "BÃ ng Quang Kinh", blData),
            ...createPoints("KI", "Tháº­n Kinh", kiData),
            ...createPoints("PC", "TÃ¢m BÃ o Kinh", pcData),
            ...createPoints("TE", "Tam TiÃªu Kinh", teData),
            ...createPoints("GB", "Äá»Ÿm Kinh", gbData),
            ...createPoints("LR", "Can Kinh", lrData),
            ...createPoints("GV", "Máº¡ch Äá»‘c", gvData),
            ...createPoints("CV", "Máº¡ch NhÃ¢m", cvData)
        ];

        // --- COMBO PRESCRIPTIONS DATA ---
        const combos = [
            { title: "Äau Äáº§u (Cáº£m máº¡o)", points: ["Há»£p Cá»‘c", "ThÃ¡i DÆ°Æ¡ng", "Phong TrÃ¬", "BÃ¡ch Há»™i"], desc: "Giáº£m Ä‘au Ä‘áº§u do trÃºng giÃ³, cáº£m láº¡nh, cÄƒng tháº³ng." },
            { title: "Máº¥t Ngá»§", points: ["Tháº§n MÃ´n", "Tam Ã‚m Giao", "Ná»™i Quan", "DÅ©ng Tuyá»n"], desc: "GiÃºp an tháº§n, dá»… ngá»§, ngá»§ sÃ¢u giáº¥c." },
            { title: "Äau Dáº¡ DÃ y", points: ["Trung Quáº£n", "TÃºc Tam LÃ½", "Ná»™i Quan"], desc: "Giáº£m Ä‘au bá»¥ng, Ä‘áº§y hÆ¡i, khÃ³ tiÃªu." },
            { title: "Say TÃ u Xe", points: ["Ná»™i Quan", "Há»£p Cá»‘c"], desc: "Báº¥m trÆ°á»›c vÃ  trong khi Ä‘i xe Ä‘á»ƒ giáº£m buá»“n nÃ´n." },
            { title: "Äau LÆ°ng", points: ["Tháº­n Du", "á»¦y Trung", "Äáº¡i TrÆ°á»ng Du"], desc: "Giáº£m Ä‘au má»i tháº¯t lÆ°ng." },
            { title: "Äau Vai GÃ¡y", points: ["Phong TrÃ¬", "KiÃªn Tá»‰nh", "Äáº¡i ChÃ¹y", "Liá»‡t Khuyáº¿t"], desc: "ThÆ° giÃ£n cÆ¡ vai, giáº£m cá»©ng cá»•." },
            { title: "Háº¡ Sá»‘t", points: ["Há»£p Cá»‘c", "KhÃºc TrÃ¬", "Äáº¡i ChÃ¹y"], desc: "Há»— trá»£ háº¡ nhiá»‡t Ä‘á»™ cÆ¡ thá»ƒ." },
            { title: "TÃ¡o BÃ³n", points: ["ThiÃªn Khu", "Chi Cáº¥u", "TÃºc Tam LÃ½"], desc: "KÃ­ch thÃ­ch nhu Ä‘á»™ng ruá»™t." },
            { title: "Äau Bá»¥ng Kinh", points: ["Tam Ã‚m Giao", "Huyáº¿t Háº£i", "Quan NguyÃªn"], desc: "Giáº£m Ä‘au bá»¥ng khi Ä‘áº¿n ká»³." }
        ];

        // ELEMENTS
        const els = {
            loading: document.getElementById('loading'),
            loginScreen: document.getElementById('login-screen'),
            loginTitle: document.getElementById('loginTitle'),
            loginMsg: document.getElementById('loginMsg'),
            btnLogin: document.getElementById('btnLogin'),
            btnLoginHeader: document.getElementById('btnLoginHeader'),
            btnLogout: document.getElementById('btnLogout'),
            userAvatar: document.getElementById('userAvatar'),
            // Header Info
            headerUserInfo: document.getElementById('headerUserInfo'),
            displayUserName: document.getElementById('displayUserName'),
            displayUserTitle: document.getElementById('displayUserTitle'),
            
            navItems: document.querySelectorAll('.nav-item'),
            views: document.querySelectorAll('.view'),
            // Manage
            inpGroup: document.getElementById('inpGroup'),
            inpName: document.getElementById('inpName'),
            inpDesc: document.getElementById('inpDesc'),
            inpTreats: document.getElementById('inpTreats'), // New Input
            btnAddData: document.getElementById('btnAddData'),
            libraryContent: document.getElementById('libraryContent'),
            libSearch: document.getElementById('libSearch'),
            libFilter: document.getElementById('libFilter'),
            groupSuggestions: document.getElementById('groupSuggestions'),
            // Modal
            detailModal: document.getElementById('detailModal'),
            modalCode: document.getElementById('modalCode'),
            modalName: document.getElementById('modalName'),
            modalGroup: document.getElementById('modalGroup'),
            modalDesc: document.getElementById('modalDesc'),
            modalTreatsContainer: document.getElementById('modalTreatsContainer'), 
            modalCaution: document.getElementById('modalCaution'), // Caution Box
            modalCautionText: document.getElementById('modalCautionText'), // Caution Text
            modalSearchBtn: document.getElementById('modalSearchBtn'),
            // Modal Edit Elements
            btnEditModal: document.getElementById('btnEditModal'),
            modalViewContent: document.getElementById('modalViewContent'),
            modalEditContent: document.getElementById('modalEditContent'),
            editGroup: document.getElementById('editGroup'),
            editName: document.getElementById('editName'),
            editTreats: document.getElementById('editTreats'),
            editDesc: document.getElementById('editDesc'),
            btnSaveEdit: document.getElementById('btnSaveEdit'),

            // Quiz
            quizGroupSelect: document.getElementById('quizGroupSelect'),
            qGroup: document.getElementById('qGroup'),
            qQuestion: document.getElementById('qQuestion'),
            qDesc: document.getElementById('qDesc'),
            qInput: document.getElementById('qInput'),
            btnSearchImg: document.getElementById('btnSearchImg'),
            qFeedback: document.getElementById('qFeedback'),
            btnShowAns: document.getElementById('btnShowAns'),
            btnHint: document.getElementById('btnHint'),
            btnNext: document.getElementById('btnNext'),
            quizArea: document.getElementById('quizArea'),
            emptyQuizMsg: document.getElementById('emptyQuizMsg'),
            emptyMsgText: document.getElementById('emptyMsgText'),
            btnInitData: document.getElementById('btnInitData'),
            limitCounter: document.getElementById('limitCounter'),
            // Stats & Cal
            statStreak: document.getElementById('stat-streak'),
            statMastered: document.getElementById('stat-mastered'),
            leaderboardList: document.getElementById('leaderboardList'),
            calendarGrid: document.getElementById('calendarGrid'),
            viewWeek: document.getElementById('viewWeek'),
            viewMonth: document.getElementById('viewMonth'),
            // Combos
            comboList: document.getElementById('comboList'),
            // Badges
            badges: {
                novice: document.getElementById('badge-novice'),
                master5: document.getElementById('badge-master5'),
                streak3: document.getElementById('badge-streak3'),
                streak7: document.getElementById('badge-streak7'),
                streak14: document.getElementById('badge-streak14'),
                streak30: document.getElementById('badge-streak30'),
                master20: document.getElementById('badge-master20'),
                master50: document.getElementById('badge-master50')
            }
        };

        // --- UTILS ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(type) {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().catch(e => console.log("Audio resume needed interaction"));
            }
            try {
                const osc = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                osc.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                if (type === 'correct') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.4);
                } else {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                    osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.2);
                }
            } catch (e) { console.log("Audio error", e); }
        }

        function cleanText(str) {
            if (!str) return "";
            str = str.toLowerCase().normalize("NFC");
            str = str.replace(/Ã |Ã¡|áº¡|áº£|Ã£|Ã¢|áº§|áº¥|áº­|áº©|áº«|Äƒ|áº±|áº¯|áº·|áº³|áºµ/g, "a");
            str = str.replace(/Ã¨|Ã©|áº¹|áº»|áº½|Ãª|á»|áº¿|á»‡|á»ƒ|á»…/g, "e");
            str = str.replace(/Ã¬|Ã­|á»‹|á»‰|Ä©/g, "i");
            str = str.replace(/Ã²|Ã³|á»|á»|Ãµ|Ã´|á»“|á»‘|á»™|á»•|á»—|Æ¡|á»|á»›|á»£|á»Ÿ|á»¡/g, "o");
            str = str.replace(/Ã¹|Ãº|á»¥|á»§|Å©|Æ°|á»«|á»©|á»±|á»­|á»¯/g, "u");
            str = str.replace(/á»³|Ã½|á»µ|á»·|á»¹/g, "y");
            str = str.replace(/Ä‘/g, "d");
            str = str.replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9\s]/g, ""); 
            return str.trim();
        }

        // --- AUTH ---
        function showLoginScreen(isForced = false) {
            els.loginScreen.style.display = 'flex';
            if(isForced) {
                els.loginTitle.textContent = "Thuá»‘c háº¿t háº¡n, Ä‘áº¡i hiá»‡p 'thoÃ¡t vá»‹' khá»i game";
                els.loginMsg.textContent = "Äáº¡i hiá»‡p Ä‘Ã£ luyá»‡n Ä‘á»§ 10 chiÃªu. Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ tiáº¿p tá»¥c con Ä‘Æ°á»ng y Ä‘áº¡o.";
            } else {
                els.loginTitle.textContent = "Nháº­p MÃ´n";
                els.loginMsg.textContent = "ÄÄƒng nháº­p Ä‘á»ƒ lÆ°u bÃ­ kÃ­p vÃ  tranh Ä‘oáº¡t ngÃ´i vá»‹ Minh Chá»§";
            }
        }

        els.btnLogin.addEventListener('click', () => signInWithPopup(auth, provider).catch(err => showToast("Lá»—i: " + err.message)));
        els.btnLoginHeader.addEventListener('click', () => showLoginScreen(false));
        els.btnLogout.addEventListener('click', () => { signOut(auth); location.reload(); });

        onAuthStateChanged(auth, async (user) => {
            els.loginScreen.style.display = 'none';
            if (user) {
                isGuest = false; currentUser = user;
                els.userAvatar.src = user.photoURL;
                els.btnLogout.style.display = 'inline-block'; els.btnLoginHeader.style.display = 'none';
                els.headerUserInfo.style.display = 'block';
                els.displayUserName.textContent = user.displayName;
                
                showLoading(true);
                try {
                    await Promise.all([loadData(), checkAttendance(), loadLeaderboard()]);
                } catch(e) { console.error("Load error:", e); }
                showLoading(false);
                showToast(`ChÃ o má»«ng ${user.displayName} BÃ¡c sÄ© tÆ°Æ¡ng lai!`);
            } else {
                isGuest = true; currentUser = null; guestQuizCount = 0;
                els.btnLogout.style.display = 'none'; els.btnLoginHeader.style.display = 'inline-block';
                els.headerUserInfo.style.display = 'none'; 
                els.limitCounter.style.display = 'inline-block';
                els.limitCounter.textContent = `(0/${GUEST_LIMIT})`;
                
                const localData = localStorage.getItem('guest_acupoints');
                if (localData) { acupoints = JSON.parse(localData); } 
                else { acupoints = defaultAcupoints.map((item, index) => ({ id: 'guest_' + index, ...item, srsLevel: 0, nextReview: 0 })); }
                renderListGrouped(); updateGroupSelect(); prepareQuiz();
                
                startQuiz();
            }
            setupNavigation(); renderCalendar(); updateBadges(); renderCombos();
        });

        function showLoading(show) { els.loading.style.display = show ? 'flex' : 'none'; }
        function showToast(message) {
            const x = document.getElementById("toast"); x.textContent = message;
            x.className = "show"; setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- DATA LOGIC ---
        async function loadData() {
            if(isGuest) return;
            try {
                const q = query(collection(db, "acupoints"), where("uid", "==", currentUser.uid));
                const snap = await getDocs(q);
                acupoints = [];
                snap.forEach((doc) => acupoints.push({ id: doc.id, ...doc.data() }));
                renderListGrouped(); updateGroupSelect(); prepareQuiz();
                
                startQuiz();
            } catch (e) { console.error(e); }
        }

        // --- LIBRARY RENDER ---
        function renderListGrouped() {
            els.libraryContent.innerHTML = '';
            const groups = {};
            let masteredCount = 0;
            const filterText = els.libSearch.value.trim().toLowerCase();
            const filterType = els.libFilter.value;

            acupoints.forEach(item => {
                const level = item.srsLevel || 0;
                if(level >= 4) masteredCount++;
                
                // Smart Search: Check name, code, TREATS, GROUP
                const name = item.name ? item.name.toLowerCase() : "";
                const code = name.split(' ')[0] || "";
                const treats = item.treats ? item.treats.toLowerCase() : "";
                const group = item.group ? item.group.toLowerCase() : "";

                if(filterText && !name.includes(filterText) && !code.includes(filterText) && !treats.includes(filterText) && !group.includes(filterText)) return;
                
                // Type filter
                if(filterType === 'learned' && level < 1) return;
                if(filterType === 'new' && level > 0) return;

                if(!groups[item.group]) groups[item.group] = [];
                groups[item.group].push(item);
            });

            els.statMastered.textContent = masteredCount;

            const groupKeys = Object.keys(groups).sort();
            
            if(groupKeys.length === 0) {
                els.libraryContent.innerHTML = '<div style="text-align:center; padding:30px; color:#9ca3af;">KhÃ´ng tÃ¬m tháº¥y bÃ­ kÃ­p nÃ o.</div>';
                return;
            }

            // Accordion Rendering
            groupKeys.forEach(gName => {
                const groupItems = groups[gName];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'accordion-item';

                // Header
                const header = document.createElement('div');
                header.className = 'accordion-header';
                header.innerHTML = `<span>${gName} (${groupItems.length})</span> <span>â–¼</span>`;
                header.onclick = () => {
                    const content = itemDiv.querySelector('.accordion-content');
                    const isActive = header.classList.contains('active');
                    if(isActive) {
                        header.classList.remove('active');
                        content.classList.remove('open');
                        header.lastElementChild.textContent = 'â–¼';
                    } else {
                        header.classList.add('active');
                        content.classList.add('open');
                        header.lastElementChild.textContent = 'â–²';
                    }
                };

                // Content Grid
                const content = document.createElement('div');
                content.className = 'accordion-content';
                
                if(filterText) {
                    header.classList.add('active');
                    content.classList.add('open');
                    header.lastElementChild.textContent = 'â–²';
                }

                groupItems.forEach(item => {
                    const level = item.srsLevel || 0;
                    const card = document.createElement('div');
                    card.className = 'lib-card';
                    card.onclick = (e) => {
                        if(e.target.classList.contains('lib-del')) return;
                        openDetail(item);
                    };

                    const parts = item.name.split(' ');
                    const code = parts[0];
                    const realName = parts.slice(1).join(' ');

                    let lvText = level >= 4 ? 'â­ ÄÃ£ thuá»™c' : (level > 0 ? `ğŸ”¥ Táº§ng ${level}` : 'ğŸŒ± ChÆ°a há»c');
                    
                    // Generate Treats Tags for Library view
                    let treatsHtml = '';
                    if(item.treats) {
                        const tags = item.treats.split(',').slice(0, 2); // Show max 2 tags
                        tags.forEach(t => {
                            treatsHtml += `<span class="tag-treat">${t.trim()}</span>`;
                        });
                        if(item.treats.split(',').length > 2) treatsHtml += `<span class="tag-treat">...</span>`;
                    }
                    
                    // Caution indicator
                    let cautionHtml = '';
                    if(item.caution) {
                        cautionHtml = '<div class="caution-icon" title="Cáº£nh bÃ¡o">âš ï¸</div>';
                    }

                    card.innerHTML = `
                        ${cautionHtml}
                        <div class="lib-code">${code}</div>
                        <div class="lib-name">${realName}</div>
                        <div>${treatsHtml}</div>
                        <div class="lib-srs">${lvText}</div>
                        <button class="lib-del" onclick="deleteAcupoint('${item.id}')">&times;</button>
                    `;
                    content.appendChild(card);
                });

                itemDiv.appendChild(header);
                itemDiv.appendChild(content);
                els.libraryContent.appendChild(itemDiv);
            });
        }

        // --- FILTER EVENTS ---
        els.libSearch.addEventListener('input', renderListGrouped);
        els.libFilter.addEventListener('change', renderListGrouped);

        // --- DETAIL MODAL & EDIT FEATURE ---
        window.toggleEditMode = (isEdit) => {
            if(isEdit) {
                els.modalViewContent.style.display = 'none';
                els.modalEditContent.style.display = 'block';
                // Populate inputs
                if(currentEditingItem) {
                    els.editGroup.value = currentEditingItem.group || "";
                    els.editName.value = currentEditingItem.name || "";
                    els.editTreats.value = currentEditingItem.treats || "";
                    els.editDesc.value = currentEditingItem.desc || "";
                }
            } else {
                els.modalViewContent.style.display = 'block';
                els.modalEditContent.style.display = 'none';
            }
        }

        els.btnEditModal.addEventListener('click', () => {
            if(isGuest) return showToast("KhÃ¡ch khÃ´ng Ä‘Æ°á»£c sá»­a bÃ­ kÃ­p gia truyá»n!");
            toggleEditMode(true);
        });

        els.btnSaveEdit.addEventListener('click', async () => {
            if(!currentEditingItem) return;
            const newGroup = els.editGroup.value.trim();
            const newName = els.editName.value.trim();
            const newTreats = els.editTreats.value.trim();
            const newDesc = els.editDesc.value.trim();

            if(!newGroup || !newName) return showToast("TÃªn vÃ  NhÃ³m khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng!");
            
            showLoading(true);
            try {
                // Update Firestore
                const itemRef = doc(db, "acupoints", currentEditingItem.id);
                await updateDoc(itemRef, {
                    group: newGroup,
                    name: newName,
                    treats: newTreats,
                    desc: newDesc
                });

                // Update Local Data
                currentEditingItem.group = newGroup;
                currentEditingItem.name = newName;
                currentEditingItem.treats = newTreats;
                currentEditingItem.desc = newDesc;

                // Refresh UI
                renderListGrouped();
                updateGroupSelect();
                
                // Refresh Modal View
                openDetail(currentEditingItem); 
                showToast("âœ… ÄÃ£ cáº­p nháº­t thÃ nh cÃ´ng!");
            } catch(e) {
                console.error(e);
                showToast("Lá»—i khi lÆ°u: " + e.message);
            }
            showLoading(false);
        });

        function openDetail(item) {
            currentEditingItem = item;
            // Reset to view mode
            toggleEditMode(false);

            els.modalCode.textContent = item.name.split(' ')[0];
            els.modalName.textContent = item.name;
            els.modalGroup.textContent = `Thuá»™c: ${item.group}`;
            els.modalDesc.textContent = item.desc || "ChÆ°a cÃ³ mÃ´ táº£.";
            
            // Render Treats Tags in Modal
            els.modalTreatsContainer.innerHTML = '';
            if(item.treats) {
                const tags = item.treats.split(',');
                tags.forEach(t => {
                    if(t.trim()) {
                        const span = document.createElement('span');
                        span.className = 'tag-treat';
                        span.style.fontSize = '0.85rem';
                        span.style.padding = '4px 8px';
                        span.textContent = t.trim();
                        els.modalTreatsContainer.appendChild(span);
                    }
                });
            } else {
                els.modalTreatsContainer.innerHTML = '<span style="font-size:0.8rem; color:#999;">ChÆ°a cáº­p nháº­t chá»§ trá»‹</span>';
            }

            // Render Caution
            if(item.caution) {
                els.modalCaution.style.display = 'flex';
                els.modalCautionText.textContent = item.caution;
            } else {
                els.modalCaution.style.display = 'none';
            }

            els.detailModal.classList.add('show');
            
            els.modalSearchBtn.onclick = () => {
                 const query = encodeURIComponent(`huyá»‡t ${item.name} vá»‹ trÃ­`);
                 window.open(`https://www.google.com/search?tbm=isch&q=${query}`, '_blank');
            };
        }

        window.initDefaultData = async () => {
            if(isGuest) return showToast("Dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t cho cÃ¡c háº¡.");
            if(acupoints.length > 0 && !confirm("Dá»¯ liá»‡u hiá»‡n táº¡i sáº½ Ä‘Æ°á»£c thay tháº¿ báº±ng 361 huyá»‡t chuáº©n. Tiáº¿p tá»¥c?")) return;
            showLoading(true);
            try {
                const batch = writeBatch(db);
                defaultAcupoints.forEach(item => {
                    const docRef = doc(collection(db, "acupoints"));
                    batch.set(docRef, {
                        uid: currentUser.uid, group: item.group, name: item.name, desc: item.desc, image: "",
                        treats: item.treats || "", caution: item.caution || "",
                        srsLevel: 0, nextReview: 0, createdAt: serverTimestamp()
                    });
                });
                await batch.commit(); await loadData();
                showToast("âœ… ÄÃ£ náº¡p 361 huyá»‡t Ä‘áº¡o!");
                document.querySelector('[data-target="tab-quiz"]').click();
            } catch(e) { showToast("Lá»—i: " + e.message); }
            showLoading(false);
        }

        els.btnAddData.addEventListener('click', async () => {
            if(isGuest) return showToast("ÄÄƒng nháº­p Ä‘á»ƒ lÆ°u bÃ­ kÃ­p cá»§a riÃªng báº¡n.");
            const group = els.inpGroup.value.trim();
            const name = els.inpName.value.trim();
            const treats = els.inpTreats.value.trim(); // Capture Treats
            const desc = els.inpDesc.value.trim();

            if(!group || !name) return showToast("Thiáº¿u tÃªn hoáº·c nhÃ³m!");
            showLoading(true);
            try {
                const docRef = await addDoc(collection(db, "acupoints"), {
                    uid: currentUser.uid, group, name, treats, desc, image:"", srsLevel: 0, nextReview: 0, createdAt: serverTimestamp()
                });
                acupoints.push({ id: docRef.id, uid: currentUser.uid, group, name, treats, desc, image:"", srsLevel: 0, nextReview: 0 });
                els.inpName.value = ''; els.inpDesc.value = ''; els.inpTreats.value = '';
                renderListGrouped(); updateGroupSelect(); prepareQuiz(); showToast("ÄÃ£ lÆ°u!");
            } catch (e) { showToast("Lá»—i lÆ°u."); }
            showLoading(false);
        });

        window.deleteAcupoint = async (id) => {
            if(isGuest) return showToast("KhÃ¡ch khÃ´ng thá»ƒ xÃ³a dá»¯ liá»‡u máº«u.");
            if(!confirm("XÃ³a huyá»‡t nÃ y?")) return;
            showLoading(true);
            try {
                await deleteDoc(doc(db, "acupoints", id));
                acupoints = acupoints.filter(item => item.id !== id);
                renderListGrouped(); updateGroupSelect(); prepareQuiz(); showToast("ÄÃ£ xÃ³a.");
            } catch (e) { showToast("Lá»—i xÃ³a."); }
            showLoading(false);
        }

        // --- COMBO PRESCRIPTION LOGIC ---
        function renderCombos() {
            els.comboList.innerHTML = '';
            combos.forEach(combo => {
                const card = document.createElement('div');
                card.className = 'combo-card';
                card.onclick = () => {
                    // Could add logic to open a detail view of the combo, 
                    // for now just toggle open simple details
                };

                const pointsHtml = combo.points.map(p => {
                    // Find actual point code/name matching
                    const match = acupoints.find(ap => ap.name.includes(p));
                    // Basic click logic to open detail if found
                    const clickAttr = match ? `onclick="event.stopPropagation(); window.findAndOpen('${match.id}')"` : "";
                    return `<span class="combo-tag" ${clickAttr} style="${match?'cursor:pointer':''}">${p}</span>`;
                }).join('');

                card.innerHTML = `
                    <div class="combo-title">ğŸ’Š ${combo.title}</div>
                    <div style="font-size:0.9rem; color:#6b7280;">${combo.desc}</div>
                    <div class="combo-points">
                        ${pointsHtml}
                    </div>
                `;
                els.comboList.appendChild(card);
            });
        }
        
        // Helper to open detail from Combo
        window.findAndOpen = (id) => {
            const item = acupoints.find(i => i.id === id);
            if(item) openDetail(item);
        }

        // --- QUIZ LOGIC ---
        function prepareQuiz() {
            if(acupoints.length > 0) {
                els.quizArea.style.display = 'block'; els.emptyQuizMsg.style.display = 'none';
            } else {
                els.quizArea.style.display = 'none'; els.emptyQuizMsg.style.display = 'block';
                els.btnInitData.style.display = isGuest ? 'none' : 'inline-flex';
            }
        }

        function startQuiz() {
            isProcessing = false;
            if (!document.getElementById('tab-quiz').classList.contains('active')) return;

            if(isGuest && guestQuizCount >= GUEST_LIMIT) { showLoginScreen(true); return; }

            const filter = els.quizGroupSelect.value;
            const now = Date.now();
            let pool = acupoints.filter(i => {
                const matchGroup = (filter === 'all' || i.group === filter);
                const isDue = (i.nextReview || 0) <= now;
                return matchGroup && isDue;
            });
            
            if (pool.length === 0) {
                 els.quizArea.style.display = 'none'; els.emptyQuizMsg.style.display = 'block'; return;
            } else {
                els.quizArea.style.display = 'block'; els.emptyQuizMsg.style.display = 'none';
            }
            
            pool.sort((a, b) => (a.nextReview || 0) - (b.nextReview || 0));
            // Random safely
            const safeMax = Math.min(3, pool.length);
            const idx = safeMax > 0 ? Math.floor(Math.random() * safeMax) : 0;
            currentQuizItem = pool[idx];
            currentHintIndex = 0;

            els.qGroup.textContent = currentQuizItem.group;
            els.qQuestion.textContent = "Huyá»‡t nÃ y tÃªn lÃ  gÃ¬?";
            els.qDesc.textContent = currentQuizItem.desc;
            els.qInput.value = '';
            els.qInput.focus();
            els.qFeedback.textContent = ''; els.qFeedback.className = 'feedback';
        }

        els.btnSearchImg.addEventListener('click', () => {
            if(!currentQuizItem) return;
            const query = encodeURIComponent(`huyá»‡t ${currentQuizItem.name} vá»‹ trÃ­`);
            window.open(`https://www.google.com/search?tbm=isch&q=${query}`, '_blank');
        });

        async function handleAnswer(isCorrect) {
            if(!currentQuizItem) return;
            const oldLevel = currentQuizItem.srsLevel || 0;
            let newLevel = oldLevel; let nextReview = 0;

            if (isCorrect) {
                newLevel = Math.min(oldLevel + 1, SRS_INTERVALS.length - 1);
                const days = SRS_INTERVALS[newLevel];
                nextReview = Date.now() + (days * 24 * 60 * 60 * 1000);
                playTone('correct');
                els.qFeedback.innerHTML = "ğŸ‰ Tuyá»‡t vá»i! ChÃ­nh xÃ¡c!";
                els.qFeedback.className = 'feedback correct';
                if(Math.random() > 0.7 && typeof confetti === 'function') {
                    confetti({ particleCount: 60, spread: 70, origin: { y: 0.6 } });
                }
            } else {
                newLevel = 0; nextReview = Date.now();
                playTone('wrong');
                els.qFeedback.innerHTML = `Sai rá»“i: <b>${currentQuizItem.name}</b>`;
                els.qFeedback.className = 'feedback wrong';
            }

            if(isGuest) {
                guestQuizCount++;
                els.limitCounter.textContent = `(${guestQuizCount}/${GUEST_LIMIT})`;
                currentQuizItem.srsLevel = newLevel; currentQuizItem.nextReview = nextReview;
                localStorage.setItem('guest_acupoints', JSON.stringify(acupoints));
            } else {
                try {
                    const itemRef = doc(db, "acupoints", currentQuizItem.id);
                    await updateDoc(itemRef, { srsLevel: newLevel, nextReview: nextReview });
                    currentQuizItem.srsLevel = newLevel; currentQuizItem.nextReview = nextReview;
                } catch(e) { console.error(e); }
            }

            if(isCorrect) {
                tryAutoCheckIn(); setTimeout(() => { startQuiz(); }, 1000);
            }
        }

        els.qInput.addEventListener('input', () => {
            if(!currentQuizItem || isProcessing) return;
            const inputClean = cleanText(els.qInput.value);
            const targetClean = cleanText(currentQuizItem.name);
            const nameParts = currentQuizItem.name.split(' ');
            const realNameClean = cleanText(nameParts.slice(1).join(' '));
            
            if ((inputClean.length >= 2 && inputClean === targetClean) || 
                (inputClean.length >= 2 && inputClean === realNameClean)) {
                isProcessing = true;
                handleAnswer(true);
            }
        });

        els.qInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') {
                if (!isProcessing) els.btnShowAns.click();
            }
        });

        els.quizGroupSelect.addEventListener('change', startQuiz);
        els.btnNext.addEventListener('click', startQuiz);
        els.btnShowAns.addEventListener('click', () => {
            if(!currentQuizItem || isProcessing) return;
            isProcessing = true;
            handleAnswer(false);
            setTimeout(() => { isProcessing = false; els.qInput.value = currentQuizItem.name; }, 500);
        });
        
        els.btnHint.addEventListener('click', () => {
            if(!currentQuizItem) return;
            const name = currentQuizItem.name;
            if(currentHintIndex < name.length) {
                currentHintIndex++;
                els.qInput.value = name.substring(0, currentHintIndex);
                els.qInput.focus();
                els.qInput.dispatchEvent(new Event('input'));
            }
        });

        // --- STATS & BADGES ---
        async function checkAttendance() {
            if(isGuest) { els.statStreak.textContent = "0"; return; }
            try {
                const today = new Date().toISOString().split('T')[0];
                const q = query(collection(db, "attendance"), where("uid", "==", currentUser.uid));
                const snap = await getDocs(q);
                attendanceDates.clear(); snap.forEach(doc => attendanceDates.add(doc.data().date));
                const streakCount = attendanceDates.size;
                todayCheckedIn = attendanceDates.has(today);
                els.statStreak.textContent = streakCount;
                updateBadges(streakCount);

                els.displayUserTitle.textContent = currentTitle;

                await setDoc(doc(db, "profiles", currentUser.uid), {
                    displayName: currentUser.displayName, streak: streakCount, 
                    photoURL: currentUser.photoURL, lastActive: serverTimestamp(),
                    title: currentTitle
                }, { merge: true });
            } catch(e) { console.error("Attendance check fail", e); }
        }

        function updateBadges(streak = 0) {
            els.badges.novice.classList.add('unlocked');
            currentTitle = "Lang BÄƒm Táº­p Sá»±"; 

            const mastered = acupoints.filter(i => (i.srsLevel || 0) >= 4).length;

            if (mastered >= 5) { els.badges.master5.classList.add('unlocked'); }
            if (streak >= 3) { els.badges.streak3.classList.add('unlocked'); currentTitle = "Há»a NhÃ£n Kim Tinh"; }
            if (streak >= 7) { els.badges.streak7.classList.add('unlocked'); currentTitle = "Báº¯t Máº¡ch Online"; }
            if (streak >= 14) { els.badges.streak14.classList.add('unlocked'); currentTitle = "ThÃ¡i Y Viá»‡n TrÆ°á»Ÿng"; }
            if (streak >= 30) { els.badges.streak30.classList.add('unlocked'); currentTitle = "Äá»™c CÃ´ Cáº§u Báº¡i"; }
            
            if (mastered >= 20) { els.badges.master20.classList.add('unlocked'); currentTitle = "Hoa ÄÃ  TÃ¡i Tháº¿"; }
            if (mastered >= 50) { els.badges.master50.classList.add('unlocked'); currentTitle = "Tháº§n Y Háº¡ PhÃ m"; }
        }

        async function tryAutoCheckIn() {
            if(isGuest || todayCheckedIn) return;
            try {
                const today = new Date().toISOString().split('T')[0];
                await addDoc(collection(db, "attendance"), { uid: currentUser.uid, date: today, timestamp: serverTimestamp() });
                todayCheckedIn = true; attendanceDates.add(today);
                if (typeof confetti === 'function') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                showToast("âœ… Äiá»ƒm danh thÃ nh cÃ´ng!");
                checkAttendance(); renderCalendar(); 
            } catch(e) { console.error(e); }
        }

        async function loadLeaderboard() {
            try {
                const q = query(collection(db, "profiles"), orderBy("streak", "desc"), limit(20));
                const snap = await getDocs(q);
                els.leaderboardList.innerHTML = '';
                let rank = 1;
                snap.forEach(doc => {
                    const data = doc.data();
                    const isMe = currentUser && doc.id === currentUser.uid;
                    const div = document.createElement('div');
                    let rankClass = '';
                    if (rank === 1) rankClass = 'lb-top1'; else if (rank === 2) rankClass = 'lb-top2'; else if (rank === 3) rankClass = 'lb-top3';
                    
                    div.className = `lb-item ${rankClass}`;
                    if(isMe) div.style.borderLeft = '4px solid var(--primary)';
                    
                    div.innerHTML = `
                        <div class="lb-rank">${rank}</div>
                        <img src="${data.photoURL}" class="avatar" style="width:36px; height:36px; margin-right:12px; border:none;">
                        <div class="lb-info">
                            <div class="lb-name">${data.displayName} ${isMe ? '(Báº¡n)' : ''}</div>
                            <div class="lb-detail">${data.title || 'Lang BÄƒm'}</div>
                        </div>
                        <div class="lb-score">${data.streak} ngÃ y</div>`;
                    els.leaderboardList.appendChild(div);
                    rank++;
                });
            } catch(e) {
                els.leaderboardList.innerHTML = '<div style="text-align:center; padding:10px;">ÄÄƒng nháº­p Ä‘á»ƒ xem BXH</div>';
            }
        }

        els.viewWeek.addEventListener('click', () => { calViewMode = 'week'; renderCalendar(); });
        els.viewMonth.addEventListener('click', () => { calViewMode = 'month'; renderCalendar(); });

        function renderCalendar() {
            if(calViewMode === 'week') { els.viewWeek.className = 'btn btn-xs btn-primary'; els.viewMonth.className = 'btn btn-xs btn-secondary'; } 
            else { els.viewWeek.className = 'btn btn-xs btn-secondary'; els.viewMonth.className = 'btn btn-xs btn-primary'; }
            const today = new Date(); els.calendarGrid.innerHTML = '';
            let startDate, daysToRender;
            if (calViewMode === 'month') {
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                const dayOfWeek = startDate.getDay(); startDate.setDate(startDate.getDate() - dayOfWeek); daysToRender = 42; 
            } else {
                startDate = new Date(today); startDate.setDate(today.getDate() - today.getDay()); daysToRender = 7;
            }
            for (let i = 0; i < daysToRender; i++) {
                const currentDate = new Date(startDate); currentDate.setDate(startDate.getDate() + i);
                const year = currentDate.getFullYear(); const month = String(currentDate.getMonth() + 1).padStart(2, '0'); const day = String(currentDate.getDate()).padStart(2, '0');
                const dateString = `${year}-${month}-${day}`;
                const hasStudied = attendanceDates.has(dateString);
                const isCurrentMonth = currentDate.getMonth() === today.getMonth();
                const opacity = (calViewMode === 'month' && !isCurrentMonth) ? '0.3' : '1';
                const div = document.createElement('div');
                div.className = `cal-day ${hasStudied ? 'active' : ''}`;
                if (today.getDate() === currentDate.getDate() && today.getMonth() === currentDate.getMonth()) div.classList.add('today');
                div.style.opacity = opacity; div.textContent = currentDate.getDate();
                els.calendarGrid.appendChild(div);
            }
        }

        function setupNavigation() {
            els.navItems.forEach(tab => {
                tab.addEventListener('click', () => {
                    els.navItems.forEach(t => t.classList.remove('active'));
                    els.views.forEach(v => v.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.target).classList.add('active');
                    if(tab.dataset.target === 'tab-quiz') startQuiz();
                    if(tab.dataset.target === 'tab-dashboard') loadLeaderboard();
                    if(tab.dataset.target === 'tab-combo') renderCombos();
                });
            });
        }

        function updateGroupSelect() {
            const groups = [...new Set(acupoints.map(i => i.group))];
            els.groupSuggestions.innerHTML = groups.map(g => `<option value="${g}">`).join('');
            const currentVal = els.quizGroupSelect.value;
            els.quizGroupSelect.innerHTML = '<option value="all">Táº¥t cáº£ chiÃªu thá»©c</option>';
            groups.forEach(g => {
                const opt = document.createElement('option'); opt.value = g; opt.textContent = g;
                els.quizGroupSelect.appendChild(opt);
            });
            if(groups.includes(currentVal)) els.quizGroupSelect.value = currentVal;
        }
    </script>
</body>
</html>
