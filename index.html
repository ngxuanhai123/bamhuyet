<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiHi Med - S·ªï Tay Y H·ªçc</title>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00695c;
            --primary-light: #4db6ac;
            --accent: #ffb300; 
            --bg: #f5f7fa;
            --surface: #ffffff;
            --text: #263238;
            --success: #2e7d32;
            --error: #c62828;
            --radius: 16px;
            --shadow: 0 8px 24px rgba(0, 105, 92, 0.1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Components --- */
        .btn {
            padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer;
            font-weight: 600; font-size: 0.95rem; transition: transform 0.1s, box-shadow 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0, 105, 92, 0.3); }
        .btn-secondary { background: #cfd8dc; color: #455a64; }
        .btn-accent { background: var(--accent); color: #fff; box-shadow: 0 4px 10px rgba(255, 179, 0, 0.3); }
        .btn-success { background: #e8f5e9; color: var(--success); border: 1px solid #c8e6c9; }
        .btn-danger { background: #ffebee; color: var(--error); }
        .btn-google { background: white; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; }
        .btn-xs { padding: 4px 10px; font-size: 0.8rem; border-radius: 8px; }

        .card {
            background: var(--surface); border-radius: var(--radius); padding: 20px;
            margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.8);
        }
        
        input, select, textarea {
            width: 100%; padding: 12px; border: 2px solid #eceff1; border-radius: 12px;
            font-size: 1rem; margin-bottom: 12px; font-family: inherit; transition: border-color 0.2s;
        }
        input:focus, textarea:focus { border-color: var(--primary); background: #fff; }

        /* --- Layout --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), #80cbc4);
            display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 24px;
            text-align: center; width: 90%; max-width: 380px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }

        #app-screen { display: none; flex: 1; flex-direction: column; }

        header {
            background: var(--surface); padding: 10px 16px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        .brand { 
            font-weight: 800; color: var(--primary); font-size: 1.2rem; 
            display: flex; align-items: center; gap: 8px; 
        }
        .brand-text { display: flex; flex-direction: column; line-height: 1.1; }
        .slogan { font-size: 0.65rem; font-weight: 500; color: #78909c; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .user-profile { display: flex; align-items: center; gap: 8px; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-light); }

        .container { max-width: 800px; margin: 0 auto; width: 100%; padding: 16px; flex: 1; }

        /* --- Tabs --- */
        .nav-pills { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch;}
        .nav-item {
            padding: 8px 16px; border-radius: 20px; background: white; color: var(--text); opacity: 0.7;
            font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.3s; border: 1px solid transparent;
        }
        .nav-item.active { background: var(--primary); color: white; opacity: 1; box-shadow: 0 4px 10px rgba(0, 105, 92, 0.2); }

        /* --- Views --- */
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Quiz UI --- */
        .quiz-container { text-align: center; padding: 10px 0; }
        .quiz-badge { display: inline-block; padding: 4px 12px; background: #e0f2f1; color: var(--primary); border-radius: 20px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px; }
        .quiz-question { font-size: 1.4rem; color: #263238; margin: 8px 0; font-weight: 800; }
        .quiz-desc { color: #546e7a; font-style: italic; margin-bottom: 20px; line-height: 1.5; font-size: 0.95rem; }
        
        .feedback { min-height: 24px; margin-top: 10px; font-weight: 700; font-size: 1rem; }
        .feedback.correct { color: var(--success); animation: popIn 0.3s; }
        .feedback.wrong { color: var(--error); }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        /* --- Calendar UI --- */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; font-size: 0.85rem; }
        .cal-day-header { font-weight: bold; color: #90a4ae; padding-bottom: 5px; font-size: 0.75rem; }
        .cal-day { 
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center; 
            border-radius: 8px; background: #fafafa; color: #cfd8dc; font-weight: 500;
        }
        .cal-day.active { background: var(--primary); color: white; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cal-day.today { border: 2px solid var(--accent); color: var(--text); }
        .cal-day.active.today { border: 2px solid var(--accent); color: white; }

        /* --- Grouped List UI --- */
        .group-header {
            background: #e0f2f1; color: var(--primary); padding: 8px 12px;
            border-radius: 8px; font-weight: 700; margin-top: 10px; margin-bottom: 5px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 8px; border-bottom: 1px solid #eee;
        }
        .list-item:last-child { border-bottom: none; }
        .tag-mastered { 
            background: #e8f5e9; color: var(--success); font-size: 0.7rem; padding: 2px 6px; 
            border-radius: 4px; font-weight: 700; border: 1px solid #c8e6c9; margin-left: 5px;
        }
        
        /* --- Leaderboard UI --- */
        .lb-item { display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .lb-rank { font-weight: 800; font-size: 1.1rem; width: 35px; color: var(--text); opacity: 0.6; }
        .lb-name { flex: 1; font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px;}
        .lb-score { font-weight: 700; color: var(--primary); background: #e0f2f1; padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; white-space: nowrap;}
        
        .lb-top1 { border: 2px solid #ffd700; background: #fffde7; }
        .lb-top1 .lb-rank { color: #fbc02d; opacity: 1; }
        .lb-top2 .lb-rank { color: #90a4ae; opacity: 1; }
        .lb-top3 .lb-rank { color: #a1887f; opacity: 1; }

        /* --- Utilities --- */
        .app-footer { text-align: center; padding: 20px; margin-top: auto; color: #90a4ae; font-size: 0.85rem; }
        .heart-anim { color: #e91e63; display: inline-block; animation: heartBeat 1.5s infinite; }
        @keyframes heartBeat { 0% { transform: scale(1); } 14% { transform: scale(1.3); } 28% { transform: scale(1); } 42% { transform: scale(1.3); } 70% { transform: scale(1); } }
        
        #toast { visibility: hidden; min-width: 200px; background-color: #263238; color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 1000; left: 50%; bottom: 80px; transform: translateX(-50%); opacity: 0; transition: 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 0.9rem; }
        #toast.show { visibility: visible; opacity: 1; bottom: 100px; }
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 200; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 10px; display: none;}
        .spinner { width: 30px; height: 30px; border: 3px solid #eee; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loading"><div class="spinner"></div></div>
    <div id="toast">Th√¥ng b√°o</div>

    <div id="login-screen">
        <div class="login-box">
            <div style="font-size: 4rem; margin-bottom: 10px;">‚öïÔ∏è</div>
            <h1 style="color: var(--primary); margin: 0; font-size: 2.2rem; letter-spacing: -1px;">HiHi Med</h1>
            <p style="color: #546e7a; margin-bottom: 5px; font-weight: 600;">S·ªï Tay Huy·ªát ƒê·∫°o</p>
            <p style="color: #90a4ae; font-size: 0.9rem; margin-top: 0; margin-bottom: 25px; font-style: italic;">"Tinh hoa tr·ªã li·ªáu c·ªï truy·ªÅn"</p>
            <button class="btn btn-google" id="btnLogin">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" style="margin-right:8px">
                ƒêƒÉng nh·∫≠p b·∫±ng Google
            </button>
        </div>
    </div>

    <div id="app-screen">
        <header>
            <div class="brand">
                <span style="font-size: 1.8rem;">‚öïÔ∏è</span>
                <div class="brand-text">
                    <span>HiHi Med</span>
                    <span class="slogan">S·ªï tay y h·ªçc</span>
                </div>
            </div>
            <div class="user-profile">
                <img id="userAvatar" class="avatar" src="" alt="">
                <button class="btn btn-danger" style="padding: 6px 10px; font-size: 0.75rem;" id="btnLogout">Tho√°t</button>
            </div>
        </header>

        <div class="container">
            <div class="nav-pills">
                <div class="nav-item active" data-target="tab-quiz">üß† H·ªçc T·∫≠p</div>
                <div class="nav-item" data-target="tab-dashboard">üèÜ Th√†nh T√≠ch</div>
                <div class="nav-item" data-target="tab-manage">‚öôÔ∏è Qu·∫£n L√Ω</div>
            </div>

            <div id="tab-quiz" class="view active">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin:0; font-size: 1.1rem;">√în t·∫≠p nhanh</h3>
                        <select id="quizGroupSelect" style="width: auto; margin:0; padding: 6px 12px; font-size: 0.85rem; border-radius: 20px;">
                            <option value="all">T·∫•t c·∫£ ch·ªß ƒë·ªÅ</option>
                        </select>
                    </div>

                    <div id="quizArea" class="quiz-container">
                        <div class="quiz-badge" id="qGroup">...</div>
                        <div class="quiz-question" id="qQuestion">...</div>
                        <p class="quiz-desc" id="qDesc">...</p>
                        
                        <input type="text" id="qInput" placeholder="Nh·∫≠p t√™n huy·ªát..." autocomplete="off">
                        
                        <div class="feedback" id="qFeedback"></div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px;">
                            <button class="btn btn-accent" id="btnHint">üí° G·ª£i √Ω</button>
                            <button class="btn btn-secondary" id="btnShowAns">üëÅÔ∏è ƒê√°p √°n</button>
                            <button class="btn btn-success" id="btnMastered">‚úÖ ƒê√£ thu·ªôc</button>
                        </div>
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 10px; background: #eceff1; color: #78909c" id="btnNext">B·ªè qua c√¢u n√†y ‚ûú</button>
                    </div>
                    
                    <div id="emptyQuizMsg" style="display:none; text-align: center; padding: 30px;">
                        <div style="font-size: 3rem;">üéâ</div>
                        <p id="emptyMsgText">B·∫°n ch∆∞a c√≥ d·ªØ li·ªáu y h·ªçc n√†o.</p>
                        <button class="btn btn-primary" id="btnInitData" onclick="initDefaultData()">‚ôªÔ∏è T·∫£i 30+ huy·ªát m·∫´u ngay</button>
                    </div>
                </div>
            </div>

            <div id="tab-dashboard" class="view">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div class="card" style="margin:0; text-align:center; background: linear-gradient(135deg, var(--primary), #004d40); color: white; border:none;">
                        <div style="font-size: 2rem; font-weight: 800;" id="stat-streak">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">Chu·ªói ng√†y h·ªçc</div>
                    </div>
                    <div class="card" style="margin:0; text-align:center;">
                        <div style="font-size: 2rem; font-weight: 800; color: var(--primary);" id="stat-total">0</div>
                        <div style="font-size: 0.8rem; color: #78909c;">T·ªïng s·ªë huy·ªát</div>
                    </div>
                </div>

                <div class="card">
                    <div class="cal-header">
                        <h3 style="margin:0; font-size: 1.1rem; display:flex; align-items:center; gap:5px;">üìÖ L·ªãch S·ª≠ H·ªçc</h3>
                        <div>
                            <button class="btn btn-xs btn-primary" id="viewWeek">Tu·∫ßn</button>
                            <button class="btn btn-xs btn-secondary" id="viewMonth">Th√°ng</button>
                        </div>
                    </div>
                    <div class="cal-grid" style="margin-bottom: 5px;">
                        <div class="cal-day-header">CN</div><div class="cal-day-header">T2</div><div class="cal-day-header">T3</div><div class="cal-day-header">T4</div><div class="cal-day-header">T5</div><div class="cal-day-header">T6</div><div class="cal-day-header">T7</div>
                    </div>
                    <div id="calendarGrid" class="cal-grid"></div>
                </div>

                <h3 style="margin: 10px 0; font-size: 1.1rem; color: #37474f;">üèÜ B·∫£ng v√†ng Top 20</h3>
                <div id="leaderboardList">
                    <div style="text-align:center; padding: 20px; color: #90a4ae;">ƒêang t·∫£i x·∫øp h·∫°ng...</div>
                </div>
            </div>

            <div id="tab-manage" class="view">
                <div class="card">
                    <h3 style="margin-top:0; font-size: 1.1rem;">Th√™m huy·ªát m·ªõi</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <input type="text" id="inpGroup" placeholder="Nh√≥m (VD: ƒêau ƒë·∫ßu)" list="groupSuggestions">
                        <input type="text" id="inpName" placeholder="T√™n Huy·ªát">
                    </div>
                    <datalist id="groupSuggestions"></datalist>
                    <textarea id="inpDesc" rows="2" placeholder="M√¥ t·∫£ v·ªã tr√≠, t√°c d·ª•ng..."></textarea>
                    <button class="btn btn-primary" id="btnAddData" style="width: 100%">üíæ L∆∞u ki·∫øn th·ª©c</button>
                    
                    <div style="margin-top: 15px; border-top: 1px dashed #cfd8dc; padding-top: 15px;">
                        <button class="btn btn-secondary" style="width: 100%; font-size: 0.85rem;" onclick="initDefaultData()">
                            üìö T·∫£i b·ªô d·ªØ li·ªáu m·∫´u (N·∫øu ch∆∞a c√≥)
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-top:0; font-size: 1.1rem;">Kho d·ªØ li·ªáu (T·∫•t c·∫£)</h3>
                    <div id="dataList" style="max-height: 500px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <footer class="app-footer">
            HiHi Med &copy; 2025<br>Made with <span class="heart-anim">‚ù§</span> by Xu√¢n H·∫£i
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, serverTimestamp, writeBatch, orderBy, limit, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAsHD5pH6Blm4wtXKEJojFYMl24SNgiKY0",
            authDomain: "bamhuyet-6c9e6.firebaseapp.com",
            projectId: "bamhuyet-6c9e6",
            storageBucket: "bamhuyet-6c9e6.firebasestorage.app",
            messagingSenderId: "195174949274",
            appId: "1:195174949274:web:50cd99e0fad60ba8a81a23",
            measurementId: "G-W66885N5XM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let acupoints = [];
        let currentQuizItem = null;
        let currentHintIndex = 0;
        let todayCheckedIn = false;
        let attendanceDates = new Set();
        let calViewMode = 'week'; // DEFAULT: WEEK VIEW
        let isProcessing = false; // Prevent double checking

        // --- B·ªò D·ªÆ LI·ªÜU M·∫™U (30+ HUY·ªÜT) ---
        const defaultAcupoints = [
            { group: "ƒêau ƒë·∫ßu", name: "H·ª£p C·ªëc", desc: "N·∫±m ·ªü h·ªï kh·∫©u, gi·ªØa x∆∞∆°ng ƒë·ªët b√†n ng√≥n c√°i v√† ng√≥n tr·ªè." },
            { group: "ƒêau ƒë·∫ßu", name: "Th√°i D∆∞∆°ng", desc: "Ch·ªó l√µm ph√≠a sau ƒëu√¥i l√¥ng m√†y v√† ƒëu√¥i m·∫Øt kho·∫£ng 1 th·ªën." },
            { group: "ƒêau ƒë·∫ßu", name: "·∫§n ƒê∆∞·ªùng", desc: "ƒêi·ªÉm ch√≠nh gi·ªØa ƒë∆∞·ªùng n·ªëi hai ƒë·∫ßu l√¥ng m√†y." },
            { group: "ƒêau ƒë·∫ßu", name: "To·∫£n Tr√∫c", desc: "Ch·ªó l√µm ƒë·∫ßu trong l√¥ng m√†y, th·∫≥ng tr√™n g√≥c m·∫Øt trong." },
            { group: "ƒêau ƒë·∫ßu", name: "Phong Tr√¨", desc: "Ch·ªó l√µm ph√≠a sau g√°y, b√™n ngo√†i kh·ªëi c∆° thang, ngay d∆∞·ªõi x∆∞∆°ng ch·∫©m." },
            { group: "M·∫•t ng·ªß", name: "N·ªôi Quan", desc: "M·∫∑t tr∆∞·ªõc c·ªï tay, t·ª´ l·∫±n ch·ªâ ƒëo l√™n 2 th·ªën, gi·ªØa hai g√¢n." },
            { group: "M·∫•t ng·ªß", name: "Th·∫ßn M√¥n", desc: "Tr√™n l·∫±n ch·ªâ c·ªï tay, ch·ªó l√µm ph√≠a x∆∞∆°ng tr·ª• (ph√≠a ng√≥n √∫t)." },
            { group: "M·∫•t ng·ªß", name: "Tam √Çm Giao", desc: "M·∫∑t trong c·∫≥ng ch√¢n, t·ª´ ƒë·ªânh m·∫Øt c√° trong ƒëo l√™n 3 th·ªën." },
            { group: "M·∫•t ng·ªß", name: "D≈©ng Tuy·ªÅn", desc: "Ch·ªó l√µm d∆∞·ªõi gan b√†n ch√¢n, t·∫°i ƒëi·ªÉm n·ªëi 1/3 tr∆∞·ªõc v√† 2/3 sau." },
            { group: "ƒêau l∆∞ng", name: "·ª¶y Trung", desc: "ƒêi·ªÉm ch√≠nh gi·ªØa n·∫øp l·∫±n khoeo ch√¢n (sau ƒë·∫ßu g·ªëi)." },
            { group: "ƒêau l∆∞ng", name: "Th·∫≠n Du", desc: "D∆∞·ªõi m·ªèm gai ƒë·ªët s·ªëng th·∫Øt l∆∞ng 2, ƒëo ra ngang 1.5 th·ªën." },
            { group: "ƒêau vai g√°y", name: "Ki√™n T·ªânh", desc: "ƒêi·ªÉm gi·ªØa ƒë∆∞·ªùng n·ªëi huy·ªát ƒê·∫°i Ch√πy v√† m·ªèm c√πng vai." },
            { group: "ƒêau vai g√°y", name: "ƒê·∫°i Ch√πy", desc: "Ch·ªó l√µm d∆∞·ªõi m·ªèm gai ƒë·ªët s·ªëng c·ªï 7 (C7)." },
            { group: "ƒêau l∆∞ng", name: "D∆∞∆°ng LƒÉng Tuy·ªÅn", desc: "Ch·ªó l√µm ph√≠a tr∆∞·ªõc v√† d∆∞·ªõi ƒë·∫ßu nh·ªè x∆∞∆°ng m√°c." },
            { group: "Ti√™u h√≥a", name: "T√∫c Tam L√Ω", desc: "D∆∞·ªõi m·∫Øt g·ªëi ngo√†i 3 th·ªën, c√°ch m√†o ch√†y 1 kho√°t ng√≥n tay." },
            { group: "Ti√™u h√≥a", name: "Trung Qu·∫£n", desc: "N·∫±m tr√™n ƒë∆∞·ªùng gi·ªØa b·ª•ng, t·ª´ r·ªën ƒëo l√™n 4 th·ªën." },
            { group: "Ti√™u h√≥a", name: "Thi√™n Khu", desc: "T·ª´ r·ªën ƒëo ngang ra 2 b√™n, m·ªói b√™n 2 th·ªën." },
            { group: "H√¥ h·∫•p", name: "Nghinh H∆∞∆°ng", desc: "ƒêi·ªÉm giao gi·ªØa r√£nh m≈©i m√° v√† ƒë∆∞·ªùng ngang qua ch√¢n c√°nh m≈©i." },
            { group: "H√¥ h·∫•p", name: "Li·ªát Khuy·∫øt", desc: "Tr√™n c·ªï tay 1.5 th·ªën, khi hai b√†n tay ƒëan v√†o nhau." },
            { group: "H√¥ h·∫•p", name: "Ph·∫ø Du", desc: "D∆∞·ªõi m·ªèm gai ƒë·ªët s·ªëng ng·ª±c 3, ƒëo ra ngang 1.5 th·ªën." },
            { group: "H√¥ h·∫•p", name: "X√≠ch Tr·∫°ch", desc: "Tr√™n n·∫øp g·∫•p khu·ª∑u tay, b·ªù ngo√†i g√¢n c∆° nh·ªã ƒë·∫ßu." },
            { group: "Th·∫©m m·ªπ", name: "Quy·ªÅn Li√™u", desc: "D∆∞·ªõi x∆∞∆°ng g√≤ m√°, giao ƒëi·ªÉm ƒë∆∞·ªùng th·∫≥ng qua ƒëu√¥i m·∫Øt." },
            { group: "Th·∫©m m·ªπ", name: "ƒê·ªãa Th∆∞∆°ng", desc: "C√°ch kh√≥e mi·ªáng 0.4 th·ªën." },
            { group: "Th∆∞ gi√£n", name: "B√°ch H·ªôi", desc: "ƒêi·ªÉm ch√≠nh gi·ªØa ƒë·ªânh ƒë·∫ßu." },
            { group: "Th∆∞ gi√£n", name: "Lao Cung", desc: "Trong l√≤ng b√†n tay, khi n·∫Øm tay l·∫°i, ƒë·∫ßu ng√≥n gi·ªØa ch·∫°m v√†o ƒë√¢u l√† huy·ªát." }
        ];

        // ELEMENTS
        const els = {
            loading: document.getElementById('loading'),
            loginScreen: document.getElementById('login-screen'),
            appScreen: document.getElementById('app-screen'),
            btnLogin: document.getElementById('btnLogin'),
            btnLogout: document.getElementById('btnLogout'),
            userAvatar: document.getElementById('userAvatar'),
            navItems: document.querySelectorAll('.nav-item'),
            views: document.querySelectorAll('.view'),
            // Manage
            inpGroup: document.getElementById('inpGroup'),
            inpName: document.getElementById('inpName'),
            inpDesc: document.getElementById('inpDesc'),
            btnAddData: document.getElementById('btnAddData'),
            dataList: document.getElementById('dataList'),
            groupSuggestions: document.getElementById('groupSuggestions'),
            // Quiz
            quizGroupSelect: document.getElementById('quizGroupSelect'),
            qGroup: document.getElementById('qGroup'),
            qQuestion: document.getElementById('qQuestion'),
            qDesc: document.getElementById('qDesc'),
            qInput: document.getElementById('qInput'),
            qFeedback: document.getElementById('qFeedback'),
            btnMastered: document.getElementById('btnMastered'),
            btnShowAns: document.getElementById('btnShowAns'),
            btnHint: document.getElementById('btnHint'),
            btnNext: document.getElementById('btnNext'),
            quizArea: document.getElementById('quizArea'),
            emptyQuizMsg: document.getElementById('emptyQuizMsg'),
            emptyMsgText: document.getElementById('emptyMsgText'),
            btnInitData: document.getElementById('btnInitData'),
            // Stats & Cal
            statStreak: document.getElementById('stat-streak'),
            statTotal: document.getElementById('stat-total'),
            leaderboardList: document.getElementById('leaderboardList'),
            calendarGrid: document.getElementById('calendarGrid'),
            viewWeek: document.getElementById('viewWeek'),
            viewMonth: document.getElementById('viewMonth')
        };

        // --- AUTH ---
        els.btnLogin.addEventListener('click', () => signInWithPopup(auth, provider).catch(err => showToast("L·ªói: " + err.message)));
        els.btnLogout.addEventListener('click', () => { signOut(auth); location.reload(); });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                els.loginScreen.style.display = 'none';
                els.appScreen.style.display = 'flex';
                els.userAvatar.src = user.photoURL;
                
                showLoading(true);
                await Promise.all([loadData(), checkAttendance(), loadLeaderboard()]);
                setupNavigation();
                renderCalendar(); 
                showLoading(false);
                showToast(`Xin ch√†o b√°c sƒ© t∆∞∆°ng lai ${user.displayName}!`);
            } else {
                els.loginScreen.style.display = 'flex';
                els.appScreen.style.display = 'none';
            }
        });

        function showLoading(show) { els.loading.style.display = show ? 'flex' : 'none'; }
        function showToast(message) {
            const x = document.getElementById("toast"); x.textContent = message;
            x.className = "show"; setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- DATA & LIST LOGIC ---
        async function loadData() {
            try {
                const q = query(collection(db, "acupoints"), where("uid", "==", currentUser.uid));
                const snap = await getDocs(q);
                acupoints = [];
                snap.forEach((doc) => acupoints.push({ id: doc.id, ...doc.data() }));
                
                els.statTotal.textContent = acupoints.length;
                renderListGrouped();
                updateGroupSelect();
                prepareQuiz();
            } catch (e) { console.error(e); }
        }

        function renderListGrouped() {
            els.dataList.innerHTML = '';
            const groups = {};
            acupoints.forEach(item => {
                if(!groups[item.group]) groups[item.group] = [];
                groups[item.group].push(item);
            });

            Object.keys(groups).sort().forEach(gName => {
                const header = document.createElement('div');
                header.className = 'group-header';
                header.innerHTML = `<span>üìÇ ${gName}</span> <span style="font-size:0.8rem; opacity:0.8">${groups[gName].length} b√†i</span>`;
                els.dataList.appendChild(header);

                groups[gName].forEach(item => {
                    const isMastered = item.isMastered === true;
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div>
                            <div style="font-weight:600">
                                ${item.name} 
                                ${isMastered ? '<span class="tag-mastered">‚úÖ ƒê√£ thu·ªôc</span>' : ''}
                            </div>
                            <div style="font-size:0.85rem; color:#666; margin-top:2px">${item.desc}</div>
                        </div>
                        <button onclick="deleteAcupoint('${item.id}')" style="background:none; border:none; cursor:pointer; font-size:1.2rem; opacity:0.4; color:red;">&times;</button>
                    `;
                    els.dataList.appendChild(div);
                });
            });

            if(acupoints.length === 0) els.dataList.innerHTML = '<div style="text-align:center; padding:20px; color:#999">Danh s√°ch tr·ªëng</div>';
        }

        window.initDefaultData = async () => {
            if(acupoints.length > 0 && !confirm("Th√™m d·ªØ li·ªáu m·∫´u v√†o danh s√°ch hi·ªán t·∫°i c·ªßa b·∫°n?")) return;
            showLoading(true);
            try {
                const batch = writeBatch(db);
                defaultAcupoints.forEach(item => {
                    const docRef = doc(collection(db, "acupoints"));
                    batch.set(docRef, {
                        uid: currentUser.uid, 
                        group: item.group, 
                        name: item.name, 
                        desc: item.desc, 
                        isMastered: false, // M·∫∑c ƒë·ªãnh ch∆∞a thu·ªôc
                        createdAt: serverTimestamp()
                    });
                });
                await batch.commit();
                await loadData();
                showToast("‚úÖ ƒê√£ n·∫°p d·ªØ li·ªáu y h·ªçc!");
                document.querySelector('[data-target="tab-quiz"]').click();
            } catch(e) { showToast("L·ªói: " + e.message); }
            showLoading(false);
        }

        els.btnAddData.addEventListener('click', async () => {
            const group = els.inpGroup.value.trim();
            const name = els.inpName.value.trim();
            const desc = els.inpDesc.value.trim();
            if(!group || !name) return showToast("Thi·∫øu t√™n ho·∫∑c nh√≥m!");
            
            showLoading(true);
            try {
                const docRef = await addDoc(collection(db, "acupoints"), {
                    uid: currentUser.uid, group, name, desc, isMastered: false, createdAt: serverTimestamp()
                });
                acupoints.push({ id: docRef.id, uid: currentUser.uid, group, name, desc, isMastered: false });
                els.inpName.value = ''; els.inpDesc.value = '';
                els.statTotal.textContent = acupoints.length;
                renderListGrouped(); updateGroupSelect(); prepareQuiz();
                showToast("ƒê√£ l∆∞u!");
            } catch (e) { showToast("L·ªói l∆∞u."); }
            showLoading(false);
        });

        window.deleteAcupoint = async (id) => {
            if(!confirm("X√≥a huy·ªát n√†y?")) return;
            showLoading(true);
            try {
                await deleteDoc(doc(db, "acupoints", id));
                acupoints = acupoints.filter(item => item.id !== id);
                els.statTotal.textContent = acupoints.length;
                renderListGrouped(); updateGroupSelect(); prepareQuiz();
                showToast("ƒê√£ x√≥a.");
            } catch (e) { showToast("L·ªói x√≥a."); }
            showLoading(false);
        }

        // --- ATTENDANCE, CALENDAR & LEADERBOARD ---
        async function checkAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const q = query(collection(db, "attendance"), where("uid", "==", currentUser.uid));
            const snap = await getDocs(q);
            attendanceDates.clear(); 
            snap.forEach(doc => attendanceDates.add(doc.data().date));
            
            const streakCount = attendanceDates.size;
            todayCheckedIn = attendanceDates.has(today);
            els.statStreak.textContent = streakCount;

            try {
                await setDoc(doc(db, "profiles", currentUser.uid), {
                    displayName: currentUser.displayName,
                    streak: streakCount,
                    photoURL: currentUser.photoURL,
                    lastActive: serverTimestamp()
                }, { merge: true });
            } catch(e) { console.log("Update profile error", e); }
        }

        async function tryAutoCheckIn() {
            if (todayCheckedIn) return;
            try {
                const today = new Date().toISOString().split('T')[0];
                await addDoc(collection(db, "attendance"), {
                    uid: currentUser.uid, date: today, timestamp: serverTimestamp()
                });
                todayCheckedIn = true;
                attendanceDates.add(today);
                renderCalendar(); 
                checkAttendance(); 
                showToast("‚úÖ ƒêi·ªÉm danh ng√†y m·ªõi!");
            } catch(e) { console.error(e); }
        }

        async function loadLeaderboard() {
            try {
                const q = query(collection(db, "profiles"), orderBy("streak", "desc"), limit(20));
                const snap = await getDocs(q);
                els.leaderboardList.innerHTML = '';
                
                let rank = 1;
                snap.forEach(doc => {
                    const data = doc.data();
                    const isMe = doc.id === currentUser.uid;
                    const div = document.createElement('div');
                    
                    let rankClass = '';
                    if (rank === 1) rankClass = 'lb-top1';
                    else if (rank === 2) rankClass = 'lb-top2';
                    else if (rank === 3) rankClass = 'lb-top3';

                    div.className = `lb-item ${rankClass}`;
                    if(isMe) div.style.border = '2px solid var(--primary)';
                    
                    div.innerHTML = `
                        <div class="lb-rank">#${rank}</div>
                        <img src="${data.photoURL}" style="width:30px; height:30px; border-radius:50%; margin-right:10px;">
                        <div class="lb-name">${data.displayName} ${isMe ? '(B·∫°n)' : ''}</div>
                        <div class="lb-score">${data.streak} ng√†y</div>
                    `;
                    els.leaderboardList.appendChild(div);
                    rank++;
                });
                if(rank === 1) els.leaderboardList.innerHTML = '<div style="text-align:center; padding:20px;">Ch∆∞a c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng.</div>';
            } catch(e) {
                console.log(e);
                els.leaderboardList.innerHTML = '<div style="text-align:center; padding:10px; font-size:0.9rem">C·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem BXH</div>';
            }
        }

        // --- CALENDAR LOGIC ---
        els.viewWeek.addEventListener('click', () => { calViewMode = 'week'; renderCalendar(); });
        els.viewMonth.addEventListener('click', () => { calViewMode = 'month'; renderCalendar(); });

        function renderCalendar() {
            if(calViewMode === 'week') {
                els.viewWeek.className = 'btn btn-xs btn-primary';
                els.viewMonth.className = 'btn btn-xs btn-secondary';
            } else {
                els.viewWeek.className = 'btn btn-xs btn-secondary';
                els.viewMonth.className = 'btn btn-xs btn-primary';
            }

            const today = new Date();
            els.calendarGrid.innerHTML = '';
            
            let startDate, daysToRender;

            if (calViewMode === 'month') {
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                const dayOfWeek = startDate.getDay(); 
                startDate.setDate(startDate.getDate() - dayOfWeek);
                daysToRender = 42; 
            } else {
                startDate = new Date(today);
                startDate.setDate(today.getDate() - today.getDay());
                daysToRender = 7;
            }

            for (let i = 0; i < daysToRender; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const day = String(currentDate.getDate()).padStart(2, '0');
                const dateString = `${year}-${month}-${day}`;

                const isToday = (today.getDate() === currentDate.getDate() && 
                                today.getMonth() === currentDate.getMonth() && 
                                today.getFullYear() === currentDate.getFullYear());
                
                const hasStudied = attendanceDates.has(dateString);
                const isCurrentMonth = currentDate.getMonth() === today.getMonth();
                const opacity = (calViewMode === 'month' && !isCurrentMonth) ? '0.3' : '1';

                const div = document.createElement('div');
                div.className = `cal-day ${hasStudied ? 'active' : ''} ${isToday ? 'today' : ''}`;
                div.style.opacity = opacity;
                div.textContent = currentDate.getDate();
                els.calendarGrid.appendChild(div);
            }
        }


        // --- QUIZ LOGIC (AUTO CHECK + MASTERY) ---
        function prepareQuiz() {
            // Hi·ªÉn th·ªã quiz n·∫øu c√≥ d·ªØ li·ªáu
            if(acupoints.length > 0) {
                els.quizArea.style.display = 'block'; els.emptyQuizMsg.style.display = 'none';
            } else {
                els.quizArea.style.display = 'none'; 
                els.emptyQuizMsg.style.display = 'block';
                els.emptyMsgText.textContent = "B·∫°n ch∆∞a c√≥ d·ªØ li·ªáu y h·ªçc n√†o.";
                els.btnInitData.style.display = 'inline-flex';
            }
        }

        function startQuiz() {
            isProcessing = false;
            if (acupoints.length === 0) return;
            tryAutoCheckIn(); 
            
            const filter = els.quizGroupSelect.value;
            // L·ªçc ra c√°c huy·ªát ch∆∞a thu·ªôc (isMastered != true)
            let pool = acupoints.filter(i => (i.isMastered !== true) && (filter === 'all' || i.group === filter));
            
            if (pool.length === 0) {
                // N·∫øu ƒë√£ thu·ªôc h·∫øt
                els.quizArea.style.display = 'none';
                els.emptyQuizMsg.style.display = 'block';
                els.emptyMsgText.textContent = "Ch√∫c m·ª´ng! B·∫°n ƒë√£ thu·ªôc h·∫øt c√°c huy·ªát trong m·ª•c n√†y.";
                els.btnInitData.style.display = 'none';
                return;
            } else {
                els.quizArea.style.display = 'block';
                els.emptyQuizMsg.style.display = 'none';
            }
            
            const idx = Math.floor(Math.random() * pool.length);
            currentQuizItem = pool[idx];
            currentHintIndex = 0;

            els.qGroup.textContent = currentQuizItem.group;
            els.qQuestion.textContent = "Huy·ªát n√†y t√™n l√† g√¨?";
            els.qDesc.textContent = currentQuizItem.desc;
            els.qInput.value = '';
            els.qInput.focus();
            els.qFeedback.textContent = ''; els.qFeedback.className = 'feedback';
        }

        // LOGIC AUTO CHECK
        els.qInput.addEventListener('input', () => {
            if(!currentQuizItem || isProcessing) return;
            
            const val = els.qInput.value.trim().toLowerCase();
            const correctName = currentQuizItem.name.toLowerCase();

            if (val === correctName) {
                isProcessing = true;
                els.qFeedback.innerHTML = "üéâ Ch√≠nh x√°c!"; 
                els.qFeedback.className = 'feedback correct';
                tryAutoCheckIn();
                
                // T·ª± ƒë·ªông qua c√¢u sau 1s
                setTimeout(() => {
                    startQuiz();
                }, 1000);
            }
        });

        // LOGIC ƒê√É THU·ªòC (MASTERED)
        els.btnMastered.addEventListener('click', async () => {
            if(!currentQuizItem) return;
            if(!confirm("ƒê√°nh d·∫•u ƒë√£ thu·ªôc huy·ªát n√†y? (S·∫Ω kh√¥ng h·ªèi l·∫°i n·ªØa)")) return;

            showLoading(true);
            try {
                // C·∫≠p nh·∫≠t Firestore
                const itemRef = doc(db, "acupoints", currentQuizItem.id);
                await updateDoc(itemRef, { isMastered: true });

                // C·∫≠p nh·∫≠t m·∫£ng local
                const localItem = acupoints.find(i => i.id === currentQuizItem.id);
                if(localItem) localItem.isMastered = true;

                showToast("ƒê√£ ƒë√°nh d·∫•u thu·ªôc b√†i! üß†");
                renderListGrouped(); // C·∫≠p nh·∫≠t d·∫•u tick b√™n tab qu·∫£n l√Ω
                startQuiz(); // Qua c√¢u kh√°c
            } catch(e) {
                showToast("L·ªói: " + e.message);
            }
            showLoading(false);
        });

        els.btnHint.addEventListener('click', () => {
            if(!currentQuizItem) return;
            const name = currentQuizItem.name;
            if(currentHintIndex < name.length) {
                currentHintIndex++;
                els.qInput.value = name.substring(0, currentHintIndex);
                els.qInput.focus();
                // Trigger input event manually incase hint completes the word
                els.qInput.dispatchEvent(new Event('input'));
            }
        });

        els.quizGroupSelect.addEventListener('change', startQuiz);
        els.btnNext.addEventListener('click', startQuiz);
        els.btnShowAns.addEventListener('click', () => {
            if(!currentQuizItem) return;
            tryAutoCheckIn();
            els.qInput.value = currentQuizItem.name;
            els.qInput.focus();
            els.qInput.dispatchEvent(new Event('input')); // Auto check lu√¥n
        });

        // --- NAVIGATION ---
        function setupNavigation() {
            els.navItems.forEach(tab => {
                tab.addEventListener('click', () => {
                    els.navItems.forEach(t => t.classList.remove('active'));
                    els.views.forEach(v => v.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.target).classList.add('active');
                    
                    if(tab.dataset.target === 'tab-quiz') startQuiz();
                    if(tab.dataset.target === 'tab-dashboard') loadLeaderboard();
                });
            });
        }

        function updateGroupSelect() {
            const groups = [...new Set(acupoints.map(i => i.group))];
            els.groupSuggestions.innerHTML = groups.map(g => `<option value="${g}">`).join('');
            const currentVal = els.quizGroupSelect.value;
            els.quizGroupSelect.innerHTML = '<option value="all">T·∫•t c·∫£ ch·ªß ƒë·ªÅ</option>';
            groups.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g; opt.textContent = g;
                els.quizGroupSelect.appendChild(opt);
            });
            if(groups.includes(currentVal)) els.quizGroupSelect.value = currentVal;
        }
    </script>
</body>
</html>
