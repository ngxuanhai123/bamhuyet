<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiHi Med - Tuy·ªát K·ªπ Y H·ªçc</title>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #00695c;
            --primary-dark: #004d40;
            --primary-light: #b2dfdb;
            --accent: #ffb300; 
            --bg: #f3f4f6;
            --surface: #ffffff;
            --text: #1f2937;
            --success: #10b981;
            --error: #ef4444;
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Components --- */
        .btn {
            padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer;
            font-weight: 600; font-size: 0.95rem; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0, 105, 92, 0.3); }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-accent { background: var(--accent); color: #fff; box-shadow: 0 4px 12px rgba(255, 179, 0, 0.3); }
        .btn-search { 
            background: #eff6ff; color: #2563eb; border: 1px dashed #bfdbfe; 
            width: 100%; margin-bottom: 15px; font-size: 0.9rem;
        }
        .btn-search:hover { background: #dbeafe; }
        .btn-google { background: white; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; }
        .btn-xs { padding: 6px 12px; font-size: 0.8rem; border-radius: 8px; }

        .card {
            background: var(--surface); border-radius: var(--radius); padding: 20px;
            margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.8);
            position: relative; overflow: hidden;
        }
        
        input, select, textarea {
            width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px;
            font-size: 1rem; margin-bottom: 12px; font-family: inherit; transition: border-color 0.2s;
        }
        input:focus, textarea:focus { border-color: var(--primary); background: #fff; ring: 2px solid var(--primary-light); }

        /* --- Layout --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 105, 92, 0.98);
            display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 24px;
            text-align: center; width: 90%; max-width: 380px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.4s ease;
        }

        #app-screen { display: flex; flex: 1; flex-direction: column; }

        header {
            background: var(--surface); padding: 12px 16px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 50; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .brand { 
            font-weight: 800; color: var(--primary); font-size: 1.5rem; 
            display: flex; align-items: center; gap: 10px; 
        }
        .brand-icon { font-size: 2.4rem; } /* LOGO L·ªöN H∆†N */
        .brand-text { display: flex; flex-direction: column; line-height: 1; }
        .slogan { font-size: 0.7rem; font-weight: 600; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;}
        
        .user-profile { display: flex; align-items: center; gap: 10px; }
        .user-info { text-align: right; display: none; } /* Hi·ªán khi login */
        .user-name { font-weight: 700; font-size: 0.9rem; color: var(--text); }
        .user-title { font-size: 0.75rem; color: var(--accent); font-weight: 600; text-transform: uppercase; }
        
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); background: #eee; }

        .container { max-width: 800px; margin: 0 auto; width: 100%; padding: 16px; flex: 1; }

        /* --- Tabs --- */
        .nav-pills { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch;}
        .nav-item {
            padding: 10px 20px; border-radius: 25px; background: white; color: #6b7280;
            font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.3s; border: 1px solid #e5e7eb;
        }
        .nav-item.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 6px rgba(0, 105, 92, 0.2); }

        /* --- Views --- */
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Quiz UI --- */
        .quiz-container { text-align: center; padding: 10px 0; }
        .quiz-badge { display: inline-block; padding: 6px 16px; background: #ecfdf5; color: var(--primary); border-radius: 20px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 0.5px; border: 1px solid #a7f3d0; }
        .quiz-question { font-size: 1.5rem; color: #111827; margin: 10px 0; font-weight: 800; line-height: 1.3; }
        .quiz-desc { color: #4b5563; font-style: italic; margin-bottom: 20px; line-height: 1.6; font-size: 1rem; }
        
        .feedback { min-height: 30px; margin-top: 15px; font-weight: 700; font-size: 1.1rem; }
        .feedback.correct { color: var(--success); animation: popIn 0.3s; }
        .feedback.wrong { color: var(--error); animation: shake 0.4s; }

        /* --- Leaderboard UI NEW --- */
        .lb-container { display: flex; flex-direction: column; gap: 10px; }
        .lb-item { 
            display: flex; align-items: center; padding: 12px 16px; background: white; 
            border-radius: 16px; border: 1px solid #f3f4f6;
            transition: transform 0.2s;
        }
        .lb-item:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        .lb-rank { 
            font-weight: 800; font-size: 1rem; width: 30px; height: 30px; 
            display: flex; justify-content: center; align-items: center; 
            border-radius: 50%; background: #f3f4f6; color: #6b7280; margin-right: 12px; flex-shrink: 0;
        }
        .lb-info { flex: 1; min-width: 0; }
        .lb-name { font-weight: 700; color: #374151; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.95rem; }
        .lb-detail { font-size: 0.75rem; color: #9ca3af; margin-top: 2px; }
        .lb-score { 
            font-weight: 800; color: var(--primary); background: #ecfdf5; 
            padding: 6px 12px; border-radius: 12px; font-size: 0.9rem;
        }

        /* Top 3 Styles */
        .lb-top1 { background: linear-gradient(135deg, #fffbeb, #fff); border: 1px solid #fcd34d; }
        .lb-top1 .lb-rank { background: #f59e0b; color: white; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3); }
        
        .lb-top2 { background: linear-gradient(135deg, #f8fafc, #fff); border: 1px solid #cbd5e1; }
        .lb-top2 .lb-rank { background: #94a3b8; color: white; }

        .lb-top3 { background: linear-gradient(135deg, #fff7ed, #fff); border: 1px solid #fdba74; }
        .lb-top3 .lb-rank { background: #d97706; color: white; }

        /* --- Badges --- */
        .badges-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; justify-content: center; }
        .badge-item { 
            display: flex; align-items: center; gap: 6px; padding: 8px 12px; 
            background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; 
            font-size: 0.75rem; font-weight: 700; color: #9ca3af; opacity: 0.6; 
            filter: grayscale(1); transition: all 0.3s;
        }
        .badge-item.unlocked { 
            opacity: 1; filter: grayscale(0); border-color: var(--accent); 
            background: linear-gradient(135deg, #fffbeb, #fff); 
            color: #b45309; box-shadow: 0 4px 6px rgba(251, 191, 36, 0.1); 
            transform: scale(1.02);
        }

        /* --- Calendar UI --- */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; font-size: 0.9rem; margin-top: 10px;}
        .cal-day-header { font-weight: bold; color: #9ca3af; padding-bottom: 5px; font-size: 0.8rem; }
        .cal-day { 
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center; 
            border-radius: 10px; background: #f9fafb; color: #d1d5db; font-weight: 600;
        }
        .cal-day.active { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cal-day.today { border: 2px solid var(--accent); color: var(--text); }

        /* --- Utilities --- */
        .app-footer { text-align: center; padding: 30px 20px; margin-top: auto; color: #9ca3af; font-size: 0.85rem; }
        .heart-anim { color: #e91e63; display: inline-block; animation: heartBeat 1.5s infinite; }
        @keyframes heartBeat { 0% { transform: scale(1); } 14% { transform: scale(1.3); } 28% { transform: scale(1); } 42% { transform: scale(1.3); } 70% { transform: scale(1); } }
        
        #toast { visibility: hidden; min-width: 200px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 1000; left: 50%; bottom: 80px; transform: translateX(-50%); opacity: 0; transition: 0.3s; box-shadow: 0 10px 25px rgba(0,0,0,0.2); font-size: 0.95rem; font-weight: 500; }
        #toast.show { visibility: visible; opacity: 1; bottom: 100px; }
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 200; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 10px; display: none;}
        .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loading"><div class="spinner"></div></div>
    <div id="toast">Th√¥ng b√°o</div>

    <div id="login-screen">
        <div class="login-box">
            <div style="font-size: 4rem; margin-bottom: 15px;">ü•ã</div>
            <h1 style="color: var(--primary); margin: 0; font-size: 1.8rem; letter-spacing: -1px; margin-bottom: 10px;" id="loginTitle">Nh·∫≠p M√¥n</h1>
            <p style="color: #6b7280; margin-bottom: 30px; font-size: 1rem; line-height: 1.5;" id="loginMsg">ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u b√≠ k√≠p<br>v√† tranh ƒëo·∫°t ng√¥i v·ªã Minh Ch·ªß</p>
            <button class="btn btn-google" id="btnLogin">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" style="margin-right:10px">
                Ti·∫øp t·ª•c b·∫±ng Google
            </button>
            <p style="font-size: 0.85rem; color: #9ca3af; margin-top: 25px;">Ch√¢n nh√¢n b·∫•t l·ªô t∆∞·ªõng (Mi·ªÖn ph√≠)</p>
        </div>
    </div>

    <div id="app-screen">
        <header>
            <div class="brand">
                <span class="brand-icon">‚öïÔ∏è</span>
                <div class="brand-text">
                    <span>HiHi Med</span>
                    <span class="slogan">Tuy·ªát K·ªπ Y H·ªçc</span>
                </div>
            </div>
            <div class="user-profile">
                <div class="user-info" id="headerUserInfo">
                    <div class="user-name" id="displayUserName">Kh√°ch</div>
                    <div class="user-title" id="displayUserTitle">Lang BƒÉm</div>
                </div>
                <img id="userAvatar" class="avatar" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NmZDhkYyI+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00czLTEuNzktNC00LTRzLTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==" alt="">
                <button class="btn btn-primary btn-xs" style="display:none;" id="btnLogout">Tho√°t</button>
                <button class="btn btn-primary btn-xs" id="btnLoginHeader">V√†o</button>
            </div>
        </header>

        <div class="container">
            <div class="nav-pills">
                <div class="nav-item active" data-target="tab-quiz">üß† Luy·ªán C√¥ng</div>
                <div class="nav-item" data-target="tab-dashboard">üèÜ B·∫£ng V√†ng</div>
                <div class="nav-item" data-target="tab-manage">üìñ T√†ng Kinh C√°c</div>
            </div>

            <div id="tab-quiz" class="view active">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin:0; font-size: 1.1rem; color: var(--primary-dark);">Luy·ªán T·∫≠p <span id="limitCounter" style="font-size: 0.8rem; color: #f59e0b; display:none;">(0/10)</span></h3>
                        <select id="quizGroupSelect" style="width: auto; margin:0; padding: 6px 12px; font-size: 0.85rem; border-radius: 20px; background: #f3f4f6; border: none;">
                            <option value="all">T·∫•t c·∫£ chi√™u th·ª©c</option>
                        </select>
                    </div>

                    <div id="quizArea" class="quiz-container">
                        <div class="quiz-badge" id="qGroup">...</div>
                        
                        <div class="quiz-question" id="qQuestion">...</div>
                        <p class="quiz-desc" id="qDesc">...</p>
                        
                        <button class="btn btn-search" id="btnSearchImg">
                            üîç B·∫•m ƒë·ªÉ xem ch√¢n dung huy·ªát ƒë·∫°o (Google)
                        </button>
                        
                        <input type="text" id="qInput" placeholder="Nh·∫≠p t√™n huy·ªát (kh√¥ng c·∫ßn d·∫•u)..." autocomplete="off" style="font-size: 1.1rem; text-align: center; font-weight: 600;">
                        
                        <div class="feedback" id="qFeedback"></div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-accent" id="btnHint">üí° G·ª£i √Ω</button>
                            <button class="btn btn-secondary" id="btnShowAns">üëÅÔ∏è Xem ƒê√°p √°n</button>
                        </div>
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 12px; background: white; border: 1px solid #e5e7eb; color: #9ca3af;" id="btnNext">B·ªè qua chi√™u n√†y ‚ûú</button>
                    </div>
                    
                    <div id="emptyQuizMsg" style="display:none; text-align: center; padding: 40px 20px;">
                        <div style="font-size: 4rem; margin-bottom: 10px;">üßò</div>
                        <h2 style="margin: 0; color: var(--primary);">ƒê·∫Øc ƒê·∫°o Th√†nh Ti√™n</h2>
                        <p id="emptyMsgText" style="color: #6b7280;">H√¥m nay b·∫°n ƒë√£ luy·ªán h·∫øt c√°c b√†i c·∫ßn √¥n.</p>
                        <button class="btn btn-primary" id="btnInitData" onclick="initDefaultData()" style="margin-top: 15px;">‚ôªÔ∏è T·∫£i b√≠ k√≠p nh·∫≠p m√¥n</button>
                    </div>
                </div>
            </div>

            <div id="tab-dashboard" class="view">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div class="card" style="margin:0; text-align:center; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border:none;">
                        <div style="font-size: 2.5rem; font-weight: 800;" id="stat-streak">0</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; font-weight: 600;">Ng√†y Tu Luy·ªán</div>
                    </div>
                    <div class="card" style="margin:0; text-align:center;">
                        <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary);" id="stat-mastered">0</div>
                        <div style="font-size: 0.85rem; color: #6b7280; font-weight: 600;">Chi√™u ƒê√£ Thu·ªôc</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-top:0; margin-bottom:15px; font-size: 1.1rem; text-align: center;">üèÖ B·ªô S∆∞u T·∫≠p Danh Hi·ªáu</h3>
                    <div class="badges-container">
                        <div class="badge-item" id="badge-novice">üå± Lang BƒÉm T·∫≠p S·ª±</div>
                        <div class="badge-item" id="badge-streak3">üî• H·ªèa Nh√£n Kim Tinh (3 ng√†y)</div>
                        <div class="badge-item" id="badge-master5">üìñ S√°ch Y Ch·∫°y B·∫±ng C∆°m</div>
                        <div class="badge-item" id="badge-streak7">üì° B·∫Øt M·∫°ch Online (7 ng√†y)</div>
                        <div class="badge-item" id="badge-streak14">üèØ Th√°i Y Vi·ªán Tr∆∞·ªüng (14 ng√†y)</div>
                        <div class="badge-item" id="badge-streak30">üêâ ƒê·ªôc C√¥ C·∫ßu B·∫°i (30 ng√†y)</div>
                        <div class="badge-item" id="badge-master20">‚ú® Hoa ƒê√† T√°i Th·∫ø (20 b√†i)</div>
                        <div class="badge-item" id="badge-master50">üå©Ô∏è Th·∫ßn Y H·∫° Ph√†m (50 b√†i)</div>
                    </div>
                </div>

                <div class="card">
                    <div class="cal-header">
                        <h3 style="margin:0; font-size: 1.1rem; display:flex; align-items:center; gap:5px;">üìÖ L·ªãch S·ª≠ Tu Luy·ªán</h3>
                        <div>
                            <button class="btn btn-xs btn-primary" id="viewWeek">Tu·∫ßn</button>
                            <button class="btn btn-xs btn-secondary" id="viewMonth">Th√°ng</button>
                        </div>
                    </div>
                    <div class="cal-grid" style="margin-bottom: 5px;">
                        <div class="cal-day-header">CN</div><div class="cal-day-header">T2</div><div class="cal-day-header">T3</div><div class="cal-day-header">T4</div><div class="cal-day-header">T5</div><div class="cal-day-header">T6</div><div class="cal-day-header">T7</div>
                    </div>
                    <div id="calendarGrid" class="cal-grid"></div>
                </div>

                <h3 style="margin: 20px 0 15px; font-size: 1.2rem; color: var(--primary-dark); text-align: center; font-weight: 800;">üèÜ Thi√™n H·∫° ƒê·ªá Nh·∫•t Bang</h3>
                <div id="leaderboardList" class="lb-container">
                    <div style="text-align:center; padding: 20px; color: #9ca3af;">ƒêang tri·ªáu h·ªìi b·∫£ng x·∫øp h·∫°ng...</div>
                </div>
            </div>

            <div id="tab-manage" class="view">
                <div class="card">
                    <h3 style="margin-top:0; font-size: 1.1rem;">S√°ng T·∫°o Chi√™u Th·ª©c M·ªõi</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <input type="text" id="inpGroup" placeholder="Nh√≥m (VD: ƒêau ƒë·∫ßu)" list="groupSuggestions">
                        <input type="text" id="inpName" placeholder="T√™n Huy·ªát">
                    </div>
                    <datalist id="groupSuggestions"></datalist>
                    <textarea id="inpDesc" rows="2" placeholder="M√¥ t·∫£ v·ªã tr√≠, t√°c d·ª•ng..."></textarea>
                    <button class="btn btn-primary" id="btnAddData" style="width: 100%">üíæ L∆∞u B√≠ K√≠p</button>
                    
                    <div style="margin-top: 15px; border-top: 1px dashed #e5e7eb; padding-top: 15px;">
                        <button class="btn btn-secondary" style="width: 100%; font-size: 0.9rem;" onclick="initDefaultData()">
                            üìö T·∫£i b√≠ k√≠p m·∫´u (N·∫øu ch∆∞a c√≥)
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-top:0; font-size: 1.1rem;">T√†ng Kinh C√°c (Kho d·ªØ li·ªáu)</h3>
                    <div id="dataList" style="max-height: 500px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <footer class="app-footer">
            HiHi Med - Tuy·ªát K·ªπ Y H·ªçc &copy; 2025<br>
            Made with <span class="heart-anim">‚ù§</span> by Xu√¢n H·∫£i
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, serverTimestamp, writeBatch, orderBy, limit, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAsHD5pH6Blm4wtXKEJojFYMl24SNgiKY0",
            authDomain: "bamhuyet-6c9e6.firebaseapp.com",
            projectId: "bamhuyet-6c9e6",
            storageBucket: "bamhuyet-6c9e6.firebasestorage.app",
            messagingSenderId: "195174949274",
            appId: "1:195174949274:web:50cd99e0fad60ba8a81a23",
            measurementId: "G-W66885N5XM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let isGuest = true;
        let guestQuizCount = 0;
        const GUEST_LIMIT = 10;
        
        let acupoints = [];
        let currentQuizItem = null;
        let currentHintIndex = 0;
        let todayCheckedIn = false;
        let attendanceDates = new Set();
        let calViewMode = 'week'; 
        let isProcessing = false;
        let currentTitle = "Lang BƒÉm";

        const SRS_INTERVALS = [0, 1, 3, 7, 14, 30, 90];

        // --- B·ªò D·ªÆ LI·ªÜU M·∫™U ---
        const defaultAcupoints = [
            { group: "ƒêau ƒë·∫ßu", name: "H·ª£p C·ªëc", desc: "N·∫±m ·ªü h·ªï kh·∫©u, gi·ªØa x∆∞∆°ng ƒë·ªët b√†n ng√≥n c√°i v√† ng√≥n tr·ªè." },
            { group: "ƒêau ƒë·∫ßu", name: "Th√°i D∆∞∆°ng", desc: "Ch·ªó l√µm ph√≠a sau ƒëu√¥i l√¥ng m√†y v√† ƒëu√¥i m·∫Øt kho·∫£ng 1 th·ªën." },
            { group: "ƒêau ƒë·∫ßu", name: "·∫§n ƒê∆∞·ªùng", desc: "ƒêi·ªÉm ch√≠nh gi·ªØa ƒë∆∞·ªùng n·ªëi hai ƒë·∫ßu l√¥ng m√†y." },
            { group: "M·∫•t ng·ªß", name: "N·ªôi Quan", desc: "M·∫∑t tr∆∞·ªõc c·ªï tay, t·ª´ l·∫±n ch·ªâ ƒëo l√™n 2 th·ªën, gi·ªØa hai g√¢n." },
            { group: "M·∫•t ng·ªß", name: "D≈©ng Tuy·ªÅn", desc: "Ch·ªó l√µm d∆∞·ªõi gan b√†n ch√¢n, t·∫°i ƒëi·ªÉm n·ªëi 1/3 tr∆∞·ªõc v√† 2/3 sau." },
            { group: "ƒêau l∆∞ng", name: "·ª¶y Trung", desc: "ƒêi·ªÉm ch√≠nh gi·ªØa n·∫øp l·∫±n khoeo ch√¢n (sau ƒë·∫ßu g·ªëi)." },
            { group: "Ti√™u h√≥a", name: "T√∫c Tam L√Ω", desc: "D∆∞·ªõi m·∫Øt g·ªëi ngo√†i 3 th·ªën, c√°ch m√†o ch√†y 1 kho√°t ng√≥n tay." },
            { group: "Th∆∞ gi√£n", name: "B√°ch H·ªôi", desc: "ƒêi·ªÉm ch√≠nh gi·ªØa ƒë·ªânh ƒë·∫ßu." }
        ];

        // ELEMENTS
        const els = {
            loading: document.getElementById('loading'),
            loginScreen: document.getElementById('login-screen'),
            loginTitle: document.getElementById('loginTitle'),
            loginMsg: document.getElementById('loginMsg'),
            btnLogin: document.getElementById('btnLogin'),
            btnLoginHeader: document.getElementById('btnLoginHeader'),
            btnLogout: document.getElementById('btnLogout'),
            userAvatar: document.getElementById('userAvatar'),
            // Header Info
            headerUserInfo: document.getElementById('headerUserInfo'),
            displayUserName: document.getElementById('displayUserName'),
            displayUserTitle: document.getElementById('displayUserTitle'),
            
            navItems: document.querySelectorAll('.nav-item'),
            views: document.querySelectorAll('.view'),
            // Manage
            inpGroup: document.getElementById('inpGroup'),
            inpName: document.getElementById('inpName'),
            inpDesc: document.getElementById('inpDesc'),
            btnAddData: document.getElementById('btnAddData'),
            dataList: document.getElementById('dataList'),
            groupSuggestions: document.getElementById('groupSuggestions'),
            // Quiz
            quizGroupSelect: document.getElementById('quizGroupSelect'),
            qGroup: document.getElementById('qGroup'),
            qQuestion: document.getElementById('qQuestion'),
            qDesc: document.getElementById('qDesc'),
            qInput: document.getElementById('qInput'),
            btnSearchImg: document.getElementById('btnSearchImg'),
            qFeedback: document.getElementById('qFeedback'),
            btnShowAns: document.getElementById('btnShowAns'),
            btnHint: document.getElementById('btnHint'),
            btnNext: document.getElementById('btnNext'),
            quizArea: document.getElementById('quizArea'),
            emptyQuizMsg: document.getElementById('emptyQuizMsg'),
            emptyMsgText: document.getElementById('emptyMsgText'),
            btnInitData: document.getElementById('btnInitData'),
            limitCounter: document.getElementById('limitCounter'),
            // Stats & Cal
            statStreak: document.getElementById('stat-streak'),
            statMastered: document.getElementById('stat-mastered'),
            leaderboardList: document.getElementById('leaderboardList'),
            calendarGrid: document.getElementById('calendarGrid'),
            viewWeek: document.getElementById('viewWeek'),
            viewMonth: document.getElementById('viewMonth'),
            // Badges
            badges: {
                novice: document.getElementById('badge-novice'),
                master5: document.getElementById('badge-master5'),
                streak3: document.getElementById('badge-streak3'),
                streak7: document.getElementById('badge-streak7'),
                streak14: document.getElementById('badge-streak14'),
                streak30: document.getElementById('badge-streak30'),
                master20: document.getElementById('badge-master20'),
                master50: document.getElementById('badge-master50')
            }
        };

        // --- UTILS ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                osc.start(); osc.stop(audioCtx.currentTime + 0.4);
            } else {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            }
        }

        function cleanText(str) {
            if (!str) return "";
            str = str.toLowerCase().normalize("NFC");
            str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g, "a");
            str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g, "e");
            str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g, "i");
            str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g, "o");
            str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g, "u");
            str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g, "y");
            str = str.replace(/ƒë/g, "d");
            str = str.replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9\s]/g, ""); 
            return str.trim();
        }

        // --- AUTH ---
        function showLoginScreen(isForced = false) {
            els.loginScreen.style.display = 'flex';
            if(isForced) {
                els.loginTitle.textContent = "H·∫øt l∆∞·ª£t luy·ªán c√¥ng";
                els.loginMsg.textContent = "ƒê·∫°i hi·ªáp ƒë√£ luy·ªán ƒë·ªß 10 chi√™u. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c con ƒë∆∞·ªùng y ƒë·∫°o.";
            } else {
                els.loginTitle.textContent = "Nh·∫≠p M√¥n";
                els.loginMsg.textContent = "ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u b√≠ k√≠p v√† tranh ƒëo·∫°t ng√¥i v·ªã Minh Ch·ªß";
            }
        }

        els.btnLogin.addEventListener('click', () => signInWithPopup(auth, provider).catch(err => showToast("L·ªói: " + err.message)));
        els.btnLoginHeader.addEventListener('click', () => showLoginScreen(false));
        els.btnLogout.addEventListener('click', () => { signOut(auth); location.reload(); });

        onAuthStateChanged(auth, async (user) => {
            els.loginScreen.style.display = 'none';
            if (user) {
                isGuest = false; currentUser = user;
                els.userAvatar.src = user.photoURL;
                els.btnLogout.style.display = 'inline-block'; els.btnLoginHeader.style.display = 'none';
                els.headerUserInfo.style.display = 'block';
                els.displayUserName.textContent = user.displayName;
                
                showLoading(true);
                await Promise.all([loadData(), checkAttendance(), loadLeaderboard()]);
                showLoading(false);
                showToast(`M·ª´ng ${user.displayName} ƒë·∫°i hi·ªáp quay l·∫°i!`);
            } else {
                isGuest = true; currentUser = null; guestQuizCount = 0;
                els.btnLogout.style.display = 'none'; els.btnLoginHeader.style.display = 'inline-block';
                els.headerUserInfo.style.display = 'none'; // ·∫®n info n·∫øu l√† kh√°ch
                els.limitCounter.style.display = 'inline-block';
                els.limitCounter.textContent = `(0/${GUEST_LIMIT})`;
                
                const localData = localStorage.getItem('guest_acupoints');
                if (localData) { acupoints = JSON.parse(localData); } 
                else { acupoints = defaultAcupoints.map((item, index) => ({ id: 'guest_' + index, ...item, srsLevel: 0, nextReview: 0 })); }
                renderListGrouped(); updateGroupSelect(); prepareQuiz();
                
                // FORCE LOAD QUESTION FOR GUEST IMMEDIATELY
                startQuiz();
            }
            setupNavigation(); renderCalendar(); updateBadges();
        });

        function showLoading(show) { els.loading.style.display = show ? 'flex' : 'none'; }
        function showToast(message) {
            const x = document.getElementById("toast"); x.textContent = message;
            x.className = "show"; setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- DATA LOGIC ---
        async function loadData() {
            if(isGuest) return;
            try {
                const q = query(collection(db, "acupoints"), where("uid", "==", currentUser.uid));
                const snap = await getDocs(q);
                acupoints = [];
                snap.forEach((doc) => acupoints.push({ id: doc.id, ...doc.data() }));
                renderListGrouped(); updateGroupSelect(); prepareQuiz();
                
                // FORCE LOAD QUESTION IMMEDIATELY AFTER DATA IS READY
                startQuiz();
            } catch (e) { console.error(e); }
        }

        function renderListGrouped() {
            els.dataList.innerHTML = '';
            const groups = {};
            let masteredCount = 0;
            acupoints.forEach(item => {
                if(!groups[item.group]) groups[item.group] = [];
                groups[item.group].push(item);
                if((item.srsLevel || 0) >= 4) masteredCount++;
            });

            els.statMastered.textContent = masteredCount;

            Object.keys(groups).sort().forEach(gName => {
                const header = document.createElement('div');
                header.className = 'group-header';
                header.innerHTML = `<span>üìÇ ${gName}</span> <span style="font-size:0.8rem; opacity:0.8">${groups[gName].length} chi√™u</span>`;
                els.dataList.appendChild(header);

                groups[gName].forEach(item => {
                    const level = item.srsLevel || 0;
                    let lvClass = '';
                    if(level >= 4) lvClass = 'srs-lv-high'; else if(level >= 1) lvClass = 'srs-lv-med';
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div>
                            <div style="font-weight:600; display:flex; align-items:center;">
                                ${item.name} <span class="srs-level ${lvClass}">T·∫ßng ${level}</span>
                            </div>
                            <div style="font-size:0.85rem; color:#666; margin-top:2px">${item.desc}</div>
                        </div>
                        <button onclick="deleteAcupoint('${item.id}')" style="background:none; border:none; cursor:pointer; font-size:1.2rem; opacity:0.4; color:red;">&times;</button>
                    `;
                    els.dataList.appendChild(div);
                });
            });
            if(acupoints.length === 0) els.dataList.innerHTML = '<div style="text-align:center; padding:20px; color:#999">Ch∆∞a c√≥ b√≠ k√≠p n√†o.</div>';
        }

        window.initDefaultData = async () => {
            if(isGuest) return showToast("D·ªØ li·ªáu m·∫´u ƒë√£ c√≥ s·∫µn cho kh√°ch.");
            if(acupoints.length > 0 && !confirm("Th√™m d·ªØ li·ªáu m·∫´u v√†o danh s√°ch hi·ªán t·∫°i?")) return;
            showLoading(true);
            try {
                const batch = writeBatch(db);
                defaultAcupoints.forEach(item => {
                    const docRef = doc(collection(db, "acupoints"));
                    batch.set(docRef, {
                        uid: currentUser.uid, group: item.group, name: item.name, desc: item.desc, image: "",
                        srsLevel: 0, nextReview: 0, createdAt: serverTimestamp()
                    });
                });
                await batch.commit(); await loadData();
                showToast("‚úÖ ƒê√£ n·∫°p b√≠ k√≠p y h·ªçc!");
                document.querySelector('[data-target="tab-quiz"]').click();
            } catch(e) { showToast("L·ªói: " + e.message); }
            showLoading(false);
        }

        els.btnAddData.addEventListener('click', async () => {
            if(isGuest) return showToast("ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u b√≠ k√≠p c·ªßa ri√™ng b·∫°n.");
            const group = els.inpGroup.value.trim();
            const name = els.inpName.value.trim();
            const desc = els.inpDesc.value.trim();
            if(!group || !name) return showToast("Thi·∫øu t√™n ho·∫∑c nh√≥m!");
            showLoading(true);
            try {
                const docRef = await addDoc(collection(db, "acupoints"), {
                    uid: currentUser.uid, group, name, desc, image:"", srsLevel: 0, nextReview: 0, createdAt: serverTimestamp()
                });
                acupoints.push({ id: docRef.id, uid: currentUser.uid, group, name, desc, image:"", srsLevel: 0, nextReview: 0 });
                els.inpName.value = ''; els.inpDesc.value = '';
                renderListGrouped(); updateGroupSelect(); prepareQuiz(); showToast("ƒê√£ l∆∞u!");
            } catch (e) { showToast("L·ªói l∆∞u."); }
            showLoading(false);
        });

        window.deleteAcupoint = async (id) => {
            if(isGuest) return showToast("Kh√°ch kh√¥ng th·ªÉ x√≥a d·ªØ li·ªáu m·∫´u.");
            if(!confirm("X√≥a huy·ªát n√†y?")) return;
            showLoading(true);
            try {
                await deleteDoc(doc(db, "acupoints", id));
                acupoints = acupoints.filter(item => item.id !== id);
                renderListGrouped(); updateGroupSelect(); prepareQuiz(); showToast("ƒê√£ x√≥a.");
            } catch (e) { showToast("L·ªói x√≥a."); }
            showLoading(false);
        }

        // --- QUIZ LOGIC ---
        function prepareQuiz() {
            if(acupoints.length > 0) {
                els.quizArea.style.display = 'block'; els.emptyQuizMsg.style.display = 'none';
            } else {
                els.quizArea.style.display = 'none'; els.emptyQuizMsg.style.display = 'block';
                els.btnInitData.style.display = isGuest ? 'none' : 'inline-flex';
            }
        }

        function startQuiz() {
            isProcessing = false;
            // Ch·ªâ ch·∫°y khi ƒëang ·ªü tab Quiz
            if (!document.getElementById('tab-quiz').classList.contains('active')) return;

            if(isGuest && guestQuizCount >= GUEST_LIMIT) { showLoginScreen(true); return; }

            const filter = els.quizGroupSelect.value;
            const now = Date.now();
            let pool = acupoints.filter(i => {
                const matchGroup = (filter === 'all' || i.group === filter);
                const isDue = (i.nextReview || 0) <= now;
                return matchGroup && isDue;
            });
            
            if (pool.length === 0) {
                 els.quizArea.style.display = 'none'; els.emptyQuizMsg.style.display = 'block'; return;
            } else {
                els.quizArea.style.display = 'block'; els.emptyQuizMsg.style.display = 'none';
            }
            
            pool.sort((a, b) => (a.nextReview || 0) - (b.nextReview || 0));
            // Random nh·∫π trong 3 c√¢u ƒë·∫ßu ƒë·ªÉ ƒë·ª° ch√°n
            const idx = Math.floor(Math.random() * Math.min(3, pool.length));
            currentQuizItem = pool[idx];
            currentHintIndex = 0;

            els.qGroup.textContent = currentQuizItem.group;
            els.qQuestion.textContent = "Huy·ªát n√†y t√™n l√† g√¨?";
            els.qDesc.textContent = currentQuizItem.desc;
            els.qInput.value = '';
            els.qInput.focus();
            els.qFeedback.textContent = ''; els.qFeedback.className = 'feedback';
        }

        els.btnSearchImg.addEventListener('click', () => {
            if(!currentQuizItem) return;
            const query = encodeURIComponent(`huy·ªát ${currentQuizItem.name} v·ªã tr√≠`);
            window.open(`https://www.google.com/search?tbm=isch&q=${query}`, '_blank');
        });

        async function handleAnswer(isCorrect) {
            if(!currentQuizItem) return;
            const oldLevel = currentQuizItem.srsLevel || 0;
            let newLevel = oldLevel; let nextReview = 0;

            if (isCorrect) {
                newLevel = Math.min(oldLevel + 1, SRS_INTERVALS.length - 1);
                const days = SRS_INTERVALS[newLevel];
                nextReview = Date.now() + (days * 24 * 60 * 60 * 1000);
                playTone('correct');
                els.qFeedback.innerHTML = "üéâ Tuy·ªát v·ªùi! Ch√≠nh x√°c!";
                els.qFeedback.className = 'feedback correct';
                if(Math.random() > 0.7) confetti({ particleCount: 60, spread: 70, origin: { y: 0.6 } });
            } else {
                newLevel = 0; nextReview = Date.now();
                playTone('wrong');
                els.qFeedback.innerHTML = `Sai r·ªìi: <b>${currentQuizItem.name}</b>`;
                els.qFeedback.className = 'feedback wrong';
            }

            if(isGuest) {
                guestQuizCount++;
                els.limitCounter.textContent = `(${guestQuizCount}/${GUEST_LIMIT})`;
                currentQuizItem.srsLevel = newLevel; currentQuizItem.nextReview = nextReview;
                localStorage.setItem('guest_acupoints', JSON.stringify(acupoints));
            } else {
                try {
                    const itemRef = doc(db, "acupoints", currentQuizItem.id);
                    await updateDoc(itemRef, { srsLevel: newLevel, nextReview: nextReview });
                    currentQuizItem.srsLevel = newLevel; currentQuizItem.nextReview = nextReview;
                } catch(e) { console.error(e); }
            }

            if(isCorrect) {
                tryAutoCheckIn(); setTimeout(() => { startQuiz(); }, 1000);
            }
        }

        els.qInput.addEventListener('input', () => {
            if(!currentQuizItem || isProcessing) return;
            const inputClean = cleanText(els.qInput.value);
            const targetClean = cleanText(currentQuizItem.name);
            const inputExact = els.qInput.value.trim().toLowerCase();
            const targetExact = currentQuizItem.name.trim().toLowerCase();

            if ((inputClean.length >= 2 && inputClean === targetClean) || 
                (inputExact.length >= 2 && inputExact === targetExact)) {
                isProcessing = true;
                handleAnswer(true);
            }
        });

        els.qInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') {
                if (!isProcessing) els.btnShowAns.click();
            }
        });

        els.quizGroupSelect.addEventListener('change', startQuiz);
        els.btnNext.addEventListener('click', startQuiz);
        els.btnShowAns.addEventListener('click', () => {
            if(!currentQuizItem || isProcessing) return;
            isProcessing = true;
            handleAnswer(false);
            setTimeout(() => { isProcessing = false; els.qInput.value = currentQuizItem.name; }, 500);
        });
        
        els.btnHint.addEventListener('click', () => {
            if(!currentQuizItem) return;
            const name = currentQuizItem.name;
            if(currentHintIndex < name.length) {
                currentHintIndex++;
                els.qInput.value = name.substring(0, currentHintIndex);
                els.qInput.focus();
                els.qInput.dispatchEvent(new Event('input'));
            }
        });

        // --- STATS & BADGES ---
        async function checkAttendance() {
            if(isGuest) { els.statStreak.textContent = "0"; return; }
            const today = new Date().toISOString().split('T')[0];
            const q = query(collection(db, "attendance"), where("uid", "==", currentUser.uid));
            const snap = await getDocs(q);
            attendanceDates.clear(); snap.forEach(doc => attendanceDates.add(doc.data().date));
            const streakCount = attendanceDates.size;
            todayCheckedIn = attendanceDates.has(today);
            els.statStreak.textContent = streakCount;
            updateBadges(streakCount);

            // C·∫≠p nh·∫≠t danh hi·ªáu l√™n Header v√† Firebase
            els.displayUserTitle.textContent = currentTitle;

            try {
                await setDoc(doc(db, "profiles", currentUser.uid), {
                    displayName: currentUser.displayName, streak: streakCount, 
                    photoURL: currentUser.photoURL, lastActive: serverTimestamp(),
                    title: currentTitle
                }, { merge: true });
            } catch(e) {}
        }

        function updateBadges(streak = 0) {
            els.badges.novice.classList.add('unlocked');
            currentTitle = "Lang BƒÉm T·∫≠p S·ª±"; // Default

            const mastered = acupoints.filter(i => (i.srsLevel || 0) >= 4).length;

            // Logic x√©t danh hi·ªáu cao nh·∫•t ƒë·ªÉ hi·ªÉn th·ªã
            if (mastered >= 5) { els.badges.master5.classList.add('unlocked'); }
            if (streak >= 3) { els.badges.streak3.classList.add('unlocked'); currentTitle = "H·ªèa Nh√£n Kim Tinh"; }
            if (streak >= 7) { els.badges.streak7.classList.add('unlocked'); currentTitle = "B·∫Øt M·∫°ch Online"; }
            if (streak >= 14) { els.badges.streak14.classList.add('unlocked'); currentTitle = "Th√°i Y Vi·ªán Tr∆∞·ªüng"; }
            if (streak >= 30) { els.badges.streak30.classList.add('unlocked'); currentTitle = "ƒê·ªôc C√¥ C·∫ßu B·∫°i"; }
            
            if (mastered >= 20) { els.badges.master20.classList.add('unlocked'); currentTitle = "Hoa ƒê√† T√°i Th·∫ø"; }
            if (mastered >= 50) { els.badges.master50.classList.add('unlocked'); currentTitle = "Th·∫ßn Y H·∫° Ph√†m"; }
        }

        async function tryAutoCheckIn() {
            if(isGuest || todayCheckedIn) return;
            try {
                const today = new Date().toISOString().split('T')[0];
                await addDoc(collection(db, "attendance"), { uid: currentUser.uid, date: today, timestamp: serverTimestamp() });
                todayCheckedIn = true; attendanceDates.add(today);
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                showToast("‚úÖ ƒêi·ªÉm danh th√†nh c√¥ng!");
                checkAttendance(); renderCalendar(); 
            } catch(e) { console.error(e); }
        }

        async function loadLeaderboard() {
            try {
                const q = query(collection(db, "profiles"), orderBy("streak", "desc"), limit(20));
                const snap = await getDocs(q);
                els.leaderboardList.innerHTML = '';
                let rank = 1;
                snap.forEach(doc => {
                    const data = doc.data();
                    const isMe = currentUser && doc.id === currentUser.uid;
                    const div = document.createElement('div');
                    let rankClass = '';
                    if (rank === 1) rankClass = 'lb-top1'; else if (rank === 2) rankClass = 'lb-top2'; else if (rank === 3) rankClass = 'lb-top3';
                    
                    div.className = `lb-item ${rankClass}`;
                    if(isMe) div.style.borderLeft = '4px solid var(--primary)';
                    
                    div.innerHTML = `
                        <div class="lb-rank">${rank}</div>
                        <img src="${data.photoURL}" class="avatar" style="width:36px; height:36px; margin-right:12px; border:none;">
                        <div class="lb-info">
                            <div class="lb-name">${data.displayName} ${isMe ? '(B·∫°n)' : ''}</div>
                            <div class="lb-detail">${data.title || 'Lang BƒÉm'}</div>
                        </div>
                        <div class="lb-score">${data.streak} ng√†y</div>`;
                    els.leaderboardList.appendChild(div);
                    rank++;
                });
            } catch(e) {
                els.leaderboardList.innerHTML = '<div style="text-align:center; padding:10px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem BXH</div>';
            }
        }

        els.viewWeek.addEventListener('click', () => { calViewMode = 'week'; renderCalendar(); });
        els.viewMonth.addEventListener('click', () => { calViewMode = 'month'; renderCalendar(); });

        function renderCalendar() {
            if(calViewMode === 'week') { els.viewWeek.className = 'btn btn-xs btn-primary'; els.viewMonth.className = 'btn btn-xs btn-secondary'; } 
            else { els.viewWeek.className = 'btn btn-xs btn-secondary'; els.viewMonth.className = 'btn btn-xs btn-primary'; }
            const today = new Date(); els.calendarGrid.innerHTML = '';
            let startDate, daysToRender;
            if (calViewMode === 'month') {
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                const dayOfWeek = startDate.getDay(); startDate.setDate(startDate.getDate() - dayOfWeek); daysToRender = 42; 
            } else {
                startDate = new Date(today); startDate.setDate(today.getDate() - today.getDay()); daysToRender = 7;
            }
            for (let i = 0; i < daysToRender; i++) {
                const currentDate = new Date(startDate); currentDate.setDate(startDate.getDate() + i);
                const year = currentDate.getFullYear(); const month = String(currentDate.getMonth() + 1).padStart(2, '0'); const day = String(currentDate.getDate()).padStart(2, '0');
                const dateString = `${year}-${month}-${day}`;
                const hasStudied = attendanceDates.has(dateString);
                const isCurrentMonth = currentDate.getMonth() === today.getMonth();
                const opacity = (calViewMode === 'month' && !isCurrentMonth) ? '0.3' : '1';
                const div = document.createElement('div');
                div.className = `cal-day ${hasStudied ? 'active' : ''}`;
                if (today.getDate() === currentDate.getDate() && today.getMonth() === currentDate.getMonth()) div.classList.add('today');
                div.style.opacity = opacity; div.textContent = currentDate.getDate();
                els.calendarGrid.appendChild(div);
            }
        }

        function setupNavigation() {
            els.navItems.forEach(tab => {
                tab.addEventListener('click', () => {
                    els.navItems.forEach(t => t.classList.remove('active'));
                    els.views.forEach(v => v.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.target).classList.add('active');
                    if(tab.dataset.target === 'tab-quiz') startQuiz();
                    if(tab.dataset.target === 'tab-dashboard') loadLeaderboard();
                });
            });
        }

        function updateGroupSelect() {
            const groups = [...new Set(acupoints.map(i => i.group))];
            els.groupSuggestions.innerHTML = groups.map(g => `<option value="${g}">`).join('');
            const currentVal = els.quizGroupSelect.value;
            els.quizGroupSelect.innerHTML = '<option value="all">T·∫•t c·∫£ chi√™u th·ª©c</option>';
            groups.forEach(g => {
                const opt = document.createElement('option'); opt.value = g; opt.textContent = g;
                els.quizGroupSelect.appendChild(opt);
            });
            if(groups.includes(currentVal)) els.quizGroupSelect.value = currentVal;
        }
    </script>
</body>
</html>
