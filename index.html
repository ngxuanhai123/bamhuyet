<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiHi Med - N√¢ng C·∫•p</title>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #00695c;
            --primary-dark: #004d40;
            --primary-light: #b2dfdb;
            --accent: #ffb300; 
            --bg: #f3f4f6;
            --surface: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --success: #10b981;
            --error: #ef4444;
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Components --- */
        .btn {
            padding: 10px 18px; border: none; border-radius: 12px; cursor: pointer;
            font-weight: 600; font-size: 0.95rem; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0, 105, 92, 0.3); }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-accent { background: var(--accent); color: #fff; box-shadow: 0 4px 12px rgba(255, 179, 0, 0.3); }
        .btn-search { 
            background: #eff6ff; color: #2563eb; border: 1px dashed #bfdbfe; 
            width: 100%; margin-bottom: 15px; font-size: 0.9rem;
        }
        .btn-search:hover { background: #dbeafe; }
        .btn-google { background: white; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; }
        .btn-xs { padding: 6px 12px; font-size: 0.8rem; border-radius: 8px; }
        .btn-icon { padding: 8px; border-radius: 50%; background: transparent; color: var(--text-light); cursor: pointer; border: none;}
        .btn-icon:hover { background: #f3f4f6; color: var(--primary); }

        .card {
            background: var(--surface); border-radius: var(--radius); padding: 20px;
            margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.8);
            position: relative; overflow: hidden;
        }
        
        input, select, textarea {
            width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px;
            font-size: 1rem; margin-bottom: 12px; font-family: inherit; transition: border-color 0.2s;
        }
        input:focus, textarea:focus { border-color: var(--primary); background: #fff; ring: 2px solid var(--primary-light); }

        /* --- Layout --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 105, 92, 0.98);
            display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 24px;
            text-align: center; width: 90%; max-width: 380px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.4s ease;
        }

        #app-screen { display: flex; flex: 1; flex-direction: column; }

        header {
            background: var(--surface); padding: 12px 16px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 50; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .brand { 
            font-weight: 800; color: var(--primary); font-size: 1.3rem; 
            display: flex; align-items: center; gap: 8px; 
        }
        .brand-icon { font-size: 2rem; } 
        .brand-text { display: flex; flex-direction: column; line-height: 1; }
        .slogan { font-size: 0.65rem; font-weight: 600; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;}
        
        .user-profile { display: flex; align-items: center; gap: 10px; }
        .user-info { text-align: right; display: none; }
        .user-name { font-weight: 700; font-size: 0.9rem; color: var(--text); }
        .user-title { font-size: 0.75rem; color: var(--accent); font-weight: 600; text-transform: uppercase; }
        
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); background: #eee; }

        .container { max-width: 800px; margin: 0 auto; width: 100%; padding: 16px; flex: 1; }

        /* --- Tabs --- */
        .nav-pills { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch;}
        .nav-item {
            padding: 10px 20px; border-radius: 25px; background: white; color: #6b7280;
            font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.3s; border: 1px solid #e5e7eb;
        }
        .nav-item.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 6px rgba(0, 105, 92, 0.2); }

        /* --- Views --- */
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Quiz UI --- */
        .quiz-container { text-align: center; padding: 10px 0; }
        .quiz-badge { display: inline-block; padding: 6px 16px; background: #ecfdf5; color: var(--primary); border-radius: 20px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 0.5px; border: 1px solid #a7f3d0; }
        .quiz-question { font-size: 1.5rem; color: #111827; margin: 10px 0; font-weight: 800; line-height: 1.3; }
        .quiz-desc { color: #4b5563; font-style: italic; margin-bottom: 20px; line-height: 1.6; font-size: 1rem; }
        
        .feedback { min-height: 30px; margin-top: 15px; font-weight: 700; font-size: 1.1rem; }
        .feedback.correct { color: var(--success); animation: popIn 0.3s; }
        .feedback.wrong { color: var(--error); animation: shake 0.4s; }

        /* --- Library UI (T√†ng Kinh C√°c) --- */
        .lib-search-box { position: sticky; top: 0; background: var(--surface); z-index: 10; padding: 10px 0; margin-bottom: 10px; }
        .lib-controls { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
        
        .accordion-item { border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 8px; overflow: hidden; background: white; }
        .accordion-header { 
            padding: 12px 16px; background: #f9fafb; cursor: pointer; font-weight: 600; 
            display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;
        }
        .accordion-header:hover { background: #f3f4f6; }
        .accordion-header.active { background: #e0f2f1; color: var(--primary); }
        .accordion-content { display: none; padding: 10px; background: white; }
        .accordion-content.open { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }

        .lib-card { 
            border: 1px solid #f3f4f6; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; gap: 4px;
            cursor: pointer; transition: all 0.2s; position: relative;
        }
        .lib-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-color: var(--primary-light); }
        .lib-code { font-size: 0.7rem; font-weight: 800; color: var(--text-light); text-transform: uppercase; background: #f3f4f6; padding: 2px 6px; border-radius: 4px; width: fit-content; }
        .lib-name { font-weight: 700; font-size: 0.95rem; color: var(--text); }
        .lib-srs { font-size: 0.75rem; color: var(--success); font-weight: 600; display: flex; align-items: center; gap: 2px; }
        .lib-del { position: absolute; top: 5px; right: 5px; opacity: 0; transition: 0.2s; color: var(--error); background: none; border: none; cursor: pointer; font-size: 1.1rem;}
        .lib-card:hover .lib-del { opacity: 1; }

        /* Feature: Treats Tag */
        .tag-treat {
            font-size: 0.7rem; color: var(--primary-dark); background: var(--primary-light); 
            padding: 2px 6px; border-radius: 6px; margin-top: 4px; display: inline-block; 
            font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;
        }

        /* Modal Details & Edit */
        #detailModal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; justify-content: center; align-items: flex-end;
        }
        #detailModal.show { display: flex; animation: fadeIn 0.2s; }
        .detail-sheet {
            background: white; width: 100%; max-width: 600px; 
            border-radius: 20px 20px 0 0; padding: 25px;
            animation: slideUp 0.3s; max-height: 85vh; overflow-y: auto;
            display: flex; flex-direction: column;
        }
        @media(min-width: 600px) {
            #detailModal { align-items: center; }
            .detail-sheet { border-radius: 20px; width: 90%; }
        }

        /* --- Leaderboard UI --- */
        .lb-container { display: flex; flex-direction: column; gap: 10px; }
        .lb-item { 
            display: flex; align-items: center; padding: 12px 16px; background: white; 
            border-radius: 16px; border: 1px solid #f3f4f6;
            transition: transform 0.2s;
        }
        .lb-rank { 
            font-weight: 800; font-size: 1rem; width: 30px; height: 30px; 
            display: flex; justify-content: center; align-items: center; 
            border-radius: 50%; background: #f3f4f6; color: #6b7280; margin-right: 12px; flex-shrink: 0;
        }
        .lb-info { flex: 1; min-width: 0; }
        .lb-name { font-weight: 700; color: #374151; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.95rem; }
        .lb-detail { font-size: 0.75rem; color: #9ca3af; margin-top: 2px; }
        .lb-score { 
            font-weight: 800; color: var(--primary); background: #ecfdf5; 
            padding: 6px 12px; border-radius: 12px; font-size: 0.9rem;
        }
        .lb-top1 { background: linear-gradient(135deg, #fffbeb, #fff); border: 1px solid #fcd34d; }
        .lb-top1 .lb-rank { background: #f59e0b; color: white; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3); }
        .lb-top2 { background: linear-gradient(135deg, #f8fafc, #fff); border: 1px solid #cbd5e1; }
        .lb-top2 .lb-rank { background: #94a3b8; color: white; }
        .lb-top3 { background: linear-gradient(135deg, #fff7ed, #fff); border: 1px solid #fdba74; }
        .lb-top3 .lb-rank { background: #d97706; color: white; }

        /* --- Badges --- */
        .badges-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; justify-content: center; }
        .badge-item { 
            display: flex; align-items: center; gap: 6px; padding: 8px 12px; 
            background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; 
            font-size: 0.75rem; font-weight: 700; color: #9ca3af; opacity: 0.6; 
            filter: grayscale(1); transition: all 0.3s;
        }
        .badge-item.unlocked { 
            opacity: 1; filter: grayscale(0); border-color: var(--accent); 
            background: linear-gradient(135deg, #fffbeb, #fff); 
            color: #b45309; box-shadow: 0 4px 6px rgba(251, 191, 36, 0.1); 
            transform: scale(1.02);
        }

        /* --- Calendar UI --- */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; font-size: 0.9rem; margin-top: 10px;}
        .cal-day-header { font-weight: bold; color: #9ca3af; padding-bottom: 5px; font-size: 0.8rem; }
        .cal-day { 
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center; 
            border-radius: 10px; background: #f9fafb; color: #d1d5db; font-weight: 600;
        }
        .cal-day.active { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cal-day.today { border: 2px solid var(--accent); color: var(--text); }

        /* --- Utilities --- */
        .app-footer { text-align: center; padding: 30px 20px; margin-top: auto; color: #9ca3af; font-size: 0.85rem; }
        .heart-anim { color: #e91e63; display: inline-block; animation: heartBeat 1.5s infinite; }
        @keyframes heartBeat { 0% { transform: scale(1); } 14% { transform: scale(1.3); } 28% { transform: scale(1); } 42% { transform: scale(1.3); } 70% { transform: scale(1); } }
        
        #toast { visibility: hidden; min-width: 200px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 1000; left: 50%; bottom: 80px; transform: translateX(-50%); opacity: 0; transition: 0.3s; box-shadow: 0 10px 25px rgba(0,0,0,0.2); font-size: 0.95rem; font-weight: 500; }
        #toast.show { visibility: visible; opacity: 1; bottom: 100px; }
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 200; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 10px; display: none;}
        .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- Floating Home Button --- */
        .floating-home-btn {
            position: fixed; bottom: 30px; left: 20px; z-index: 900;
            display: flex; align-items: center; gap: 10px; padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 50px;
            color: var(--primary); text-decoration: none; font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); transition: all 0.3s ease;
        }
        .floating-home-btn:hover { background: linear-gradient(90deg, #4db6ac, #00695c); transform: translateY(-3px); color: white; border-color: transparent; }
        .floating-home-btn svg { width: 24px; height: 24px; transition: transform 0.3s ease; }
        .floating-home-btn:hover svg { transform: scale(1.1); }
        @media (max-width: 640px) { .floating-home-btn span { display: none; } .floating-home-btn { padding: 12px; border-radius: 50%; bottom: 20px; left: 15px; } }

    </style>
</head>
<body>

    <a href="https://ngxuanhai123.github.io/" class="floating-home-btn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        <span>Trang ch·ªß</span>
    </a>

    <div id="loading"><div class="spinner"></div></div>
    <div id="toast">Th√¥ng b√°o</div>

    <div id="detailModal">
        <div class="detail-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div>
                    <span id="modalCode" style="background:var(--primary); color:white; padding:4px 8px; border-radius:6px; font-weight:800; font-size:0.8rem;">CODE</span>
                    <button id="btnEditModal" class="btn-icon" title="Ch·ªânh s·ª≠a" style="margin-left: 10px;">‚úèÔ∏è</button>
                </div>
                <button onclick="document.getElementById('detailModal').classList.remove('show')" style="border:none; background:none; font-size:1.5rem; color:#999; cursor:pointer;">&times;</button>
            </div>

            <!-- MODE: VIEW -->
            <div id="modalViewContent">
                <h2 id="modalName" style="margin:0 0 5px 0; color:var(--primary-dark);">T√™n Huy·ªát</h2>
                <div id="modalGroup" style="color:var(--text-light); font-size:0.9rem; font-style:italic; margin-bottom:10px;">Nh√≥m huy·ªát</div>
                
                <div id="modalTreatsContainer" style="margin-bottom: 15px;">
                    <!-- Tags treats will be here -->
                </div>

                <div style="background:#f9fafb; padding:15px; border-radius:12px; margin-bottom:20px;">
                    <h4 style="margin:0 0 8px 0;">V·ªã tr√≠ & M√¥ t·∫£</h4>
                    <p id="modalDesc" style="margin:0; line-height:1.6; color:#4b5563;">M√¥ t·∫£ chi ti·∫øt...</p>
                </div>
                
                <button class="btn btn-search" id="modalSearchBtn">üîç Xem h√¨nh ·∫£nh tr√™n Google</button>
            </div>

            <!-- MODE: EDIT -->
            <div id="modalEditContent" style="display: none;">
                <h3 style="margin-top:0; color: var(--primary);">Ch·ªânh s·ª≠a Huy·ªát</h3>
                <label style="font-size: 0.85rem; font-weight: 600; color: #666;">Nh√≥m huy·ªát</label>
                <input type="text" id="editGroup" placeholder="Nh√≥m">
                
                <label style="font-size: 0.85rem; font-weight: 600; color: #666;">T√™n huy·ªát</label>
                <input type="text" id="editName" placeholder="T√™n huy·ªát">
                
                <label style="font-size: 0.85rem; font-weight: 600; color: #666;">Ch·ªß tr·ªã (B·ªánh ch·ªØa ƒë∆∞·ª£c)</label>
                <input type="text" id="editTreats" placeholder="VD: ƒêau ƒë·∫ßu, m·∫•t ng·ªß...">

                <label style="font-size: 0.85rem; font-weight: 600; color: #666;">M√¥ t·∫£ / V·ªã tr√≠</label>
                <textarea id="editDesc" rows="4" placeholder="M√¥ t·∫£..."></textarea>
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-primary" id="btnSaveEdit" style="flex:1;">L∆∞u Thay ƒê·ªïi</button>
                    <button class="btn btn-secondary" onclick="toggleEditMode(false)" style="flex:1;">H·ªßy</button>
                </div>
            </div>

        </div>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <div style="font-size: 4rem; margin-bottom: 15px;">ü•ã</div>
            <h1 style="color: var(--primary); margin: 0; font-size: 1.8rem; letter-spacing: -1px; margin-bottom: 10px;" id="loginTitle">Nh·∫≠p M√¥n</h1>
            <p style="color: #6b7280; margin-bottom: 30px; font-size: 1rem; line-height: 1.5;" id="loginMsg">ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u b√≠ k√≠p<br>v√† tranh ƒëo·∫°t ng√¥i v·ªã Minh Ch·ªß</p>
            <button class="btn btn-google" id="btnLogin">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" style="margin-right:10px">
                Ti·∫øp t·ª•c b·∫±ng Google
            </button>
            <p style="font-size: 0.85rem; color: #9ca3af; margin-top: 25px;">Ch√¢n nh√¢n b·∫•t l·ªô t∆∞·ªõng (Mi·ªÖn ph√≠)</p>
        </div>
    </div>

    <div id="app-screen">
        <header>
            <div class="brand">
                <span class="brand-icon">‚öïÔ∏è</span>
                <div class="brand-text">
                    <span>HiHi Med</span>
                    <span class="slogan">Tuy·ªát K·ªπ Y H·ªçc: Ch·ªØa ƒë∆∞·ª£c l√† nh·ªù thu·ªëc, kh√¥ng ch·ªØa ƒë∆∞·ª£c l√† t·∫°i‚Ä¶ duy√™n ph·∫≠n</span>
                </div>
            </div>
            <div class="user-profile">
                <div class="user-info" id="headerUserInfo">
                    <div class="user-name" id="displayUserName">Kh√°ch</div>
                    <div class="user-title" id="displayUserTitle">Lang BƒÉm</div>
                </div>
                <img id="userAvatar" class="avatar" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NmZDhkYyI+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00czLTEuNzktNC00LTRzLTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==" alt="">
                <button class="btn btn-primary btn-xs" style="display:none;" id="btnLogout">Tho√°t</button>
                <button class="btn btn-primary btn-xs" id="btnLoginHeader">V√†o</button>
            </div>
        </header>

        <div class="container">
            <div class="nav-pills">
                <div class="nav-item active" data-target="tab-quiz">üß† Luy·ªán C√¥ng</div>
                <div class="nav-item" data-target="tab-dashboard">üèÜ B·∫£ng V√†ng</div>
                <div class="nav-item" data-target="tab-manage">üìñ T√†ng Kinh C√°c</div>
            </div>

            <div id="tab-quiz" class="view active">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin:0; font-size: 1.1rem; color: var(--primary-dark);">Luy·ªán T·∫≠p <span id="limitCounter" style="font-size: 0.8rem; color: #f59e0b; display:none;">(0/10)</span></h3>
                        <select id="quizGroupSelect" style="width: auto; margin:0; padding: 6px 12px; font-size: 0.85rem; border-radius: 20px; background: #f3f4f6; border: none;">
                            <option value="all">T·∫•t c·∫£ chi√™u th·ª©c</option>
                        </select>
                    </div>

                    <div id="quizArea" class="quiz-container">
                        <div class="quiz-badge" id="qGroup">...</div>
                        
                        <div class="quiz-question" id="qQuestion">...</div>
                        <p class="quiz-desc" id="qDesc">...</p>
                        
                        <button class="btn btn-search" id="btnSearchImg">
                            üîç B·∫•m ƒë·ªÉ xem ch√¢n dung huy·ªát ƒë·∫°o (Google)
                        </button>
                        
                        <input type="text" id="qInput" placeholder="Nh·∫≠p t√™n huy·ªát..." autocomplete="off" style="font-size: 1.1rem; text-align: center; font-weight: 600;">
                        
                        <div class="feedback" id="qFeedback"></div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-accent" id="btnHint">üí° G·ª£i √Ω</button>
                            <button class="btn btn-secondary" id="btnShowAns">üëÅÔ∏è Xem ƒê√°p √°n</button>
                        </div>
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 12px; background: white; border: 1px solid #e5e7eb; color: #9ca3af;" id="btnNext">B·ªè qua chi√™u n√†y ‚ûú</button>
                    </div>
                    
                    <div id="emptyQuizMsg" style="display:none; text-align: center; padding: 40px 20px;">
                        <div style="font-size: 4rem; margin-bottom: 10px;">üßò</div>
                        <h2 style="margin: 0; color: var(--primary);">ƒê·∫Øc ƒê·∫°o Th√†nh Ti√™n</h2>
                        <p id="emptyMsgText" style="color: #6b7280;">H√¥m nay b·∫°n ƒë√£ luy·ªán h·∫øt c√°c b√†i c·∫ßn √¥n.</p>
                        <button class="btn btn-primary" id="btnInitData" onclick="initDefaultData()" style="margin-top: 15px;">‚ôªÔ∏è T·∫£i b√≠ k√≠p nh·∫≠p m√¥n (361 Huy·ªát)</button>
                    </div>
                </div>
            </div>

            <div id="tab-dashboard" class="view">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div class="card" style="margin:0; text-align:center; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border:none;">
                        <div style="font-size: 2.5rem; font-weight: 800;" id="stat-streak">0</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; font-weight: 600;">Ng√†y Tu Luy·ªán</div>
                    </div>
                    <div class="card" style="margin:0; text-align:center;">
                        <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary);" id="stat-mastered">0</div>
                        <div style="font-size: 0.85rem; color: #6b7280; font-weight: 600;">Chi√™u ƒê√£ Thu·ªôc</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-top:0; margin-bottom:15px; font-size: 1.1rem; text-align: center;">üèÖ B·ªô S∆∞u T·∫≠p Danh Hi·ªáu</h3>
                    <div class="badges-container">
                        <div class="badge-item" id="badge-novice">üå± Lang BƒÉm T·∫≠p S·ª±</div>
                        <div class="badge-item" id="badge-streak3">üî• H·ªèa Nh√£n Kim Tinh (3 ng√†y)</div>
                        <div class="badge-item" id="badge-master5">üìñ S√°ch Y Ch·∫°y B·∫±ng C∆°m</div>
                        <div class="badge-item" id="badge-streak7">üì° B·∫Øt M·∫°ch Online (7 ng√†y)</div>
                        <div class="badge-item" id="badge-streak14">üèØ Th√°i Y Vi·ªán Tr∆∞·ªüng (14 ng√†y)</div>
                        <div class="badge-item" id="badge-streak30">üêâ ƒê·ªôc C√¥ C·∫ßu B·∫°i (30 ng√†y)</div>
                        <div class="badge-item" id="badge-master20">‚ú® Hoa ƒê√† T√°i Th·∫ø (20 b√†i)</div>
                        <div class="badge-item" id="badge-master50">üå©Ô∏è Th·∫ßn Y H·∫° Ph√†m (50 b√†i)</div>
                    </div>
                </div>

                <div class="card">
                    <div class="cal-header">
                        <h3 style="margin:0; font-size: 1.1rem; display:flex; align-items:center; gap:5px;">üìÖ L·ªãch S·ª≠ Tu Luy·ªán</h3>
                        <div>
                            <button class="btn btn-xs btn-primary" id="viewWeek">Tu·∫ßn</button>
                            <button class="btn btn-xs btn-secondary" id="viewMonth">Th√°ng</button>
                        </div>
                    </div>
                    <div class="cal-grid" style="margin-bottom: 5px;">
                        <div class="cal-day-header">CN</div><div class="cal-day-header">T2</div><div class="cal-day-header">T3</div><div class="cal-day-header">T4</div><div class="cal-day-header">T5</div><div class="cal-day-header">T6</div><div class="cal-day-header">T7</div>
                    </div>
                    <div id="calendarGrid" class="cal-grid"></div>
                </div>

                <h3 style="margin: 20px 0 15px; font-size: 1.2rem; color: var(--primary-dark); text-align: center; font-weight: 800;">üèÜ Thi√™n H·∫° ƒê·ªá Nh·∫•t Bang</h3>
                <div id="leaderboardList" class="lb-container">
                    <div style="text-align:center; padding: 20px; color: #9ca3af;">ƒêang tri·ªáu h·ªìi b·∫£ng x·∫øp h·∫°ng...</div>
                </div>
            </div>

            <div id="tab-manage" class="view">
                <div class="card">
                    <h3 style="margin-top:0; font-size: 1.2rem; display:flex; justify-content:space-between; align-items:center;">
                        üìñ T√†ng Kinh C√°c
                        <button class="btn btn-xs btn-secondary" onclick="document.getElementById('addForm').style.display = document.getElementById('addForm').style.display=='none'?'block':'none'">+ Th√™m m·ªõi</button>
                    </h3>
                    
                    <div id="addForm" style="display:none; margin-bottom:15px; padding:15px; background:#f9fafb; border-radius:12px;">
                        <input type="text" id="inpGroup" placeholder="Nh√≥m (VD: Ph·∫ø Kinh)" list="groupSuggestions">
                        <input type="text" id="inpName" placeholder="T√™n Huy·ªát (VD: LU1 Trung Ph·ªß)">
                        <!-- Updated: Treats Input -->
                        <input type="text" id="inpTreats" placeholder="Ch·ªß tr·ªã (VD: Ho, suy·ªÖn, ƒëau ng·ª±c...)">
                        <textarea id="inpDesc" rows="2" placeholder="M√¥ t·∫£ v·ªã tr√≠..."></textarea>
                        <button class="btn btn-primary" id="btnAddData" style="width: 100%">L∆∞u</button>
                        <datalist id="groupSuggestions"></datalist>
                    </div>

                    <div class="lib-search-box">
                        <div class="lib-controls">
                            <!-- Updated: Smart Search Placeholder -->
                            <input type="text" id="libSearch" placeholder="üîç T√¨m t√™n ho·∫∑c b·ªánh..." style="margin:0;">
                            <select id="libFilter" style="margin:0; width:auto;">
                                <option value="all">T·∫•t c·∫£</option>
                                <option value="learned">ƒê√£ thu·ªôc</option>
                                <option value="new">Ch∆∞a h·ªçc</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="libraryContent">
                        </div>
                    
                    <div style="margin-top: 20px; text-align:center;">
                         <button class="btn btn-secondary btn-xs" onclick="initDefaultData()">‚ôªÔ∏è Kh√¥i ph·ª•c g·ªëc (361 huy·ªát)</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="app-footer">
            HiHi Med - Tuy·ªát K·ªπ Y H·ªçc &copy; 2025<br>
            Made with <span class="heart-anim">‚ù§</span> by Xu√¢n H·∫£i
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, serverTimestamp, writeBatch, orderBy, limit, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAsHD5pH6Blm4wtXKEJojFYMl24SNgiKY0",
            authDomain: "bamhuyet-6c9e6.firebaseapp.com",
            projectId: "bamhuyet-6c9e6",
            storageBucket: "bamhuyet-6c9e6.firebasestorage.app",
            messagingSenderId: "195174949274",
            appId: "1:195174949274:web:50cd99e0fad60ba8a81a23",
            measurementId: "G-W66885N5XM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let isGuest = true;
        let guestQuizCount = 0;
        const GUEST_LIMIT = 10;
        
        let acupoints = [];
        let currentQuizItem = null;
        let currentEditingItem = null; // Store item being edited
        let currentHintIndex = 0;
        let todayCheckedIn = false;
        let attendanceDates = new Set();
        let calViewMode = 'week'; 
        let isProcessing = false;
        let currentTitle = "Lang BƒÉm";

        const SRS_INTERVALS = [0, 1, 3, 7, 14, 30, 90];

        // --- FULL 361 HUY·ªÜT V·ªä ---
        const createPoints = (code, groupName, names) => {
            return names.map((n, i) => ({
                group: groupName,
                name: `${code}${i+1} ${n}`,
                desc: `Huy·ªát th·ª© ${i+1} c·ªßa ${groupName}.`,
                treats: "" // Default empty field
            }));
        };

        // Danh s√°ch t√™n huy·ªát
        const luNames = ["Trung Ph·ªß","V√¢n M√¥n","Thi√™n Ph·ªß","Hi·ªáp B·∫°ch","X√≠ch Tr·∫°ch","Kh·ªïng T·ªëi","Li·ªát Khuy·∫øt","Kinh C·ª´","Th√°i Uy√™n","Ng∆∞ T·∫ø","Thi·∫øu Th∆∞∆°ng"];
        const liNames = ["Th∆∞∆°ng D∆∞∆°ng","Nh·ªã Gian","Tam Gian","H·ª£p C·ªëc","D∆∞∆°ng Kh√™","Thi√™n L·ªãch","√în L∆∞u","H·∫° Li√™m","Th∆∞·ª£ng Li√™m","Th·ªß Tam L√Ω","Kh√∫c Tr√¨","Tr·ª≠u Li√™u","Th·ªß Ng≈© L√Ω","T√≠ Nhu","Ki√™n Ngung","C·ª± C·ªët","Thi√™n ƒê·ªânh","Ph√π ƒê·ªôt","H√≤a Li√™u","Nghinh H∆∞∆°ng"];
        const stNames = ["Th·ª´a Kh·∫•p","T·ª© B·∫°ch","C·ª± Li√™u","ƒê·ªãa Th∆∞∆°ng","ƒê·∫°i Ngh√™nh","Gi√°p Xa","H·∫° Quan","ƒê·∫ßu Duy","Nh√¢n Ngh√™nh","Th·ªßy ƒê·ªôt","Kh√≠ X√°","Khuy·∫øt B·ªìn","Kh√≠ H·ªô","Kh·ªë Ph√≤ng","·ªêc ·∫æ","∆Øng Song","Nh≈© Trung","Nh≈© CƒÉn","B·∫•t Dung","Th·ª´a M√£n","L∆∞∆°ng M√¥n","Quan M√¥n","Th√°i ·∫§t","Ho·∫°t Nh·ª•c M√¥n","Thi√™n Khu","Ngo·∫°i LƒÉng","ƒê·∫°i C·ª±","Th·ªßy ƒê·∫°o","Quy Lai","Kh√≠ Xung","B·ªÖ Quan","Ph·ª•c Th·ªè","√Çm Th·ªã","L∆∞∆°ng Kh√¢u","ƒê·ªôc T·ªã","T√∫c Tam L√Ω","Th∆∞·ª£ng C·ª± H∆∞","ƒêi·ªÅu Kh·∫©u","H·∫° C·ª± H∆∞","Phong Long","Gi·∫£i Kh√™","Xung D∆∞∆°ng","H√£m C·ªëc","N·ªôi ƒê√¨nh","L·ªá ƒêo√†i"];
        const spNames = ["·∫®n B·∫°ch","ƒê·∫°i ƒê√¥","Th√°i B·∫°ch","C√¥ng T√¥n","Th∆∞∆°ng Kh√¢u","Tam √Çm Giao","L·∫≠u C·ªëc","ƒê·ªãa C∆°","√Çm LƒÉng Tuy·ªÅn","Huy·∫øt H·∫£i","C∆° M√¥n","Xung M√¥n","Ph·ªß X√°","Ph√∫c K·∫øt","ƒê·∫°i Ho√†nh","Ph√∫c Ai","Th·ª±c ƒê·∫≠u","Thi√™n Kh√™","Hung H∆∞∆°ng","Chu Vinh","ƒê·∫°i Bao"];
        const htNames = ["C·ª±c Tuy·ªÅn","Thanh Linh","Thi·∫øu H·∫£i","Linh ƒê·∫°o","Th√¥ng L√Ω","√Çm Kh√≠ch","Th·∫ßn M√¥n","Thi·∫øu Ph·ªß","Thi·∫øu Xung"];
        const siNames = ["Thi·∫øu Tr·∫°ch","Ti·ªÅn C·ªëc","H·∫≠u Kh√™","Uy·ªÉn C·ªët","D∆∞∆°ng C·ªëc","D∆∞·ª°ng L√£o","Chi Ch√≠nh","Ti·ªÉu H·∫£i","Ki√™n Trinh","Nhu Du","Thi√™n T√¥ng","B·ªânh Phong","Kh√∫c Vi√™n","Ki√™n Ngo·∫°i Du","Ki√™n Trung Du","Thi√™n Song","Thi√™n Dung","Quy·ªÅn Li√™u","Th√≠nh Cung"];
        const blNames = ["T√¨nh Minh","To·∫£n Tr√∫c","Mi Xung","Kh√∫c Sai","Ng≈© X·ª©","Th·ª´a Quang","Th√¥ng Thi√™n","L·∫°c Kh∆∞·ªõc","Ng·ªçc Ch·∫©m","Thi√™n Tr·ª•","ƒê·∫°i Tr·ªØ","Phong M√¥n","Ph·∫ø Du","Quy·∫øt √Çm Du","T√¢m Du","ƒê·ªëc Du","C√°ch Du","Can Du","ƒê·ªüm Du","T·ª≥ Du","V·ªã Du","Tam Ti√™u Du","Th·∫≠n Du","Kh√≠ H·∫£i Du","ƒê·∫°i Tr∆∞·ªùng Du","Quan Nguy√™n Du","Ti·ªÉu Tr∆∞·ªùng Du","B√†ng Quang Du","Trung L·ªØ Du","B·∫°ch Ho√†n Du","Th∆∞·ª£ng Li√™u","Th·ª© Li√™u","Trung Li√™u","H·∫° Li√™u","H·ªôi D∆∞∆°ng","Th·ª´a Ph√π","√Çn M√¥n","Ph√π Kh√≠ch","·ª¶y D∆∞∆°ng","·ª¶y Trung","Ph·ª• Ph√¢n","Ph√°ch H·ªô","Cao Hoang","Th·∫ßn ƒê∆∞·ªùng","Y Hy","C√°ch Quan","H·ªìn M√¥n","D∆∞∆°ng C∆∞∆°ng","√ù X√°","V·ªã Th∆∞∆°ng","Hoang M√¥n","Ch√≠ Th·∫•t","B√†o Hoang","Tr·∫≠t Bi√™n","H·ª£p D∆∞∆°ng","Th·ª´a C√¢n","Th·ª´a S∆°n","Phi D∆∞∆°ng","Ph·ª• D∆∞∆°ng","C√¥n L√¥n","B·ªôc Tham","Th√¢n M·∫°ch","Kim M√¥n","Kinh C·ªët","Th√∫c C·ªët","Th√¥ng C·ªëc","Ch√≠ √Çm"];
        const kiNames = ["D≈©ng Tuy·ªÅn","Nhi√™n C·ªëc","Th√°i Kh√™","ƒê·∫°i Chung","Th·ªßy Tuy·ªÅn","Chi·∫øu H·∫£i","Ph·ª•c L∆∞u","Giao T√≠n","Tr√∫c T√¢n","√Çm C·ªëc","Ho√†nh C·ªët","ƒê·∫°i H√°ch","Kh√≠ Huy·ªát","T·ª© M√£n","Trung Ch√∫","Hoang Du","Th∆∞∆°ng Kh√∫c","Th·∫°ch Quan","√Çm ƒê√¥","Ph√∫c Th√¥ng C·ªëc","U M√¥n","B·ªô Lang","Th·∫ßn Phong","Linh Kh∆∞","Th·∫ßn T√†ng","V·ª±c Trung","Du Ph·ªß"];
        const pcNames = ["Thi√™n Tr√¨","Thi√™n Tuy·ªÅn","Kh√∫c Tr·∫°ch","Kh√≠ch M√¥n","Gi·∫£n S·ª≠","N·ªôi Quan","ƒê·∫°i LƒÉng","Lao Cung","Trung Xung"];
        const teNames = ["Quan Xung","D·ªãch M√¥n","Trung Ch·ª≠","D∆∞∆°ng Tr√¨","Ngo·∫°i Quan","Chi C·∫•u","H·ªôi T√¥ng","Tam D∆∞∆°ng L·∫°c","T·ª© ƒê·ªôc","Thi√™n T·ªânh","Thanh L√£nh Uy√™n","Ti√™u L·∫°c","Nhu H·ªôi","Ki√™n Li√™u","Thi√™n Li√™u","Thi√™n D≈©","·∫æ Phong","Kh·∫ø M·∫°ch","L√¥ T·ª©c","Gi√°c T√¥n","Nhƒ© M√¥n","H√≤a Li√™u","Ty Tr√∫c Kh√¥ng"];
        const gbNames = ["ƒê·ªìng T·ª≠ Li√™u","Th√≠nh H·ªôi","Th∆∞·ª£ng Quan","H√†m Y·∫øn","Huy·ªÅn L∆∞","Huy·ªÅn Ly","Kh√∫c M·∫•n","Su·∫•t C·ªëc","Thi√™n Xung","Ph√π B·∫°ch","ƒê·∫ßu Khi·∫øu √Çm","Ho√†n C·ªët","B·∫£n Th·∫ßn","D∆∞∆°ng B·∫°ch","ƒê·∫ßu L√¢m Kh·∫•p","M·ª•c Song","Ch√≠nh Dinh","Th·ª´a Linh","N√£o Kh√¥ng","Phong Tr√¨","Ki√™n T·ªânh","Uy√™n D·ªãch","Tri·∫øp C√¢n","Nh·∫≠t Nguy·ªát","Kinh M√¥n","ƒê·ªõi M·∫°ch","Ng≈© Khu","Duy ƒê·∫°o","C·ª± Li√™u","Ho√†n Khi√™u","Phong Th·ªã","Trung ƒê·ªôc","T√∫c D∆∞∆°ng Quan","D∆∞∆°ng LƒÉng Tuy·ªÅn","D∆∞∆°ng Giao","Ngo·∫°i Kh√¢u","Quang Minh","D∆∞∆°ng Ph·ª•","Huy·ªÅn Chung","Kh√¢u Kh∆∞","T√∫c L√¢m Kh·∫•p","ƒê·ªãa Ng≈© H·ªôi","Hi·ªáp Kh√™","T√∫c Khi·∫øu √Çm"];
        const lrNames = ["ƒê·∫°i ƒê√¥n","H√†nh Gian","Th√°i Xung","Trung Phong","L√£i C√¢u","Trung ƒê√¥","T·∫•t Quan","Kh√∫c Tuy·ªÅn","√Çm Bao","T√∫c Ng≈© L√Ω","√Çm Li√™m","C·∫•p M·∫°ch","Ch∆∞∆°ng M√¥n","K·ª≥ M√¥n"];
        const gvNames = ["Tr∆∞·ªùng C∆∞·ªùng","Y√™u Du","Y√™u D∆∞∆°ng Quan","M·ªánh M√¥n","Huy·ªÅn Khu","T√≠ch Trung","Trung Khu","C√¢n S√∫c","Ch√≠ D∆∞∆°ng","Linh ƒê√†i","Th·∫ßn ƒê·∫°o","Th√¢n Tr·ª•","ƒê√†o ƒê·∫°o","ƒê·∫°i Ch√πy","√Å M√¥n","Phong Ph·ªß","N√£o H·ªô","C∆∞·ªùng Gian","H·∫≠u ƒê·ªânh","B√°ch H·ªôi","Ti·ªÅn ƒê·ªânh","T√≠n H·ªôi","Th∆∞·ª£ng Tinh","Th·∫ßn ƒê√¨nh","T·ªë Li√™u","Nh√¢n Trung","ƒêo√†i ƒêoan","Ng√¢n Giao"];
        const cvNames = ["H·ªôi √Çm","Kh√∫c C·ªët","Trung C·ª±c","Quan Nguy√™n","Th·∫°ch M√¥n","Kh√≠ H·∫£i","√Çm Giao","Th·∫ßn Khuy·∫øt","Th·ªßy Ph√¢n","H·∫° Qu·∫£n","Ki·∫øn L√Ω","Trung Qu·∫£n","Th∆∞·ª£ng Qu·∫£n","C·ª± Khuy·∫øt","C∆∞u Vƒ©","Trung ƒê√¨nh","ƒê·∫£n Trung","Ng·ªçc ƒê∆∞·ªùng","T·ª≠ Cung","Hoa C√°i","To√†n C∆°","Thi√™n ƒê·ªôt","Li√™m Tuy·ªÅn","Th·ª´a T∆∞∆°ng"];

        const defaultAcupoints = [
            ...createPoints("LU", "Ph·∫ø Kinh", luNames),
            ...createPoints("LI", "ƒê·∫°i Tr∆∞·ªùng Kinh", liNames),
            ...createPoints("ST", "V·ªã Kinh", stNames),
            ...createPoints("SP", "T·ª≥ Kinh", spNames),
            ...createPoints("HT", "T√¢m Kinh", htNames),
            ...createPoints("SI", "Ti·ªÉu Tr∆∞·ªùng Kinh", siNames),
            ...createPoints("BL", "B√†ng Quang Kinh", blNames),
            ...createPoints("KI", "Th·∫≠n Kinh", kiNames),
            ...createPoints("PC", "T√¢m B√†o Kinh", pcNames),
            ...createPoints("TE", "Tam Ti√™u Kinh", teNames),
            ...createPoints("GB", "ƒê·ªüm Kinh", gbNames),
            ...createPoints("LR", "Can Kinh", lrNames),
            ...createPoints("GV", "M·∫°ch ƒê·ªëc", gvNames),
            ...createPoints("CV", "M·∫°ch Nh√¢m", cvNames)
        ];

        // ELEMENTS
        const els = {
            loading: document.getElementById('loading'),
            loginScreen: document.getElementById('login-screen'),
            loginTitle: document.getElementById('loginTitle'),
            loginMsg: document.getElementById('loginMsg'),
            btnLogin: document.getElementById('btnLogin'),
            btnLoginHeader: document.getElementById('btnLoginHeader'),
            btnLogout: document.getElementById('btnLogout'),
            userAvatar: document.getElementById('userAvatar'),
            // Header Info
            headerUserInfo: document.getElementById('headerUserInfo'),
            displayUserName: document.getElementById('displayUserName'),
            displayUserTitle: document.getElementById('displayUserTitle'),
            
            navItems: document.querySelectorAll('.nav-item'),
            views: document.querySelectorAll('.view'),
            // Manage
            inpGroup: document.getElementById('inpGroup'),
            inpName: document.getElementById('inpName'),
            inpDesc: document.getElementById('inpDesc'),
            inpTreats: document.getElementById('inpTreats'), // New Input
            btnAddData: document.getElementById('btnAddData'),
            libraryContent: document.getElementById('libraryContent'),
            libSearch: document.getElementById('libSearch'),
            libFilter: document.getElementById('libFilter'),
            groupSuggestions: document.getElementById('groupSuggestions'),
            // Modal
            detailModal: document.getElementById('detailModal'),
            modalCode: document.getElementById('modalCode'),
            modalName: document.getElementById('modalName'),
            modalGroup: document.getElementById('modalGroup'),
            modalDesc: document.getElementById('modalDesc'),
            modalTreatsContainer: document.getElementById('modalTreatsContainer'), // New Container
            modalSearchBtn: document.getElementById('modalSearchBtn'),
            // Modal Edit Elements
            btnEditModal: document.getElementById('btnEditModal'),
            modalViewContent: document.getElementById('modalViewContent'),
            modalEditContent: document.getElementById('modalEditContent'),
            editGroup: document.getElementById('editGroup'),
            editName: document.getElementById('editName'),
            editTreats: document.getElementById('editTreats'),
            editDesc: document.getElementById('editDesc'),
            btnSaveEdit: document.getElementById('btnSaveEdit'),

            // Quiz
            quizGroupSelect: document.getElementById('quizGroupSelect'),
            qGroup: document.getElementById('qGroup'),
            qQuestion: document.getElementById('qQuestion'),
            qDesc: document.getElementById('qDesc'),
            qInput: document.getElementById('qInput'),
            btnSearchImg: document.getElementById('btnSearchImg'),
            qFeedback: document.getElementById('qFeedback'),
            btnShowAns: document.getElementById('btnShowAns'),
            btnHint: document.getElementById('btnHint'),
            btnNext: document.getElementById('btnNext'),
            quizArea: document.getElementById('quizArea'),
            emptyQuizMsg: document.getElementById('emptyQuizMsg'),
            emptyMsgText: document.getElementById('emptyMsgText'),
            btnInitData: document.getElementById('btnInitData'),
            limitCounter: document.getElementById('limitCounter'),
            // Stats & Cal
            statStreak: document.getElementById('stat-streak'),
            statMastered: document.getElementById('stat-mastered'),
            leaderboardList: document.getElementById('leaderboardList'),
            calendarGrid: document.getElementById('calendarGrid'),
            viewWeek: document.getElementById('viewWeek'),
            viewMonth: document.getElementById('viewMonth'),
            // Badges
            badges: {
                novice: document.getElementById('badge-novice'),
                master5: document.getElementById('badge-master5'),
                streak3: document.getElementById('badge-streak3'),
                streak7: document.getElementById('badge-streak7'),
                streak14: document.getElementById('badge-streak14'),
                streak30: document.getElementById('badge-streak30'),
                master20: document.getElementById('badge-master20'),
                master50: document.getElementById('badge-master50')
            }
        };

        // --- UTILS ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(type) {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().catch(e => console.log("Audio resume needed interaction"));
            }
            try {
                const osc = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                osc.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                if (type === 'correct') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.4);
                } else {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                    osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.2);
                }
            } catch (e) { console.log("Audio error", e); }
        }

        function cleanText(str) {
            if (!str) return "";
            str = str.toLowerCase().normalize("NFC");
            str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g, "a");
            str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g, "e");
            str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g, "i");
            str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g, "o");
            str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g, "u");
            str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g, "y");
            str = str.replace(/ƒë/g, "d");
            str = str.replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9\s]/g, ""); 
            return str.trim();
        }

        // --- AUTH ---
        function showLoginScreen(isForced = false) {
            els.loginScreen.style.display = 'flex';
            if(isForced) {
                els.loginTitle.textContent = "Thu·ªëc h·∫øt h·∫°n, ƒë·∫°i hi·ªáp 'tho√°t v·ªã' kh·ªèi game";
                els.loginMsg.textContent = "ƒê·∫°i hi·ªáp ƒë√£ luy·ªán ƒë·ªß 10 chi√™u. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c con ƒë∆∞·ªùng y ƒë·∫°o.";
            } else {
                els.loginTitle.textContent = "Nh·∫≠p M√¥n";
                els.loginMsg.textContent = "ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u b√≠ k√≠p v√† tranh ƒëo·∫°t ng√¥i v·ªã Minh Ch·ªß";
            }
        }

        els.btnLogin.addEventListener('click', () => signInWithPopup(auth, provider).catch(err => showToast("L·ªói: " + err.message)));
        els.btnLoginHeader.addEventListener('click', () => showLoginScreen(false));
        els.btnLogout.addEventListener('click', () => { signOut(auth); location.reload(); });

        onAuthStateChanged(auth, async (user) => {
            els.loginScreen.style.display = 'none';
            if (user) {
                isGuest = false; currentUser = user;
                els.userAvatar.src = user.photoURL;
                els.btnLogout.style.display = 'inline-block'; els.btnLoginHeader.style.display = 'none';
                els.headerUserInfo.style.display = 'block';
                els.displayUserName.textContent = user.displayName;
                
                showLoading(true);
                try {
                    await Promise.all([loadData(), checkAttendance(), loadLeaderboard()]);
                } catch(e) { console.error("Load error:", e); }
                showLoading(false);
                showToast(`Ch√†o m·ª´ng ${user.displayName} B√°c sƒ© t∆∞∆°ng lai!`);
            } else {
                isGuest = true; currentUser = null; guestQuizCount = 0;
                els.btnLogout.style.display = 'none'; els.btnLoginHeader.style.display = 'inline-block';
                els.headerUserInfo.style.display = 'none'; 
                els.limitCounter.style.display = 'inline-block';
                els.limitCounter.textContent = `(0/${GUEST_LIMIT})`;
                
                const localData = localStorage.getItem('guest_acupoints');
                if (localData) { acupoints = JSON.parse(localData); } 
                else { acupoints = defaultAcupoints.map((item, index) => ({ id: 'guest_' + index, ...item, srsLevel: 0, nextReview: 0 })); }
                renderListGrouped(); updateGroupSelect(); prepareQuiz();
                
                startQuiz();
            }
            setupNavigation(); renderCalendar(); updateBadges();
        });

        function showLoading(show) { els.loading.style.display = show ? 'flex' : 'none'; }
        function showToast(message) {
            const x = document.getElementById("toast"); x.textContent = message;
            x.className = "show"; setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- DATA LOGIC ---
        async function loadData() {
            if(isGuest) return;
            try {
                const q = query(collection(db, "acupoints"), where("uid", "==", currentUser.uid));
                const snap = await getDocs(q);
                acupoints = [];
                snap.forEach((doc) => acupoints.push({ id: doc.id, ...doc.data() }));
                renderListGrouped(); updateGroupSelect(); prepareQuiz();
                
                startQuiz();
            } catch (e) { console.error(e); }
        }

        // --- LIBRARY RENDER ---
        function renderListGrouped() {
            els.libraryContent.innerHTML = '';
            const groups = {};
            let masteredCount = 0;
            const filterText = els.libSearch.value.trim().toLowerCase();
            const filterType = els.libFilter.value;

            acupoints.forEach(item => {
                const level = item.srsLevel || 0;
                if(level >= 4) masteredCount++;
                
                // Smart Search: Check name, code, AND TREATS
                const name = item.name ? item.name.toLowerCase() : "";
                const code = name.split(' ')[0] || "";
                const treats = item.treats ? item.treats.toLowerCase() : "";

                if(filterText && !name.includes(filterText) && !code.includes(filterText) && !treats.includes(filterText)) return;
                
                // Type filter
                if(filterType === 'learned' && level < 1) return;
                if(filterType === 'new' && level > 0) return;

                if(!groups[item.group]) groups[item.group] = [];
                groups[item.group].push(item);
            });

            els.statMastered.textContent = masteredCount;

            const groupKeys = Object.keys(groups).sort();
            
            if(groupKeys.length === 0) {
                els.libraryContent.innerHTML = '<div style="text-align:center; padding:30px; color:#9ca3af;">Kh√¥ng t√¨m th·∫•y b√≠ k√≠p n√†o.</div>';
                return;
            }

            // Accordion Rendering
            groupKeys.forEach(gName => {
                const groupItems = groups[gName];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'accordion-item';

                // Header
                const header = document.createElement('div');
                header.className = 'accordion-header';
                header.innerHTML = `<span>${gName} (${groupItems.length})</span> <span>‚ñº</span>`;
                header.onclick = () => {
                    const content = itemDiv.querySelector('.accordion-content');
                    const isActive = header.classList.contains('active');
                    if(isActive) {
                        header.classList.remove('active');
                        content.classList.remove('open');
                        header.lastElementChild.textContent = '‚ñº';
                    } else {
                        header.classList.add('active');
                        content.classList.add('open');
                        header.lastElementChild.textContent = '‚ñ≤';
                    }
                };

                // Content Grid
                const content = document.createElement('div');
                content.className = 'accordion-content';
                
                if(filterText) {
                    header.classList.add('active');
                    content.classList.add('open');
                    header.lastElementChild.textContent = '‚ñ≤';
                }

                groupItems.forEach(item => {
                    const level = item.srsLevel || 0;
                    const card = document.createElement('div');
                    card.className = 'lib-card';
                    card.onclick = (e) => {
                        if(e.target.classList.contains('lib-del')) return;
                        openDetail(item);
                    };

                    const parts = item.name.split(' ');
                    const code = parts[0];
                    const realName = parts.slice(1).join(' ');

                    let lvText = level >= 4 ? '‚≠ê ƒê√£ thu·ªôc' : (level > 0 ? `üî• T·∫ßng ${level}` : 'üå± Ch∆∞a h·ªçc');
                    
                    // Generate Treats Tags for Library view
                    let treatsHtml = '';
                    if(item.treats) {
                        const tags = item.treats.split(',').slice(0, 2); // Show max 2 tags
                        tags.forEach(t => {
                            treatsHtml += `<span class="tag-treat">${t.trim()}</span>`;
                        });
                        if(item.treats.split(',').length > 2) treatsHtml += `<span class="tag-treat">...</span>`;
                    }

                    card.innerHTML = `
                        <div class="lib-code">${code}</div>
                        <div class="lib-name">${realName}</div>
                        <div>${treatsHtml}</div>
                        <div class="lib-srs">${lvText}</div>
                        <button class="lib-del" onclick="deleteAcupoint('${item.id}')">&times;</button>
                    `;
                    content.appendChild(card);
                });

                itemDiv.appendChild(header);
                itemDiv.appendChild(content);
                els.libraryContent.appendChild(itemDiv);
            });
        }

        // --- FILTER EVENTS ---
        els.libSearch.addEventListener('input', renderListGrouped);
        els.libFilter.addEventListener('change', renderListGrouped);

        // --- DETAIL MODAL & EDIT FEATURE ---
        window.toggleEditMode = (isEdit) => {
            if(isEdit) {
                els.modalViewContent.style.display = 'none';
                els.modalEditContent.style.display = 'block';
                // Populate inputs
                if(currentEditingItem) {
                    els.editGroup.value = currentEditingItem.group || "";
                    els.editName.value = currentEditingItem.name || "";
                    els.editTreats.value = currentEditingItem.treats || "";
                    els.editDesc.value = currentEditingItem.desc || "";
                }
            } else {
                els.modalViewContent.style.display = 'block';
                els.modalEditContent.style.display = 'none';
            }
        }

        els.btnEditModal.addEventListener('click', () => {
            if(isGuest) return showToast("Kh√°ch kh√¥ng ƒë∆∞·ª£c s·ª≠a b√≠ k√≠p gia truy·ªÅn!");
            toggleEditMode(true);
        });

        els.btnSaveEdit.addEventListener('click', async () => {
            if(!currentEditingItem) return;
            const newGroup = els.editGroup.value.trim();
            const newName = els.editName.value.trim();
            const newTreats = els.editTreats.value.trim();
            const newDesc = els.editDesc.value.trim();

            if(!newGroup || !newName) return showToast("T√™n v√† Nh√≥m kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
            
            showLoading(true);
            try {
                // Update Firestore
                const itemRef = doc(db, "acupoints", currentEditingItem.id);
                await updateDoc(itemRef, {
                    group: newGroup,
                    name: newName,
                    treats: newTreats,
                    desc: newDesc
                });

                // Update Local Data
                currentEditingItem.group = newGroup;
                currentEditingItem.name = newName;
                currentEditingItem.treats = newTreats;
                currentEditingItem.desc = newDesc;

                // Refresh UI
                renderListGrouped();
                updateGroupSelect();
                
                // Refresh Modal View
                openDetail(currentEditingItem); 
                showToast("‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!");
            } catch(e) {
                console.error(e);
                showToast("L·ªói khi l∆∞u: " + e.message);
            }
            showLoading(false);
        });

        function openDetail(item) {
            currentEditingItem = item;
            // Reset to view mode
            toggleEditMode(false);

            els.modalCode.textContent = item.name.split(' ')[0];
            els.modalName.textContent = item.name;
            els.modalGroup.textContent = `Thu·ªôc: ${item.group}`;
            els.modalDesc.textContent = item.desc || "Ch∆∞a c√≥ m√¥ t·∫£.";
            
            // Render Treats Tags in Modal
            els.modalTreatsContainer.innerHTML = '';
            if(item.treats) {
                const tags = item.treats.split(',');
                tags.forEach(t => {
                    if(t.trim()) {
                        const span = document.createElement('span');
                        span.className = 'tag-treat';
                        span.style.fontSize = '0.85rem';
                        span.style.padding = '4px 8px';
                        span.textContent = t.trim();
                        els.modalTreatsContainer.appendChild(span);
                    }
                });
            } else {
                els.modalTreatsContainer.innerHTML = '<span style="font-size:0.8rem; color:#999;">Ch∆∞a c·∫≠p nh·∫≠t ch·ªß tr·ªã</span>';
            }

            els.detailModal.classList.add('show');
            
            els.modalSearchBtn.onclick = () => {
                 const query = encodeURIComponent(`huy·ªát ${item.name} v·ªã tr√≠`);
                 window.open(`https://www.google.com/search?tbm=isch&q=${query}`, '_blank');
            };
        }

        window.initDefaultData = async () => {
            if(isGuest) return showToast("D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t cho c√°c h·∫°.");
            if(acupoints.length > 0 && !confirm("D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c thay th·∫ø b·∫±ng 361 huy·ªát chu·∫©n. Ti·∫øp t·ª•c?")) return;
            showLoading(true);
            try {
                const batch = writeBatch(db);
                defaultAcupoints.forEach(item => {
                    const docRef = doc(collection(db, "acupoints"));
                    batch.set(docRef, {
                        uid: currentUser.uid, group: item.group, name: item.name, desc: item.desc, image: "",
                        treats: "", // Initialize empty treats
                        srsLevel: 0, nextReview: 0, createdAt: serverTimestamp()
                    });
                });
                await batch.commit(); await loadData();
                showToast("‚úÖ ƒê√£ n·∫°p 361 huy·ªát ƒë·∫°o!");
                document.querySelector('[data-target="tab-quiz"]').click();
            } catch(e) { showToast("L·ªói: " + e.message); }
            showLoading(false);
        }

        els.btnAddData.addEventListener('click', async () => {
            if(isGuest) return showToast("ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u b√≠ k√≠p c·ªßa ri√™ng b·∫°n.");
            const group = els.inpGroup.value.trim();
            const name = els.inpName.value.trim();
            const treats = els.inpTreats.value.trim(); // Capture Treats
            const desc = els.inpDesc.value.trim();

            if(!group || !name) return showToast("Thi·∫øu t√™n ho·∫∑c nh√≥m!");
            showLoading(true);
            try {
                const docRef = await addDoc(collection(db, "acupoints"), {
                    uid: currentUser.uid, group, name, treats, desc, image:"", srsLevel: 0, nextReview: 0, createdAt: serverTimestamp()
                });
                acupoints.push({ id: docRef.id, uid: currentUser.uid, group, name, treats, desc, image:"", srsLevel: 0, nextReview: 0 });
                els.inpName.value = ''; els.inpDesc.value = ''; els.inpTreats.value = '';
                renderListGrouped(); updateGroupSelect(); prepareQuiz(); showToast("ƒê√£ l∆∞u!");
            } catch (e) { showToast("L·ªói l∆∞u."); }
            showLoading(false);
        });

        window.deleteAcupoint = async (id) => {
            if(isGuest) return showToast("Kh√°ch kh√¥ng th·ªÉ x√≥a d·ªØ li·ªáu m·∫´u.");
            if(!confirm("X√≥a huy·ªát n√†y?")) return;
            showLoading(true);
            try {
                await deleteDoc(doc(db, "acupoints", id));
                acupoints = acupoints.filter(item => item.id !== id);
                renderListGrouped(); updateGroupSelect(); prepareQuiz(); showToast("ƒê√£ x√≥a.");
            } catch (e) { showToast("L·ªói x√≥a."); }
            showLoading(false);
        }

        // --- QUIZ LOGIC ---
        function prepareQuiz() {
            if(acupoints.length > 0) {
                els.quizArea.style.display = 'block'; els.emptyQuizMsg.style.display = 'none';
            } else {
                els.quizArea.style.display = 'none'; els.emptyQuizMsg.style.display = 'block';
                els.btnInitData.style.display = isGuest ? 'none' : 'inline-flex';
            }
        }

        function startQuiz() {
            isProcessing = false;
            if (!document.getElementById('tab-quiz').classList.contains('active')) return;

            if(isGuest && guestQuizCount >= GUEST_LIMIT) { showLoginScreen(true); return; }

            const filter = els.quizGroupSelect.value;
            const now = Date.now();
            let pool = acupoints.filter(i => {
                const matchGroup = (filter === 'all' || i.group === filter);
                const isDue = (i.nextReview || 0) <= now;
                return matchGroup && isDue;
            });
            
            if (pool.length === 0) {
                 els.quizArea.style.display = 'none'; els.emptyQuizMsg.style.display = 'block'; return;
            } else {
                els.quizArea.style.display = 'block'; els.emptyQuizMsg.style.display = 'none';
            }
            
            pool.sort((a, b) => (a.nextReview || 0) - (b.nextReview || 0));
            // Random safely
            const safeMax = Math.min(3, pool.length);
            const idx = safeMax > 0 ? Math.floor(Math.random() * safeMax) : 0;
            currentQuizItem = pool[idx];
            currentHintIndex = 0;

            els.qGroup.textContent = currentQuizItem.group;
            els.qQuestion.textContent = "Huy·ªát n√†y t√™n l√† g√¨?";
            els.qDesc.textContent = currentQuizItem.desc;
            els.qInput.value = '';
            els.qInput.focus();
            els.qFeedback.textContent = ''; els.qFeedback.className = 'feedback';
        }

        els.btnSearchImg.addEventListener('click', () => {
            if(!currentQuizItem) return;
            const query = encodeURIComponent(`huy·ªát ${currentQuizItem.name} v·ªã tr√≠`);
            window.open(`https://www.google.com/search?tbm=isch&q=${query}`, '_blank');
        });

        async function handleAnswer(isCorrect) {
            if(!currentQuizItem) return;
            const oldLevel = currentQuizItem.srsLevel || 0;
            let newLevel = oldLevel; let nextReview = 0;

            if (isCorrect) {
                newLevel = Math.min(oldLevel + 1, SRS_INTERVALS.length - 1);
                const days = SRS_INTERVALS[newLevel];
                nextReview = Date.now() + (days * 24 * 60 * 60 * 1000);
                playTone('correct');
                els.qFeedback.innerHTML = "üéâ Tuy·ªát v·ªùi! Ch√≠nh x√°c!";
                els.qFeedback.className = 'feedback correct';
                if(Math.random() > 0.7 && typeof confetti === 'function') {
                    confetti({ particleCount: 60, spread: 70, origin: { y: 0.6 } });
                }
            } else {
                newLevel = 0; nextReview = Date.now();
                playTone('wrong');
                els.qFeedback.innerHTML = `Sai r·ªìi: <b>${currentQuizItem.name}</b>`;
                els.qFeedback.className = 'feedback wrong';
            }

            if(isGuest) {
                guestQuizCount++;
                els.limitCounter.textContent = `(${guestQuizCount}/${GUEST_LIMIT})`;
                currentQuizItem.srsLevel = newLevel; currentQuizItem.nextReview = nextReview;
                localStorage.setItem('guest_acupoints', JSON.stringify(acupoints));
            } else {
                try {
                    const itemRef = doc(db, "acupoints", currentQuizItem.id);
                    await updateDoc(itemRef, { srsLevel: newLevel, nextReview: nextReview });
                    currentQuizItem.srsLevel = newLevel; currentQuizItem.nextReview = nextReview;
                } catch(e) { console.error(e); }
            }

            if(isCorrect) {
                tryAutoCheckIn(); setTimeout(() => { startQuiz(); }, 1000);
            }
        }

        els.qInput.addEventListener('input', () => {
            if(!currentQuizItem || isProcessing) return;
            const inputClean = cleanText(els.qInput.value);
            const targetClean = cleanText(currentQuizItem.name);
            const nameParts = currentQuizItem.name.split(' ');
            const realNameClean = cleanText(nameParts.slice(1).join(' '));
            
            if ((inputClean.length >= 2 && inputClean === targetClean) || 
                (inputClean.length >= 2 && inputClean === realNameClean)) {
                isProcessing = true;
                handleAnswer(true);
            }
        });

        els.qInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') {
                if (!isProcessing) els.btnShowAns.click();
            }
        });

        els.quizGroupSelect.addEventListener('change', startQuiz);
        els.btnNext.addEventListener('click', startQuiz);
        els.btnShowAns.addEventListener('click', () => {
            if(!currentQuizItem || isProcessing) return;
            isProcessing = true;
            handleAnswer(false);
            setTimeout(() => { isProcessing = false; els.qInput.value = currentQuizItem.name; }, 500);
        });
        
        els.btnHint.addEventListener('click', () => {
            if(!currentQuizItem) return;
            const name = currentQuizItem.name;
            if(currentHintIndex < name.length) {
                currentHintIndex++;
                els.qInput.value = name.substring(0, currentHintIndex);
                els.qInput.focus();
                els.qInput.dispatchEvent(new Event('input'));
            }
        });

        // --- STATS & BADGES ---
        async function checkAttendance() {
            if(isGuest) { els.statStreak.textContent = "0"; return; }
            try {
                const today = new Date().toISOString().split('T')[0];
                const q = query(collection(db, "attendance"), where("uid", "==", currentUser.uid));
                const snap = await getDocs(q);
                attendanceDates.clear(); snap.forEach(doc => attendanceDates.add(doc.data().date));
                const streakCount = attendanceDates.size;
                todayCheckedIn = attendanceDates.has(today);
                els.statStreak.textContent = streakCount;
                updateBadges(streakCount);

                els.displayUserTitle.textContent = currentTitle;

                await setDoc(doc(db, "profiles", currentUser.uid), {
                    displayName: currentUser.displayName, streak: streakCount, 
                    photoURL: currentUser.photoURL, lastActive: serverTimestamp(),
                    title: currentTitle
                }, { merge: true });
            } catch(e) { console.error("Attendance check fail", e); }
        }

        function updateBadges(streak = 0) {
            els.badges.novice.classList.add('unlocked');
            currentTitle = "Lang BƒÉm T·∫≠p S·ª±"; 

            const mastered = acupoints.filter(i => (i.srsLevel || 0) >= 4).length;

            if (mastered >= 5) { els.badges.master5.classList.add('unlocked'); }
            if (streak >= 3) { els.badges.streak3.classList.add('unlocked'); currentTitle = "H·ªèa Nh√£n Kim Tinh"; }
            if (streak >= 7) { els.badges.streak7.classList.add('unlocked'); currentTitle = "B·∫Øt M·∫°ch Online"; }
            if (streak >= 14) { els.badges.streak14.classList.add('unlocked'); currentTitle = "Th√°i Y Vi·ªán Tr∆∞·ªüng"; }
            if (streak >= 30) { els.badges.streak30.classList.add('unlocked'); currentTitle = "ƒê·ªôc C√¥ C·∫ßu B·∫°i"; }
            
            if (mastered >= 20) { els.badges.master20.classList.add('unlocked'); currentTitle = "Hoa ƒê√† T√°i Th·∫ø"; }
            if (mastered >= 50) { els.badges.master50.classList.add('unlocked'); currentTitle = "Th·∫ßn Y H·∫° Ph√†m"; }
        }

        async function tryAutoCheckIn() {
            if(isGuest || todayCheckedIn) return;
            try {
                const today = new Date().toISOString().split('T')[0];
                await addDoc(collection(db, "attendance"), { uid: currentUser.uid, date: today, timestamp: serverTimestamp() });
                todayCheckedIn = true; attendanceDates.add(today);
                if (typeof confetti === 'function') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                showToast("‚úÖ ƒêi·ªÉm danh th√†nh c√¥ng!");
                checkAttendance(); renderCalendar(); 
            } catch(e) { console.error(e); }
        }

        async function loadLeaderboard() {
            try {
                const q = query(collection(db, "profiles"), orderBy("streak", "desc"), limit(20));
                const snap = await getDocs(q);
                els.leaderboardList.innerHTML = '';
                let rank = 1;
                snap.forEach(doc => {
                    const data = doc.data();
                    const isMe = currentUser && doc.id === currentUser.uid;
                    const div = document.createElement('div');
                    let rankClass = '';
                    if (rank === 1) rankClass = 'lb-top1'; else if (rank === 2) rankClass = 'lb-top2'; else if (rank === 3) rankClass = 'lb-top3';
                    
                    div.className = `lb-item ${rankClass}`;
                    if(isMe) div.style.borderLeft = '4px solid var(--primary)';
                    
                    div.innerHTML = `
                        <div class="lb-rank">${rank}</div>
                        <img src="${data.photoURL}" class="avatar" style="width:36px; height:36px; margin-right:12px; border:none;">
                        <div class="lb-info">
                            <div class="lb-name">${data.displayName} ${isMe ? '(B·∫°n)' : ''}</div>
                            <div class="lb-detail">${data.title || 'Lang BƒÉm'}</div>
                        </div>
                        <div class="lb-score">${data.streak} ng√†y</div>`;
                    els.leaderboardList.appendChild(div);
                    rank++;
                });
            } catch(e) {
                els.leaderboardList.innerHTML = '<div style="text-align:center; padding:10px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem BXH</div>';
            }
        }

        els.viewWeek.addEventListener('click', () => { calViewMode = 'week'; renderCalendar(); });
        els.viewMonth.addEventListener('click', () => { calViewMode = 'month'; renderCalendar(); });

        function renderCalendar() {
            if(calViewMode === 'week') { els.viewWeek.className = 'btn btn-xs btn-primary'; els.viewMonth.className = 'btn btn-xs btn-secondary'; } 
            else { els.viewWeek.className = 'btn btn-xs btn-secondary'; els.viewMonth.className = 'btn btn-xs btn-primary'; }
            const today = new Date(); els.calendarGrid.innerHTML = '';
            let startDate, daysToRender;
            if (calViewMode === 'month') {
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                const dayOfWeek = startDate.getDay(); startDate.setDate(startDate.getDate() - dayOfWeek); daysToRender = 42; 
            } else {
                startDate = new Date(today); startDate.setDate(today.getDate() - today.getDay()); daysToRender = 7;
            }
            for (let i = 0; i < daysToRender; i++) {
                const currentDate = new Date(startDate); currentDate.setDate(startDate.getDate() + i);
                const year = currentDate.getFullYear(); const month = String(currentDate.getMonth() + 1).padStart(2, '0'); const day = String(currentDate.getDate()).padStart(2, '0');
                const dateString = `${year}-${month}-${day}`;
                const hasStudied = attendanceDates.has(dateString);
                const isCurrentMonth = currentDate.getMonth() === today.getMonth();
                const opacity = (calViewMode === 'month' && !isCurrentMonth) ? '0.3' : '1';
                const div = document.createElement('div');
                div.className = `cal-day ${hasStudied ? 'active' : ''}`;
                if (today.getDate() === currentDate.getDate() && today.getMonth() === currentDate.getMonth()) div.classList.add('today');
                div.style.opacity = opacity; div.textContent = currentDate.getDate();
                els.calendarGrid.appendChild(div);
            }
        }

        function setupNavigation() {
            els.navItems.forEach(tab => {
                tab.addEventListener('click', () => {
                    els.navItems.forEach(t => t.classList.remove('active'));
                    els.views.forEach(v => v.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.target).classList.add('active');
                    if(tab.dataset.target === 'tab-quiz') startQuiz();
                    if(tab.dataset.target === 'tab-dashboard') loadLeaderboard();
                });
            });
        }

        function updateGroupSelect() {
            const groups = [...new Set(acupoints.map(i => i.group))];
            els.groupSuggestions.innerHTML = groups.map(g => `<option value="${g}">`).join('');
            const currentVal = els.quizGroupSelect.value;
            els.quizGroupSelect.innerHTML = '<option value="all">T·∫•t c·∫£ chi√™u th·ª©c</option>';
            groups.forEach(g => {
                const opt = document.createElement('option'); opt.value = g; opt.textContent = g;
                els.quizGroupSelect.appendChild(opt);
            });
            if(groups.includes(currentVal)) els.quizGroupSelect.value = currentVal;
        }
    </script>
</body>
</html>
