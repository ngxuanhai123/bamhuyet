<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiHi Med 2.0 - SRS Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #00695c;
            --primary-light: #4db6ac;
            --accent: #ffb300; 
            --bg: #f0f4f8;
            --surface: #ffffff;
            --text: #263238;
            --success: #2e7d32;
            --error: #c62828;
            --radius: 20px;
            --shadow: 0 10px 30px rgba(0, 105, 92, 0.08);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- UI Components --- */
        .btn {
            padding: 14px 24px; border: none; border-radius: 16px; cursor: pointer;
            font-weight: 700; font-size: 0.95rem; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            position: relative; overflow: hidden;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(0, 105, 92, 0.3); }
        .btn-secondary { background: #cfd8dc; color: #455a64; }
        .btn-accent { background: var(--accent); color: #fff; box-shadow: 0 4px 15px rgba(255, 179, 0, 0.3); }
        .btn-success { background: #e8f5e9; color: var(--success); border: 2px solid #c8e6c9; }
        .btn-danger { background: #ffebee; color: var(--error); }
        .btn-google { background: white; color: #333; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; border: 1px solid #eee;}
        .btn-xs { padding: 6px 12px; font-size: 0.8rem; border-radius: 10px; }

        .card {
            background: var(--surface); border-radius: var(--radius); padding: 24px;
            margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.8);
            position: relative;
        }
        
        input, select, textarea {
            width: 100%; padding: 14px; border: 2px solid #eceff1; border-radius: 14px;
            font-size: 1rem; margin-bottom: 12px; font-family: inherit; transition: border-color 0.2s; background: #fafafa;
        }
        input:focus, textarea:focus { border-color: var(--primary); background: #fff; }

        /* --- Header & Layout --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 105, 92, 0.95); backdrop-filter: blur(10px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 30px;
            text-align: center; width: 90%; max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2); animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #app-screen { display: flex; flex: 1; flex-direction: column; max-width: 800px; margin: 0 auto; width: 100%; }

        header {
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            padding: 12px 20px; display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 50; border-bottom: 1px solid #eee;
        }
        .brand { font-weight: 900; color: var(--primary); font-size: 1.3rem; display: flex; align-items: center; gap: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }

        .container { padding: 20px; flex: 1; width: 100%; }

        /* --- Navigation --- */
        .nav-pills { 
            display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding: 5px; 
            background: #eceff1; border-radius: 20px;
        }
        .nav-item {
            flex: 1; text-align: center; padding: 10px; border-radius: 15px; color: #78909c;
            font-weight: 700; cursor: pointer; transition: all 0.3s; font-size: 0.9rem;
        }
        .nav-item.active { background: white; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        /* --- Views & Quiz --- */
        .view { display: none; animation: slideUp 0.4s ease; }
        .view.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .quiz-container { text-align: center; padding: 10px 0; }
        .quiz-badge { 
            display: inline-block; padding: 6px 16px; background: #e0f2f1; color: var(--primary); 
            border-radius: 30px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 1px; 
        }
        .quiz-question { font-size: 1.6rem; color: #263238; margin: 10px 0; font-weight: 800; line-height: 1.3; }
        .quiz-desc { color: #546e7a; font-style: italic; margin-bottom: 25px; line-height: 1.6; font-size: 1rem; background: #fafafa; padding: 15px; border-radius: 12px; }
        
        /* New: Image Area */
        .quiz-image-area {
            width: 100%; height: 200px; background: #eee; border-radius: 16px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;
            cursor: pointer;
        }
        .quiz-image-area img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .quiz-image-area:hover img { transform: scale(1.05); }
        .img-placeholder { color: #90a4ae; font-size: 0.9rem; display: flex; flex-direction: column; align-items: center; gap: 5px; }

        .feedback { min-height: 30px; margin-top: 15px; font-weight: 800; font-size: 1.1rem; opacity: 0; transition: 0.3s; }
        .feedback.show { opacity: 1; transform: scale(1.1); }
        .feedback.correct { color: var(--success); }
        .feedback.wrong { color: var(--error); }

        /* --- Gamification UI --- */
        .badges-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 15px;}
        .badge-item { 
            text-align: center; padding: 10px; background: #fff; border-radius: 12px; 
            border: 1px solid #eee; opacity: 0.5; filter: grayscale(1); transition: 0.3s; 
        }
        .badge-item.unlocked { opacity: 1; filter: grayscale(0); border-color: var(--accent); background: #fffde7; transform: scale(1.05); box-shadow: 0 4px 10px rgba(255,179,0,0.2); }
        .badge-icon { font-size: 2rem; margin-bottom: 5px; display: block; }
        .badge-name { font-size: 0.7rem; font-weight: 700; color: #555; }

        /* --- Calendar & Leaderboard --- */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .cal-day { 
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center; 
            border-radius: 10px; background: #fff; border: 1px solid #eceff1; font-weight: 600; font-size: 0.9rem;
        }
        .cal-day.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .lb-item { 
            display: flex; align-items: center; padding: 15px; background: white; 
            border-radius: 16px; margin-bottom: 10px; border: 1px solid #eceff1; 
        }
        .lb-top1 { border: 2px solid #ffd700; background: linear-gradient(to right, #fff, #fffde7); }

        /* --- Utilities --- */
        #toast { visibility: hidden; min-width: 250px; background-color: #263238; color: #fff; text-align: center; border-radius: 50px; padding: 16px 24px; position: fixed; z-index: 2000; left: 50%; bottom: 40px; transform: translateX(-50%) translateY(20px); opacity: 0; transition: 0.4s; font-weight: 600; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
        
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 200; display: none; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eceff1; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <audio id="sndCorrect" src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAjAAAXoQA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0AAADQTGF2YzU4LjU0AAAAAAAAAAAAAAAAJAMAAAAAAAAXoQBxjW4tAAAAAP/7kmRAAABAAABAAAAAAABAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAATAxLjUAqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uSZEAAAAAAA0gAAAAAAADSAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"></audio>
    <div id="loading"><div class="spinner"></div></div>
    <div id="toast">Th√¥ng b√°o</div>

    <div id="login-screen">
        <div class="login-box">
            <div style="font-size: 3.5rem; margin-bottom: 15px;">üéì</div>
            <h1 style="color: var(--primary); margin: 0; font-size: 1.6rem; letter-spacing: -0.5px;" id="loginTitle">B√°c Sƒ© T·∫≠p S·ª±</h1>
            <p style="color: #546e7a; margin-bottom: 30px; line-height: 1.5;" id="loginMsg">ƒêƒÉng nh·∫≠p ƒë·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu √¥n t·∫≠p th√¥ng minh (SRS).</p>
            <button class="btn btn-google" id="btnLogin">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" style="margin-right:10px">
                ƒêƒÉng nh·∫≠p v·ªõi Google
            </button>
        </div>
    </div>

    <div id="app-screen">
        <header>
            <div class="brand">
                <span style="font-size: 1.8rem; animation: heartBeat 2s infinite;">‚ù§Ô∏è</span>
                <div style="display:flex; flex-direction:column; line-height:1;">
                    <span>HiHi Med</span>
                    <span style="font-size: 0.65rem; color:#78909c; font-weight:500;">SRS EDITION</span>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <span id="streakBadge" style="display:none; font-size:0.8rem; font-weight:bold; color:var(--accent); background: #fff8e1; padding: 4px 8px; border-radius:10px;">üî• 0</span>
                <img id="userAvatar" class="avatar" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NmZDhkYyI+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00czLTEuNzktNC00LTRzLTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==">
                <button class="btn btn-xs btn-secondary" id="btnLogout" style="display:none;">Tho√°t</button>
                <button class="btn btn-xs btn-primary" id="btnLoginHeader">V√†o</button>
            </div>
        </header>

        <div class="container">
            <div class="nav-pills">
                <div class="nav-item active" data-target="tab-quiz">üß† √în T·∫≠p</div>
                <div class="nav-item" data-target="tab-dashboard">üèÜ Th√†nh T√≠ch</div>
                <div class="nav-item" data-target="tab-manage">‚öôÔ∏è Qu·∫£n L√Ω</div>
            </div>

            <div id="tab-quiz" class="view active">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin:0; font-size: 1.1rem; color: var(--primary);">üî• C√¢u h·ªèi h√¥m nay</h3>
                        <div id="dueCounter" style="font-size: 0.85rem; font-weight: 700; color: var(--error); background: #ffebee; padding: 4px 10px; border-radius: 10px;">
                            0 c·∫ßn √¥n
                        </div>
                    </div>

                    <div id="quizArea" class="quiz-container">
                        <div class="quiz-badge" id="qGroup">...</div>
                        
                        <div class="quiz-image-area" id="qImageArea">
                            <div class="img-placeholder">
                                <span style="font-size: 2rem;">üñºÔ∏è</span>
                                <span>H√¨nh ·∫£nh huy·ªát ƒë·∫°o</span>
                            </div>
                            <img id="qImgDisplay" style="display:none;" src="" alt="Huy·ªát">
                        </div>
                        
                        <div class="quiz-question" id="qQuestion">Huy·ªát n√†y t√™n l√† g√¨?</div>
                        <p class="quiz-desc" id="qDesc">...</p>
                        
                        <input type="text" id="qInput" placeholder="Nh·∫≠p t√™n huy·ªát (kh√¥ng d·∫•u ok)..." autocomplete="off">
                        
                        <div class="feedback" id="qFeedback"></div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" id="btnHint" style="font-size:0.9rem;">üí° G·ª£i √Ω (Reset Level)</button>
                            <button class="btn btn-accent" id="btnSearchImg" style="font-size:0.9rem;">üîç Soi h√¨nh ·∫£nh</button>
                        </div>
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 10px; background: transparent; color: #90a4ae; border: 1px dashed #cfd8dc;" id="btnSkip">B·ªè qua c√¢u n√†y</button>
                    </div>
                    
                    <div id="emptyQuizMsg" style="display:none; text-align: center; padding: 40px 10px;">
                        <div style="font-size: 4rem; margin-bottom:10px;">üéâ</div>
                        <h3 style="margin:0; color:var(--primary);">H·∫øt b√†i h√¥m nay!</h3>
                        <p style="color:#78909c;">B·∫°n ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc nhi·ªám v·ª•.</p>
                        <button class="btn btn-primary" onclick="initDefaultData()">‚ôªÔ∏è N·∫°p th√™m d·ªØ li·ªáu m·∫´u</button>
                    </div>
                </div>
            </div>

            <div id="tab-dashboard" class="view">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="card" style="margin:0; text-align:center; background: linear-gradient(135deg, var(--primary), #004d40); color: white; border:none;">
                        <div style="font-size: 2.5rem; font-weight: 800;" id="stat-streak">0</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; font-weight:600;">Chu·ªói ng√†y h·ªçc</div>
                    </div>
                    <div class="card" style="margin:0; text-align:center;">
                        <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary);" id="stat-mastered">0</div>
                        <div style="font-size: 0.85rem; color: #78909c;">Huy·ªát ƒë√£ thu·ªôc (Lvl > 3)</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-top:0; font-size: 1.1rem;">üèÖ B·ªô S∆∞u T·∫≠p Huy Ch∆∞∆°ng</h3>
                    <div class="badges-grid" id="badgeList">
                        </div>
                </div>

                <div class="card">
                    <h3 style="margin-top:0; margin-bottom:15px; font-size: 1.1rem;">üìÖ ƒêi·ªÉm Danh</h3>
                    <div id="calendarGrid" class="cal-grid"></div>
                </div>

                <h3 style="margin: 15px 0; font-size: 1.1rem; color: #37474f;">üèÜ B·∫£ng X·∫øp H·∫°ng</h3>
                <div id="leaderboardList"></div>
            </div>

            <div id="tab-manage" class="view">
                <div class="card">
                    <h3 style="margin-top:0; font-size: 1.1rem;">Th√™m Ki·∫øn Th·ª©c M·ªõi</h3>
                    <input type="text" id="inpGroup" placeholder="Nh√≥m (VD: ƒêau ƒë·∫ßu)" list="groupSuggestions">
                    <datalist id="groupSuggestions"></datalist>
                    <input type="text" id="inpName" placeholder="T√™n Huy·ªát">
                    <textarea id="inpDesc" rows="3" placeholder="M√¥ t·∫£ v·ªã tr√≠..."></textarea>
                    <button class="btn btn-primary" id="btnAddData" style="width: 100%">üíæ L∆∞u v√†o kho</button>
                    
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #cfd8dc;">
                        <button class="btn btn-secondary" style="width: 100%; font-size: 0.85rem;" onclick="initDefaultData()">
                            üìö Reset d·ªØ li·ªáu m·∫´u (30+ Huy·ªát)
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-top:0; font-size: 1.1rem;">Kho D·ªØ Li·ªáu</h3>
                    <div id="dataList" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <footer style="text-align: center; padding: 20px; color: #90a4ae; font-size: 0.8rem;">
            HiHi Med 2.0 &copy; 2025<br>X√¢y d·ª±ng b·ªüi Xu√¢n H·∫£i
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, serverTimestamp, writeBatch, orderBy, limit, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAsHD5pH6Blm4wtXKEJojFYMl24SNgiKY0",
            authDomain: "bamhuyet-6c9e6.firebaseapp.com",
            projectId: "bamhuyet-6c9e6",
            storageBucket: "bamhuyet-6c9e6.firebasestorage.app",
            messagingSenderId: "195174949274",
            appId: "1:195174949274:web:50cd99e0fad60ba8a81a23"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- STATE & DATA ---
        let currentUser = null;
        let isGuest = true;
        let acupoints = [];
        let currentQuizItem = null;
        let currentHintIndex = 0;
        let attendanceDates = new Set();
        let currentStreak = 0;
        
        // --- SOUNDS ---
        const audioCorrect = new Audio("data:audio/wav;base64,UklGRjIAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAAABmYWN0BAAAAAAAAABkYXRhAAAAAA=="); // Placeholder, will use visual feedback mostly if silent
        // Using a real base64 beep for "Correct" to make it fun
        const playDing = () => {
             // Create oscillator for a pleasant "Ding"
             const ctx = new (window.AudioContext || window.webkitAudioContext)();
             const osc = ctx.createOscillator();
             const gain = ctx.createGain();
             osc.type = 'sine';
             osc.frequency.setValueAtTime(523.25, ctx.currentTime); // C5
             osc.frequency.exponentialRampToValueAtTime(1046.5, ctx.currentTime + 0.1); // C6
             gain.gain.setValueAtTime(0.1, ctx.currentTime);
             gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
             osc.connect(gain); gain.connect(ctx.destination);
             osc.start(); osc.stop(0.5);
        }
        const playBuzz = () => {
             const ctx = new (window.AudioContext || window.webkitAudioContext)();
             const osc = ctx.createOscillator();
             const gain = ctx.createGain();
             osc.type = 'sawtooth';
             osc.frequency.setValueAtTime(150, ctx.currentTime); 
             gain.gain.setValueAtTime(0.1, ctx.currentTime);
             gain.gain.linearRampToValueAtTime(0.001, ctx.currentTime + 0.3);
             osc.connect(gain); gain.connect(ctx.destination);
             osc.start(); osc.stop(0.3);
        }

        // --- UTILS: VIETNAMESE FUZZY MATCH ---
        function removeVietnameseTones(str) {
            str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g,"a"); 
            str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g,"e"); 
            str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g,"i"); 
            str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g,"o"); 
            str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g,"u"); 
            str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g,"y"); 
            str = str.replace(/ƒë/g,"d");
            str = str.replace(/√Ä|√Å|·∫†|·∫¢|√É|√Ç|·∫¶|·∫§|·∫¨|·∫®|·∫™|ƒÇ|·∫∞|·∫Æ|·∫∂|·∫≤|·∫¥/g, "A");
            str = str.replace(/√à|√â|·∫∏|·∫∫|·∫º|√ä|·ªÄ|·∫æ|·ªÜ|·ªÇ|·ªÑ/g, "E");
            str = str.replace(/√å|√ç|·ªä|·ªà|ƒ®/g, "I");
            str = str.replace(/√í|√ì|·ªå|·ªé|√ï|√î|·ªí|·ªê|·ªò|·ªî|·ªñ|∆†|·ªú|·ªö|·ª¢|·ªû|·ª†/g, "O");
            str = str.replace(/√ô|√ö|·ª§|·ª¶|≈®|∆Ø|·ª™|·ª®|·ª∞|·ª¨|·ªÆ/g, "U");
            str = str.replace(/·ª≤|√ù|·ª¥|·ª∂|·ª∏/g, "Y");
            str = str.replace(/ƒê/g, "D");
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
        }

        // --- DATA DEFAULTS (SRS Fields Added) ---
        const defaultAcupoints = [
            { group: "ƒêau ƒë·∫ßu", name: "H·ª£p C·ªëc", desc: "N·∫±m ·ªü h·ªï kh·∫©u, gi·ªØa x∆∞∆°ng ƒë·ªët b√†n ng√≥n c√°i v√† ng√≥n tr·ªè.", level: 0, nextReview: 0 },
            { group: "ƒêau ƒë·∫ßu", name: "Th√°i D∆∞∆°ng", desc: "Ch·ªó l√µm ph√≠a sau ƒëu√¥i l√¥ng m√†y v√† ƒëu√¥i m·∫Øt kho·∫£ng 1 th·ªën.", level: 0, nextReview: 0 },
            { group: "ƒêau ƒë·∫ßu", name: "·∫§n ƒê∆∞·ªùng", desc: "ƒêi·ªÉm ch√≠nh gi·ªØa ƒë∆∞·ªùng n·ªëi hai ƒë·∫ßu l√¥ng m√†y.", level: 0, nextReview: 0 },
            { group: "M·∫•t ng·ªß", name: "N·ªôi Quan", desc: "M·∫∑t tr∆∞·ªõc c·ªï tay, t·ª´ l·∫±n ch·ªâ ƒëo l√™n 2 th·ªën, gi·ªØa hai g√¢n.", level: 0, nextReview: 0 },
            { group: "M·∫•t ng·ªß", name: "Th·∫ßn M√¥n", desc: "Tr√™n l·∫±n ch·ªâ c·ªï tay, ch·ªó l√µm ph√≠a x∆∞∆°ng tr·ª• (ph√≠a ng√≥n √∫t).", level: 0, nextReview: 0 },
            { group: "M·∫•t ng·ªß", name: "Tam √Çm Giao", desc: "M·∫∑t trong c·∫≥ng ch√¢n, t·ª´ ƒë·ªânh m·∫Øt c√° trong ƒëo l√™n 3 th·ªën.", level: 0, nextReview: 0 },
            { group: "Ti√™u h√≥a", name: "T√∫c Tam L√Ω", desc: "D∆∞·ªõi m·∫Øt g·ªëi ngo√†i 3 th·ªën, c√°ch m√†o ch√†y 1 kho√°t ng√≥n tay.", level: 0, nextReview: 0 },
            { group: "Ti√™u h√≥a", name: "Trung Qu·∫£n", desc: "N·∫±m tr√™n ƒë∆∞·ªùng gi·ªØa b·ª•ng, t·ª´ r·ªën ƒëo l√™n 4 th·ªën.", level: 0, nextReview: 0 },
            { group: "H√¥ h·∫•p", name: "Nghinh H∆∞∆°ng", desc: "ƒêi·ªÉm giao gi·ªØa r√£nh m≈©i m√° v√† ƒë∆∞·ªùng ngang qua ch√¢n c√°nh m≈©i.", level: 0, nextReview: 0 },
            { group: "Th∆∞ gi√£n", name: "B√°ch H·ªôi", desc: "ƒêi·ªÉm ch√≠nh gi·ªØa ƒë·ªânh ƒë·∫ßu, n∆°i giao nhau c·ªßa hai ƒë∆∞·ªùng n·ªëi ƒë·ªânh tai.", level: 0, nextReview: 0 }
        ];

        // --- DOM ELEMENTS ---
        const els = {
            loginScreen: document.getElementById('login-screen'),
            btnLogin: document.getElementById('btnLogin'),
            btnLogout: document.getElementById('btnLogout'),
            btnLoginHeader: document.getElementById('btnLoginHeader'),
            userAvatar: document.getElementById('userAvatar'),
            streakBadge: document.getElementById('streakBadge'),
            navItems: document.querySelectorAll('.nav-item'),
            views: document.querySelectorAll('.view'),
            // Quiz
            quizArea: document.getElementById('quizArea'),
            emptyQuizMsg: document.getElementById('emptyQuizMsg'),
            qGroup: document.getElementById('qGroup'),
            qQuestion: document.getElementById('qQuestion'),
            qDesc: document.getElementById('qDesc'),
            qInput: document.getElementById('qInput'),
            qFeedback: document.getElementById('qFeedback'),
            qImgDisplay: document.getElementById('qImgDisplay'),
            qImageArea: document.getElementById('qImageArea'),
            btnHint: document.getElementById('btnHint'),
            btnSearchImg: document.getElementById('btnSearchImg'),
            btnSkip: document.getElementById('btnSkip'),
            dueCounter: document.getElementById('dueCounter'),
            // Stats
            statStreak: document.getElementById('stat-streak'),
            statMastered: document.getElementById('stat-mastered'),
            badgeList: document.getElementById('badgeList'),
            calendarGrid: document.getElementById('calendarGrid'),
            leaderboardList: document.getElementById('leaderboardList'),
            // Manage
            inpGroup: document.getElementById('inpGroup'),
            inpName: document.getElementById('inpName'),
            inpDesc: document.getElementById('inpDesc'),
            btnAddData: document.getElementById('btnAddData'),
            dataList: document.getElementById('dataList'),
            groupSuggestions: document.getElementById('groupSuggestions'),
            loading: document.getElementById('loading')
        };

        // --- AUTH & INIT ---
        function showLoading(show) { els.loading.style.display = show ? 'flex' : 'none'; }
        function showToast(msg) { 
            const t = document.getElementById('toast'); 
            t.textContent = msg; t.classList.add('show'); 
            setTimeout(() => t.classList.remove('show'), 3000); 
        }

        els.btnLogin.addEventListener('click', () => signInWithPopup(auth, provider).catch(e => showToast(e.message)));
        els.btnLogout.addEventListener('click', () => { signOut(auth); location.reload(); });
        els.btnLoginHeader.addEventListener('click', () => els.loginScreen.style.display = 'flex');

        onAuthStateChanged(auth, async (user) => {
            els.loginScreen.style.display = 'none';
            if (user) {
                isGuest = false;
                currentUser = user;
                els.userAvatar.src = user.photoURL;
                els.btnLogout.style.display = 'inline-block';
                els.btnLoginHeader.style.display = 'none';
                showLoading(true);
                await Promise.all([loadData(), checkAttendance(), loadLeaderboard()]);
                showLoading(false);
                showToast(`Ch√†o m·ª´ng ${user.displayName}!`);
            } else {
                isGuest = true;
                els.btnLogout.style.display = 'none';
                els.btnLoginHeader.style.display = 'inline-block';
                // Load Guest Data
                const localData = localStorage.getItem('guestAcupoints');
                if(localData) acupoints = JSON.parse(localData);
                else acupoints = JSON.parse(JSON.stringify(defaultAcupoints)).map((x, i) => ({...x, id: 'g'+i}));
                
                prepareQuiz();
                renderManageList();
            }
            setupNavigation();
            checkBadges();
        });

        // --- DATA & SRS LOGIC ---
        async function loadData() {
            try {
                const q = query(collection(db, "acupoints"), where("uid", "==", currentUser.uid));
                const snap = await getDocs(q);
                acupoints = [];
                snap.forEach(doc => acupoints.push({ id: doc.id, ...doc.data() }));
                prepareQuiz();
                renderManageList();
            } catch (e) { console.error(e); }
        }

        function calculateNextReview(currentLevel) {
            // Simple SRS: 1 -> 1d, 2 -> 3d, 3 -> 7d, 4 -> 14d, 5 -> 30d
            const intervals = [0, 1, 3, 7, 14, 30, 60];
            const days = intervals[Math.min(currentLevel, intervals.length - 1)];
            const date = new Date();
            date.setDate(date.getDate() + days);
            return date.getTime();
        }

        async function updateItemSRS(item, isCorrect) {
            let newLevel = isCorrect ? (item.level || 0) + 1 : 0;
            let nextReview = calculateNextReview(newLevel);
            
            // Update Local
            item.level = newLevel;
            item.nextReview = nextReview;

            if (isGuest) {
                localStorage.setItem('guestAcupoints', JSON.stringify(acupoints));
            } else {
                try {
                    await updateDoc(doc(db, "acupoints", item.id), { level: newLevel, nextReview: nextReview });
                } catch(e) { console.log(e); }
            }
        }

        // --- QUIZ LOGIC ---
        function prepareQuiz() {
            const now = new Date().getTime();
            // Filter: items due today OR items never learned (level 0)
            const dueItems = acupoints.filter(i => !i.nextReview || i.nextReview <= now);
            
            els.dueCounter.textContent = `${dueItems.length} c·∫ßn √¥n`;
            if (dueItems.length > 0) {
                els.dueCounter.style.display = 'block';
                els.quizArea.style.display = 'block';
                els.emptyQuizMsg.style.display = 'none';
            } else {
                els.dueCounter.style.display = 'none';
                els.quizArea.style.display = 'none';
                els.emptyQuizMsg.style.display = 'block';
                return;
            }

            // Pick random due item
            currentQuizItem = dueItems[Math.floor(Math.random() * dueItems.length)];
            currentHintIndex = 0;

            els.qGroup.textContent = currentQuizItem.group;
            els.qDesc.textContent = currentQuizItem.desc;
            els.qInput.value = '';
            els.qFeedback.className = 'feedback';
            els.qFeedback.textContent = '';
            els.qInput.focus();

            // Image handling (Placeholder for now)
            els.qImgDisplay.style.display = 'none'; 
            document.querySelector('.img-placeholder').style.display = 'flex';
        }

        // --- INTERACTION ---
        els.qInput.addEventListener('input', async () => {
            if(!currentQuizItem) return;
            const userIn = removeVietnameseTones(els.qInput.value);
            const correctName = removeVietnameseTones(currentQuizItem.name);

            // Check if string contains the name (fuzzy containment) or equality
            if (userIn === correctName || (userIn.length > 4 && correctName.includes(userIn))) {
                // CORRECT
                els.qInput.blur();
                els.qFeedback.textContent = "üéâ Ch√≠nh x√°c!";
                els.qFeedback.className = 'feedback show correct';
                playDing();
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
                
                await updateItemSRS(currentQuizItem, true);
                await tryAutoCheckIn();
                setTimeout(prepareQuiz, 1200);
            }
        });

        els.btnHint.addEventListener('click', async () => {
            if(!currentQuizItem) return;
            // Penalty logic: Reset level to 0
            playBuzz();
            els.qFeedback.textContent = "ƒê√£ g·ª£i √Ω (S·∫Ω ph·∫£i h·ªçc l·∫°i ngay)";
            els.qFeedback.className = 'feedback show wrong';
            
            const name = currentQuizItem.name;
            currentHintIndex += 2; 
            if(currentHintIndex > name.length) currentHintIndex = name.length;
            els.qInput.value = name.substring(0, currentHintIndex);
            
            // Mark as failed in SRS immediately so it stays in queue
            await updateItemSRS(currentQuizItem, false);
        });

        els.btnSkip.addEventListener('click', prepareQuiz);

        els.btnSearchImg.addEventListener('click', () => {
            if(currentQuizItem) {
                window.open(`https://www.google.com/search?tbm=isch&q=huy·ªát+ƒë·∫°o+${currentQuizItem.name}`, '_blank');
            }
        });

        // --- BADGES & GAMIFICATION ---
        const badges = [
            { id: 'b1', name: 'T√¢n Binh', icon: 'üå±', cond: (streak, mast) => true }, // Always unlock
            { id: 'b2', name: 'ChƒÉm Ch·ªâ', icon: 'üî•', cond: (streak, mast) => streak >= 3 },
            { id: 'b3', name: 'B·ªÅn B·ªâ', icon: 'üèÉ', cond: (streak, mast) => streak >= 7 },
            { id: 'b4', name: 'Th·∫ßy Thu·ªëc', icon: 'üíä', cond: (streak, mast) => mast >= 5 },
            { id: 'b5', name: 'Th·∫ßn Y', icon: 'üëë', cond: (streak, mast) => mast >= 20 }
        ];

        function checkBadges() {
            const masteredCount = acupoints.filter(i => i.level >= 3).length; // Level 3+ means remembered well
            els.statMastered.textContent = masteredCount;
            
            els.badgeList.innerHTML = '';
            badges.forEach(b => {
                const unlocked = b.cond(currentStreak, masteredCount);
                const div = document.createElement('div');
                div.className = `badge-item ${unlocked ? 'unlocked' : ''}`;
                div.innerHTML = `<span class="badge-icon">${b.icon}</span><div class="badge-name">${b.name}</div>`;
                els.badgeList.appendChild(div);
            });
        }

        // --- MANAGE & INIT ---
        window.initDefaultData = async () => {
            if(isGuest) {
                acupoints = defaultAcupoints.map((x,i) => ({...x, id: 'g'+i}));
                localStorage.setItem('guestAcupoints', JSON.stringify(acupoints));
                showToast("ƒê√£ n·∫°p d·ªØ li·ªáu m·∫´u!");
                prepareQuiz(); renderManageList();
                return;
            }
            const batch = writeBatch(db);
            defaultAcupoints.forEach(item => {
                const docRef = doc(collection(db, "acupoints"));
                batch.set(docRef, { ...item, uid: currentUser.uid, createdAt: serverTimestamp() });
            });
            await batch.commit();
            await loadData();
            showToast("ƒê√£ n·∫°p d·ªØ li·ªáu v√†o Cloud!");
        };

        els.btnAddData.addEventListener('click', async () => {
            if(isGuest) return showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u d·ªØ li·ªáu ri√™ng.");
            const g = els.inpGroup.value.trim(); const n = els.inpName.value.trim();
            if(!g || !n) return showToast("Thi·∫øu th√¥ng tin!");
            
            await addDoc(collection(db, "acupoints"), {
                uid: currentUser.uid, group: g, name: n, desc: els.inpDesc.value, 
                level: 0, nextReview: 0, createdAt: serverTimestamp()
            });
            els.inpName.value = ''; els.inpDesc.value = '';
            loadData(); showToast("ƒê√£ th√™m!");
        });

        function renderManageList() {
            els.dataList.innerHTML = '';
            acupoints.forEach(item => {
                const div = document.createElement('div');
                div.style.padding = "10px"; div.style.borderBottom = "1px solid #eee";
                div.style.display = "flex"; div.style.justifyContent = "space-between";
                div.innerHTML = `
                    <div><b>${item.name}</b> <span style="font-size:0.8rem; color:#888">Lv.${item.level||0}</span></div>
                    <button style="color:red; background:none; border:none; cursor:pointer;" onclick="deleteItem('${item.id}')">√ó</button>
                `;
                els.dataList.appendChild(div);
            });
            updateGroupSuggestions();
        }

        window.deleteItem = async (id) => {
            if(!confirm("X√≥a?")) return;
            if(isGuest) {
                acupoints = acupoints.filter(i => i.id !== id);
                localStorage.setItem('guestAcupoints', JSON.stringify(acupoints));
                prepareQuiz(); renderManageList();
            } else {
                await deleteDoc(doc(db, "acupoints", id));
                loadData();
            }
        };

        function updateGroupSuggestions() {
             const groups = [...new Set(acupoints.map(i => i.group))];
             els.groupSuggestions.innerHTML = groups.map(g => `<option value="${g}">`).join('');
        }

        // --- ATTENDANCE & LEADERBOARD ---
        async function checkAttendance() {
            if(isGuest) return;
            const q = query(collection(db, "attendance"), where("uid", "==", currentUser.uid));
            const snap = await getDocs(q);
            attendanceDates = new Set(snap.docs.map(d => d.data().date));
            currentStreak = attendanceDates.size;
            
            els.statStreak.textContent = currentStreak;
            els.streakBadge.style.display = 'inline-block';
            els.streakBadge.innerHTML = `üî• ${currentStreak}`;
            
            renderCalendar();
            
            // Update Profile for Leaderboard
            await setDoc(doc(db, "profiles", currentUser.uid), {
                displayName: currentUser.displayName, photoURL: currentUser.photoURL,
                streak: currentStreak, lastActive: serverTimestamp()
            }, { merge: true });
        }

        async function tryAutoCheckIn() {
            if(isGuest) return;
            const today = new Date().toISOString().split('T')[0];
            if(!attendanceDates.has(today)) {
                await addDoc(collection(db, "attendance"), { uid: currentUser.uid, date: today });
                attendanceDates.add(today);
                checkAttendance();
                showToast("ƒê√£ ƒëi·ªÉm danh ng√†y m·ªõi! +1 üî•");
                confetti({ particleCount: 100, spread: 70 });
            }
        }

        function renderCalendar() {
            els.calendarGrid.innerHTML = '';
            const today = new Date();
            // Simple last 7 days view
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(today.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                const div = document.createElement('div');
                div.className = `cal-day ${attendanceDates.has(ds) ? 'active' : ''}`;
                div.textContent = d.getDate();
                els.calendarGrid.appendChild(div);
            }
        }

        async function loadLeaderboard() {
            if(isGuest) { els.leaderboardList.innerHTML = '<div style="text-align:center; padding:10px;">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem BXH</div>'; return; }
            const q = query(collection(db, "profiles"), orderBy("streak", "desc"), limit(10));
            const snap = await getDocs(q);
            els.leaderboardList.innerHTML = '';
            snap.forEach((d, idx) => {
                const data = d.data();
                const div = document.createElement('div');
                div.className = `lb-item ${idx===0 ? 'lb-top1' : ''}`;
                div.innerHTML = `
                    <div style="font-weight:800; width:30px; color:#90a4ae">#${idx+1}</div>
                    <img src="${data.photoURL}" style="width:30px; height:30px; border-radius:50%; margin-right:10px;">
                    <div style="flex:1; font-weight:600; font-size:0.9rem;">${data.displayName}</div>
                    <div style="font-weight:700; color:var(--primary);">${data.streak}üî•</div>
                `;
                els.leaderboardList.appendChild(div);
            });
        }

        function setupNavigation() {
            els.navItems.forEach(t => t.addEventListener('click', () => {
                els.navItems.forEach(n => n.classList.remove('active'));
                els.views.forEach(v => v.classList.remove('active'));
                t.classList.add('active');
                document.getElementById(t.dataset.target).classList.add('active');
                if(t.dataset.target === 'tab-quiz') prepareQuiz();
                if(t.dataset.target === 'tab-dashboard') checkBadges();
            }));
        }

    </script>
</body>
</html>
